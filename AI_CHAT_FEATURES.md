# AI 聊天功能完整實現

## 概述

本系統現在已經完整實現了每個AI模型的功能，包括模型選擇、配置管理和實際的聊天對話功能。

## 新增功能

### 1. AI 聊天 API 端點

#### POST `/api/chat`
- **功能**: 使用配置的AI模型生成回應
- **參數**: 
  - `message`: 用戶訊息
  - `conversationId`: 對話ID（可選，用於連續對話）
- **回應**: 
  - `success`: 是否成功
  - `reply`: AI回應內容
  - `conversationId`: 對話ID
  - `model`: 使用的模型
  - `assistantName`: 助理名稱

#### GET `/api/conversations`
- **功能**: 獲取所有對話歷史
- **回應**: 對話列表，包含統計資訊

#### GET `/api/conversations/:conversationId`
- **功能**: 獲取特定對話的詳細訊息
- **參數**: `conversationId` - 對話ID

#### DELETE `/api/conversations/:conversationId`
- **功能**: 刪除特定對話
- **參數**: `conversationId` - 對話ID

### 2. 支援的 AI 模型

目前支援以下 OpenAI 模型：

| 模型 | 描述 | 特點 | 適用場景 |
|------|------|------|----------|
| GPT-4o Mini | 快速且經濟實惠的對話體驗 | 快速回應、成本效益高 | 一般客服需求 |
| GPT-4o | 高級版本，提供更強大的理解和生成能力 | 高品質回應、複雜任務處理 | 高品質客服 |
| GPT-4 Turbo | 平衡效能和速度的優化版本 | 平衡效能、快速處理 | 平衡型應用 |
| GPT-3.5 Turbo | 經典版本，穩定可靠且成本較低 | 穩定可靠、成本較低 | 基礎客服 |
| GPT-3.5 Turbo 16K | 支援更長對話的擴展版本 | 長對話支援、大上下文 | 複雜對話 |

### 3. AI 助理配置

系統會根據以下配置來生成回應：

- **助理名稱**: 自定義的AI助理名稱
- **使用場景**: 定義AI助理的專業領域
- **描述**: 詳細的助理介紹
- **選擇的模型**: 決定使用的AI模型

### 4. 對話管理功能

- **連續對話**: 支援上下文記憶，最多保留最近10條訊息
- **對話歷史**: 自動保存所有對話記錄
- **對話統計**: 提供訊息數量等統計資訊
- **對話刪除**: 支援刪除不需要的對話

## 前端界面

### 1. 聊天頁面 (`/chat.html`)

提供完整的聊天界面，包括：

- **對話列表**: 左側顯示所有對話歷史
- **聊天區域**: 右側顯示當前對話
- **即時回應**: 支援打字指示器
- **模型資訊**: 顯示當前使用的模型
- **響應式設計**: 支援桌面和移動設備

### 2. 管理面板整合

在管理面板的側邊欄中添加了「AI聊天測試」連結，方便管理員測試AI功能。

## 技術實現

### 1. 後端實現

#### 系統提示詞構建
```javascript
const systemPrompt = `你是 ${aiConfig.name}，${aiConfig.description}。你的使用場景是：${aiConfig.useCase}。請根據用戶的問題提供專業、友善且有用的回應。`;
```

#### OpenAI API 調用
```javascript
const openaiResponse = await axios.post(
    'https://api.openai.com/v1/chat/completions',
    {
        model: aiConfig.model,
        messages: messages,
        max_tokens: 1000,
        temperature: 0.7
    },
    {
        headers: {
            'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
            'Content-Type': 'application/json'
        }
    }
);
```

### 2. 錯誤處理

系統包含完整的錯誤處理機制：

- **API 金鑰錯誤**: 401 錯誤處理
- **請求頻率限制**: 429 錯誤處理
- **網路連接錯誤**: ENOTFOUND/ECONNREFUSED 處理
- **一般錯誤**: 通用錯誤處理

### 3. 資料庫整合

- **對話歷史**: 自動保存到 `data/database.json`
- **配置同步**: 與AI助理配置系統完全整合
- **資料持久化**: 所有對話都會被保存

## 使用方法

### 1. 配置 AI 助理

1. 登入管理面板
2. 進入「AI助理資訊」頁面
3. 設定助理名稱、使用場景和描述
4. 選擇合適的AI模型
5. 保存配置

### 2. 測試聊天功能

1. 點擊側邊欄的「AI聊天測試」
2. 在新視窗中開始與AI助理對話
3. 測試不同類型的問題
4. 查看對話歷史

### 3. 管理對話

1. 在聊天頁面左側查看所有對話
2. 點擊對話項目查看詳細內容
3. 可以刪除不需要的對話

## 測試

使用提供的測試腳本：

```bash
node test-ai-chat.js
```

測試腳本會驗證：
- AI配置獲取
- 模型列表獲取
- 聊天功能
- 對話歷史
- 連續對話

## 安全考慮

- **JWT 認證**: 所有API端點都需要有效的JWT token
- **輸入驗證**: 檢查訊息內容的有效性
- **錯誤處理**: 避免敏感資訊洩露
- **速率限制**: 防止API濫用

## 部署注意事項

1. **環境變數**: 確保 `OPENAI_API_KEY` 已正確設定
2. **CORS 設定**: 如果需要跨域訪問，請配置適當的CORS設定
3. **SSL 憑證**: 生產環境建議使用HTTPS
4. **監控**: 建議監控API使用量和錯誤率

## 未來擴展

- **多語言支援**: 支援更多語言的回應
- **情感分析**: 整合情感分析功能
- **知識庫整合**: 與現有知識庫系統整合
- **多模型支援**: 支援更多AI模型提供商
- **對話分析**: 提供對話品質分析功能 