<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸³è™Ÿç®¡ç† - EchoChat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="navbar.css" rel="stylesheet">
    <script src="js/api-config.js"></script>
    <link href="navbar-mobile.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        
        .main-container {
            margin-top: 80px;
            padding: 20px;
        }
        
        .management-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-danger-custom {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .btn-danger-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            color: white;
        }
        
        .btn-warning-custom {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .btn-warning-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(254, 202, 87, 0.4);
            color: white;
        }
        
        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #eee;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9ff;
        }
        
        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .badge-user {
            background: linear-gradient(135deg, #48c78e 0%, #06d6a0 100%);
            color: white;
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            border: none;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #667eea;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-robot me-2"></i>EchoChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>å„€è¡¨æ¿
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="account-management.html">
                            <i class="fas fa-users me-1"></i>å¸³è™Ÿç®¡ç†
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><span id="navbarUsername">ç®¡ç†å“¡</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="account.html"><i class="fas fa-user-cog me-2"></i>å€‹äººè¨­å®š</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ç™»å‡º</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="container">
            <!-- é é¢æ¨™é¡Œ -->
            <div class="management-card">
                <div class="row align-items-center mb-4">
                    <div class="col-md-6">
                        <h1 class="mb-0">
                            <i class="fas fa-users me-3" style="color: #667eea;"></i>å¸³è™Ÿç®¡ç†
                        </h1>
                        <p class="text-muted mt-2">ç®¡ç†ç³»çµ±ä¸­çš„æ‰€æœ‰ç”¨æˆ¶å¸³è™Ÿ</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-custom" onclick="showCreateModal()">
                            <i class="fas fa-plus me-2"></i>æ–°å¢å¸³è™Ÿ
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="loadAccounts()">
                            <i class="fas fa-sync-alt me-2"></i>é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>

                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalAccounts">0</div>
                            <div class="stats-label">ç¸½å¸³è™Ÿæ•¸</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #48c78e 0%, #06d6a0 100%);">
                            <div class="stats-number" id="adminAccounts">0</div>
                            <div class="stats-label">ç®¡ç†å“¡</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);">
                            <div class="stats-number" id="userAccounts">0</div>
                            <div class="stats-label">ä¸€èˆ¬ç”¨æˆ¶</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);">
                            <div class="stats-number" id="recentAccounts">0</div>
                            <div class="stats-label">æœ¬æœˆæ–°å¢</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¸³è™Ÿåˆ—è¡¨ -->
            <div class="management-card">
                <div class="loading" id="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                    <p class="mt-3">è¼‰å…¥å¸³è™Ÿè³‡æ–™ä¸­...</p>
                </div>

                <div id="accountsTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ¶å</th>
                                    <th>å§“å</th>
                                    <th>è§’è‰²</th>
                                    <th>æ–¹æ¡ˆ</th>
                                    <th>åˆ°æœŸæ—¥</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>ä¸‹æ¬¡æ‰£æ¬¾</th>
                                    <th>é›»å­éƒµä»¶</th>
                                    <th>å‰µå»ºæ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody">
                                <!-- å‹•æ…‹è¼‰å…¥å¸³è™Ÿè³‡æ–™ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="noAccounts" style="display: none;" class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">ç›®å‰æ²’æœ‰å¸³è™Ÿè³‡æ–™</h5>
                    <p class="text-muted">é»æ“Šã€Œæ–°å¢å¸³è™Ÿã€ä¾†å‰µå»ºç¬¬ä¸€å€‹å¸³è™Ÿ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯å¸³è™Ÿæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="accountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æ–°å¢å¸³è™Ÿ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="accountForm">
                        <input type="hidden" id="accountId">
                        <div class="mb-3">
                            <label for="username" class="form-label">ç”¨æˆ¶å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" required>
                            <div class="form-text">ç”¨æˆ¶åå¿…é ˆå”¯ä¸€ï¼Œä¸èƒ½é‡è¤‡</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">å¯†ç¢¼ <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="password" required>
                            <div class="form-text">å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦</div>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">å§“å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">è§’è‰²</label>
                            <select class="form-control" id="role">
                                <option value="user">ä¸€èˆ¬ç”¨æˆ¶</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="plan" class="form-label">æ–¹æ¡ˆ</label>
                            <select class="form-control" id="plan">
                                <option value="free">å…è²»ç‰ˆ</option>
                                <option value="premium">å°Šæ¦®ç‰ˆ</option>
                                <option value="enterprise">ä¼æ¥­ç‰ˆ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="plan_expires_at" class="form-label">åˆ°æœŸæ—¥ï¼ˆä»˜è²»æ–¹æ¡ˆ/ä¼æ¥­ç‰ˆï¼‰</label>
                            <input type="date" class="form-control" id="plan_expires_at">
                        </div>
                        <div class="mb-3">
                            <label for="subscription_status" class="form-label">è¨‚é–±ç‹€æ…‹</label>
                            <select class="form-control" id="subscription_status">
                                <option value="none">ç„¡</option>
                                <option value="active">ç”Ÿæ•ˆä¸­</option>
                                <option value="canceled">å·²å–æ¶ˆ</option>
                                <option value="past_due">é€¾æœŸ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="next_billing_at" class="form-label">ä¸‹æ¬¡æ‰£æ¬¾æ—¥ï¼ˆè‹¥ç‚ºé€±æœŸä»˜è²»ï¼‰</label>
                            <input type="date" class="form-control" id="next_billing_at">
                        </div>
                        <div class="row g-3">
                          <div class="col-md-4">
                            <label for="enterprise_token_monthly" class="form-label">ä¼æ¥­ç‰ˆæ¯æœˆé¡åº¦</label>
                            <input type="number" class="form-control" id="enterprise_token_monthly" placeholder="åƒ…ä¼æ¥­ç‰ˆä½¿ç”¨">
                          </div>
                          <div class="col-md-4">
                            <label for="token_used_in_cycle" class="form-label">æœ¬æœˆå·²ç”¨</label>
                            <input type="number" class="form-control" id="token_used_in_cycle">
                          </div>
                          <div class="col-md-4">
                            <label for="token_bonus_balance" class="form-label">å„²å€¼é¤˜é¡</label>
                            <input type="number" class="form-control" id="token_bonus_balance">
                          </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">é›»å­éƒµä»¶</label>
                            <input type="email" class="form-control" id="email">
                            <div class="form-text">é¸å¡«ï¼Œå¦‚æœªå¡«å¯«å°‡è‡ªå‹•ç”Ÿæˆ</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-custom" onclick="saveAccount()">
                        <i class="fas fa-save me-2"></i>å„²å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>ç¢ºèªåˆªé™¤
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>æ‚¨ç¢ºå®šè¦åˆªé™¤å¸³è™Ÿ <strong id="deleteAccountName"></strong> å—ï¼Ÿ</p>
                    <p class="text-danger">
                        <i class="fas fa-warning me-2"></i>
                        æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè©²å¸³è™Ÿçš„æ‰€æœ‰è³‡æ–™å°‡è¢«æ°¸ä¹…åˆªé™¤ã€‚
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash me-2"></i>ç¢ºèªåˆªé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/ultimate-empty-auth.js"></script>
    
    <script>
        const ADMIN_ROLES = ['admin', 'super_admin'];
        const isAdminRoleFn = (role) => ADMIN_ROLES.includes((role || '').toLowerCase());

        let accounts = [];
        let deleteAccountId = null;
        let isEditMode = false;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­ç½®ç”¨æˆ¶å
            const staffName = localStorage.getItem('staffName') || 'ç®¡ç†å“¡';
            document.getElementById('navbarUsername').textContent = staffName;
            
            // è¼‰å…¥å¸³è™Ÿè³‡æ–™
            loadAccounts();
        });

        // è¼‰å…¥æ‰€æœ‰å¸³è™Ÿ
        async function loadAccounts() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('accountsTable').style.display = 'none';
                document.getElementById('noAccounts').style.display = 'none';

                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/accounts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    accounts = data.accounts;
                    displayAccounts();
                    updateStats();
                } else {
                    throw new Error(data.error || 'è¼‰å…¥å¸³è™Ÿå¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸³è™ŸéŒ¯èª¤:', error);
                
                // å¦‚æœæ˜¯èªè­‰éŒ¯èª¤ï¼Œæ¸…é™¤ token ä¸¦è·³è½‰åˆ°ç™»å…¥é é¢
                if (error.message.includes('èªè­‰ä»¤ç‰Œ') || error.message.includes('401')) {
                    console.log('ğŸ”„ Token ç„¡æ•ˆï¼Œé‡æ–°å°å‘åˆ°ç™»å…¥é é¢');
                    localStorage.clear();
                    alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    window.location.href = 'login.html';
                    return;
                }
                
                showAlert('è¼‰å…¥å¸³è™Ÿå¤±æ•—: ' + error.message, 'danger');
                document.getElementById('noAccounts').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // é¡¯ç¤ºå¸³è™Ÿåˆ—è¡¨
        function displayAccounts() {
            const tbody = document.getElementById('accountsTableBody');
            
            if (accounts.length === 0) {
                document.getElementById('noAccounts').style.display = 'block';
                return;
            }

            document.getElementById('accountsTable').style.display = 'block';
            
            tbody.innerHTML = accounts.map(account => `
                <tr>
                    <td>${account.id}</td>
                    <td><strong>${account.username}</strong></td>
                    <td>${account.name}</td>
                    <td>
                        <span class="badge ${isAdminRoleFn(account.role) ? 'badge-admin' : 'badge-user'}">
                            <i class="fas ${isAdminRoleFn(account.role) ? 'fa-crown' : 'fa-user'} me-1"></i>
                            ${isAdminRoleFn(account.role) ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ç”¨æˆ¶'}
                        </span>
                    </td>
                    <td>
                        <span class="badge" style="background: ${account.plan === 'enterprise' ? 'linear-gradient(135deg,#ff6b6b,#ee5a5a)' : account.plan === 'premium' ? 'linear-gradient(135deg,#48c78e,#06d6a0)' : 'linear-gradient(135deg,#6c757d,#495057)'}; color: white;">
                            ${account.plan === 'enterprise' ? 'ä¼æ¥­ç‰ˆ' : account.plan === 'premium' ? 'å°Šæ¦®ç‰ˆ' : 'å…è²»ç‰ˆ'}
                        </span>
                    </td>
                    <td>${account.plan_expires_at ? new Date(account.plan_expires_at).toLocaleDateString() : '-'}</td>
                    <td>${account.subscription_status || '-'}</td>
                    <td>${account.next_billing_at ? new Date(account.next_billing_at).toLocaleDateString() : '-'}</td>
                    <td>${account.email || '-'}</td>
                    <td>${formatDate(account.created_at)}</td>
                    <td>
                        <button class="btn btn-warning-custom btn-sm me-1" onclick="editAccount(${account.id})" title="ç·¨è¼¯">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger-custom btn-sm" onclick="showDeleteModal(${account.id}, '${account.username}')" title="åˆªé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const total = accounts.length;
            const adminCount = accounts.filter(a => isAdminRoleFn(a.role)).length;
            const userCount = accounts.filter(a => !isAdminRoleFn(a.role)).length;
            
            // è¨ˆç®—æœ¬æœˆæ–°å¢å¸³è™Ÿ
            const thisMonth = new Date();
            const recentCount = accounts.filter(account => {
                const createdDate = new Date(account.created_at);
                return createdDate.getMonth() === thisMonth.getMonth() && 
                       createdDate.getFullYear() === thisMonth.getFullYear();
            }).length;

            document.getElementById('totalAccounts').textContent = total;
            document.getElementById('adminAccounts').textContent = adminCount;
            document.getElementById('userAccounts').textContent = userCount;
            document.getElementById('recentAccounts').textContent = recentCount;
        }

        // é¡¯ç¤ºæ–°å¢å¸³è™Ÿæ¨¡æ…‹æ¡†
        function showCreateModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'æ–°å¢å¸³è™Ÿ';
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('password').required = true;
            
            const modal = new bootstrap.Modal(document.getElementById('accountModal'));
            modal.show();
        }

        // ç·¨è¼¯å¸³è™Ÿ
        function editAccount(accountId) {
            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯å¸³è™Ÿ';
            document.getElementById('accountId').value = account.id;
            document.getElementById('username').value = account.username;
            document.getElementById('password').value = '';
            document.getElementById('password').required = false;
            document.getElementById('name').value = account.name;
            document.getElementById('role').value = account.role;
            document.getElementById('plan').value = account.plan || 'free';
            document.getElementById('email').value = account.email || '';
            document.getElementById('plan_expires_at').value = account.plan_expires_at ? account.plan_expires_at.substring(0,10) : '';
            document.getElementById('subscription_status').value = account.subscription_status || 'none';
            document.getElementById('next_billing_at').value = account.next_billing_at ? account.next_billing_at.substring(0,10) : '';
            // åƒ…åœ¨è³‡æ–™å­˜åœ¨æ™‚æ‰å¡«å…¥ï¼Œé¿å…ã€Œäº‚è·³ã€
            if (account.enterprise_token_monthly !== undefined) document.getElementById('enterprise_token_monthly').value = account.enterprise_token_monthly;
            if (account.token_used_in_cycle !== undefined) document.getElementById('token_used_in_cycle').value = account.token_used_in_cycle;
            if (account.token_bonus_balance !== undefined) document.getElementById('token_bonus_balance').value = account.token_bonus_balance;

            const modal = new bootstrap.Modal(document.getElementById('accountModal'));
            modal.show();
        }

        // å„²å­˜å¸³è™Ÿ
        async function saveAccount() {
            try {
                const accountId = document.getElementById('accountId').value;
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const name = document.getElementById('name').value.trim();
                const role = document.getElementById('role').value;
                const plan = document.getElementById('plan').value;
                const email = document.getElementById('email').value.trim();
                const plan_expires_at = document.getElementById('plan_expires_at').value ? new Date(document.getElementById('plan_expires_at').value).toISOString() : undefined;
                const subscription_status = document.getElementById('subscription_status').value;
                const next_billing_at = document.getElementById('next_billing_at').value ? new Date(document.getElementById('next_billing_at').value).toISOString() : undefined;
                const enterprise_token_monthly = document.getElementById('enterprise_token_monthly').value ? parseInt(document.getElementById('enterprise_token_monthly').value, 10) : undefined;
                const token_used_in_cycle = document.getElementById('token_used_in_cycle').value ? parseInt(document.getElementById('token_used_in_cycle').value, 10) : undefined;
                const token_bonus_balance = document.getElementById('token_bonus_balance').value ? parseInt(document.getElementById('token_bonus_balance').value, 10) : undefined;

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!username || !name) {
                    showAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'warning');
                    return;
                }

                if (!isEditMode && !password) {
                    showAlert('æ–°å¢å¸³è™Ÿæ™‚å¯†ç¢¼ç‚ºå¿…å¡«', 'warning');
                    return;
                }

                if (password && password.length < 6) {
                    showAlert('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦', 'warning');
                    return;
                }

                const token = localStorage.getItem('token');
                const url = isEditMode 
                    ? `${API_BASE_URL}/accounts/${accountId}`
                    : `${API_BASE_URL}/accounts`;
                
                const method = isEditMode ? 'PUT' : 'POST';
                
                const requestBody = {
                    username,
                    name,
                    role,
                    plan,
                    email: email || undefined,
                    plan_expires_at,
                    subscription_status,
                    next_billing_at,
                    enterprise_token_monthly,
                    token_used_in_cycle,
                    token_bonus_balance
                };

                if (password) {
                    requestBody.password = password;
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // é—œé–‰æ¨¡æ…‹æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('accountModal'));
                    modal.hide();
                    
                    // é‡æ–°è¼‰å…¥å¸³è™Ÿåˆ—è¡¨
                    loadAccounts();
                } else {
                    throw new Error(data.error || 'å„²å­˜å¸³è™Ÿå¤±æ•—');
                }
            } catch (error) {
                console.error('å„²å­˜å¸³è™ŸéŒ¯èª¤:', error);
                showAlert('å„²å­˜å¸³è™Ÿå¤±æ•—: ' + error.message, 'danger');
            }
        }

        // é¡¯ç¤ºåˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡†
        function showDeleteModal(accountId, username) {
            deleteAccountId = accountId;
            document.getElementById('deleteAccountName').textContent = username;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // ç¢ºèªåˆªé™¤å¸³è™Ÿ
        async function confirmDelete() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/accounts/${deleteAccountId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // é—œé–‰æ¨¡æ…‹æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    modal.hide();
                    
                    // é‡æ–°è¼‰å…¥å¸³è™Ÿåˆ—è¡¨
                    loadAccounts();
                } else {
                    throw new Error(data.error || 'åˆªé™¤å¸³è™Ÿå¤±æ•—');
                }
            } catch (error) {
                console.error('åˆªé™¤å¸³è™ŸéŒ¯èª¤:', error);
                showAlert('åˆªé™¤å¸³è™Ÿå¤±æ•—: ' + error.message, 'danger');
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„æç¤º
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // å‰µå»ºæ–°çš„æç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            localStorage.clear();
            console.log('âœ… å·²ç™»å‡ºï¼Œæ¸…é™¤æœ¬åœ°å„²å­˜');
            // ä¸è·³è½‰ï¼Œä¿æŒåœ¨ç•¶å‰é é¢
        }
    </script>
</body>
</html>