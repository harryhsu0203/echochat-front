<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´é©—è­‰æ¸¬è©¦ - EchoChat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
            padding: 20px;
        }
        .test-card {
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .btn-test {
            margin: 5px;
            padding: 10px 20px;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .result.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-card">
            <h1 class="text-center text-success mb-4">
                <i class="fas fa-shield-alt me-2"></i>EchoChat å®Œæ•´é©—è­‰æ¸¬è©¦
            </h1>
            
            <!-- API é€£æ¥æ¸¬è©¦ -->
            <div class="test-card">
                <h3><i class="fas fa-plug me-2"></i>API é€£æ¥æ¸¬è©¦</h3>
                <button class="btn btn-primary btn-test" onclick="testApiConnection()">
                    <i class="fas fa-link me-2"></i>æ¸¬è©¦ API é€£æ¥
                </button>
                <div id="apiResult"></div>
            </div>
            
            <!-- ç™»å…¥æ¸¬è©¦ -->
            <div class="test-card">
                <h3><i class="fas fa-sign-in-alt me-2"></i>ç™»å…¥åŠŸèƒ½æ¸¬è©¦</h3>
                <div class="row">
                    <div class="col-md-6">
                        <label>ç”¨æˆ¶å:</label>
                        <input type="text" id="testUsername" class="form-control" value="sunnyharry1">
                    </div>
                    <div class="col-md-6">
                        <label>å¯†ç¢¼:</label>
                        <input type="password" id="testPassword" class="form-control" value="admin123">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success btn-test" onclick="testLogin()">
                        <i class="fas fa-key me-2"></i>æ¸¬è©¦ç™»å…¥
                    </button>
                    <button class="btn btn-info btn-test" onclick="testLoginWithGele()">
                        <i class="fas fa-user me-2"></i>æ¸¬è©¦ gele1227 å¯†ç¢¼
                    </button>
                </div>
                <div id="loginResult"></div>
            </div>
            
            <!-- Token é©—è­‰æ¸¬è©¦ -->
            <div class="test-card">
                <h3><i class="fas fa-certificate me-2"></i>Token é©—è­‰æ¸¬è©¦</h3>
                <button class="btn btn-warning btn-test" onclick="testTokenValidation()">
                    <i class="fas fa-check-circle me-2"></i>é©—è­‰ç•¶å‰ Token
                </button>
                <button class="btn btn-secondary btn-test" onclick="clearTokens()">
                    <i class="fas fa-trash me-2"></i>æ¸…é™¤æ‰€æœ‰ Token
                </button>
                <div id="tokenResult"></div>
            </div>
            
            <!-- å®Œæ•´æµç¨‹æ¸¬è©¦ -->
            <div class="test-card">
                <h3><i class="fas fa-flow-chart me-2"></i>å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
                <button class="btn btn-success btn-test" onclick="testCompleteFlow()">
                    <i class="fas fa-play me-2"></i>æ¸¬è©¦å®Œæ•´ç™»å…¥ â†’ é©—è­‰æµç¨‹
                </button>
                <div id="flowResult"></div>
            </div>
            
            <!-- å¿«é€Ÿå‹•ä½œ -->
            <div class="test-card">
                <h3><i class="fas fa-rocket me-2"></i>å¿«é€Ÿå‹•ä½œ</h3>
                <a href="login.html" class="btn btn-primary btn-test">
                    <i class="fas fa-sign-in-alt me-2"></i>å‰å¾€ç™»å…¥é 
                </a>
                <a href="dashboard.html" class="btn btn-info btn-test">
                    <i class="fas fa-tachometer-alt me-2"></i>å‰å¾€å„€è¡¨æ¿
                </a>
                <button class="btn btn-success btn-test" onclick="setValidToken()">
                    <i class="fas fa-magic me-2"></i>è¨­ç½®æœ‰æ•ˆ Token
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://echochat-api.onrender.com';
        
        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result ${type}">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        async function testApiConnection() {
            showResult('apiResult', 'æ­£åœ¨æ¸¬è©¦ API é€£æ¥...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('apiResult', `
                        <strong>âœ… API é€£æ¥æˆåŠŸ</strong><br>
                        ç‹€æ…‹: ${response.status}<br>
                        è¨Šæ¯: ${data.message}<br>
                        æ™‚é–“æˆ³: ${data.timestamp}
                    `, 'success');
                } else {
                    showResult('apiResult', `âŒ API å›æ‡‰éŒ¯èª¤: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `âŒ é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            showResult('loginResult', `æ­£åœ¨æ¸¬è©¦ç™»å…¥: ${username}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('staffName', data.user.name);
                    localStorage.setItem('staffRole', data.user.role);
                    localStorage.setItem('staffUsername', data.user.username);
                    
                    showResult('loginResult', `
                        <strong>âœ… ç™»å…¥æˆåŠŸ</strong><br>
                        ç”¨æˆ¶: ${data.user.name} (${data.user.username})<br>
                        è§’è‰²: ${data.user.role}<br>
                        Token: ${data.token.substring(0, 20)}...<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'success');
                } else {
                    showResult('loginResult', `
                        âŒ ç™»å…¥å¤±æ•—<br>
                        éŒ¯èª¤: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}<br>
                        ç‹€æ…‹: ${response.status}
                    `, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç™»å…¥è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testLoginWithGele() {
            document.getElementById('testUsername').value = 'sunnyharry1';
            document.getElementById('testPassword').value = 'gele1227';
            await testLogin();
        }
        
        async function testTokenValidation() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                showResult('tokenResult', 'âŒ æ²’æœ‰æ‰¾åˆ° Token', 'error');
                return;
            }
            
            showResult('tokenResult', 'æ­£åœ¨é©—è­‰ Token...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('tokenResult', `
                        <strong>âœ… Token é©—è­‰æˆåŠŸ</strong><br>
                        ç”¨æˆ¶: ${data.user.name} (${data.user.username})<br>
                        è§’è‰²: ${data.user.role}<br>
                        ID: ${data.user.id}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'success');
                } else {
                    showResult('tokenResult', `
                        âŒ Token é©—è­‰å¤±æ•—<br>
                        éŒ¯èª¤: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}<br>
                        ç‹€æ…‹: ${response.status}
                    `, 'error');
                }
            } catch (error) {
                showResult('tokenResult', `âŒ Token é©—è­‰è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function clearTokens() {
            localStorage.clear();
            sessionStorage.clear();
            showResult('tokenResult', 'âœ… å·²æ¸…é™¤æ‰€æœ‰ Token å’Œæœ¬åœ°å­˜å„²', 'success');
        }
        
        async function testCompleteFlow() {
            showResult('flowResult', 'é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦...', 'info');
            
            // æ¸…é™¤èˆŠ token
            localStorage.clear();
            
            let results = [];
            
            try {
                // 1. æ¸¬è©¦ç™»å…¥
                results.push('1. æ¸¬è©¦ç™»å…¥...');
                const loginResponse = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'sunnyharry1', password: 'admin123' })
                });
                
                const loginData = await loginResponse.json();
                
                if (!loginResponse.ok || !loginData.success) {
                    throw new Error(`ç™»å…¥å¤±æ•—: ${loginData.error}`);
                }
                
                results.push('âœ… ç™»å…¥æˆåŠŸ');
                localStorage.setItem('token', loginData.token);
                
                // 2. æ¸¬è©¦ token é©—è­‰
                results.push('2. æ¸¬è©¦ Token é©—è­‰...');
                const tokenResponse = await fetch(`${API_BASE}/api/me`, {
                    headers: { 'Authorization': `Bearer ${loginData.token}` }
                });
                
                const tokenData = await tokenResponse.json();
                
                if (!tokenResponse.ok || !tokenData.success) {
                    throw new Error(`Token é©—è­‰å¤±æ•—: ${tokenData.error}`);
                }
                
                results.push('âœ… Token é©—è­‰æˆåŠŸ');
                
                // 3. è¨­ç½®ç”¨æˆ¶è³‡è¨Š
                localStorage.setItem('staffName', tokenData.user.name);
                localStorage.setItem('staffRole', tokenData.user.role);
                localStorage.setItem('staffUsername', tokenData.user.username);
                
                results.push('âœ… ç”¨æˆ¶è³‡è¨Šå·²è¨­ç½®');
                results.push('ğŸ‰ å®Œæ•´æµç¨‹æ¸¬è©¦æˆåŠŸï¼');
                
                showResult('flowResult', `
                    <strong>âœ… å®Œæ•´æµç¨‹æ¸¬è©¦æˆåŠŸ</strong><br>
                    ${results.join('<br>')}<br><br>
                    ç¾åœ¨å¯ä»¥å®‰å…¨åœ°è¨ªå•å„€è¡¨æ¿äº†ï¼
                `, 'success');
                
            } catch (error) {
                results.push(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showResult('flowResult', results.join('<br>'), 'error');
            }
        }
        
        async function setValidToken() {
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'sunnyharry1', password: 'admin123' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('staffName', data.user.name);
                    localStorage.setItem('staffRole', data.user.role);
                    localStorage.setItem('staffUsername', data.user.username);
                    
                    alert('âœ… æœ‰æ•ˆ Token å·²è¨­ç½®ï¼ç¾åœ¨å¯ä»¥è¨ªå•å„€è¡¨æ¿äº†ã€‚');
                } else {
                    alert('âŒ ç„¡æ³•ç²å–æœ‰æ•ˆ Token');
                }
            } catch (error) {
                alert('âŒ è¨­ç½® Token å¤±æ•—: ' + error.message);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰ç‹€æ…‹
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('staffUsername');
            
            if (token && username) {
                document.querySelector('.container').insertAdjacentHTML('afterbegin', `
                    <div class="alert alert-success">
                        <i class="fas fa-user-check me-2"></i>
                        <strong>ç•¶å‰å·²ç™»å…¥:</strong> ${username} 
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="testTokenValidation()">é©—è­‰</button>
                    </div>
                `);
            } else {
                document.querySelector('.container').insertAdjacentHTML('afterbegin', `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ç›®å‰æœªç™»å…¥</strong> - è«‹åŸ·è¡Œç™»å…¥æ¸¬è©¦
                    </div>
                `);
            }
        });
    </script>
</body>
</html>