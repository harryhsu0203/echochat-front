<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>預約時間表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: #f5f7fb; }
    .slot { cursor: pointer; }
    .slot.disabled { cursor: not-allowed; opacity: .5; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h4 class="mb-0"><i class="fas fa-calendar-check me-2 text-primary"></i>可預約時段</h4>
              <button class="btn btn-outline-primary btn-sm" id="refreshBtn"><i class="fas fa-sync-alt me-1"></i>重新整理</button>
            </div>
            <div id="alertArea"></div>
            <div id="slots" class="row g-2"></div>
            <hr class="my-4"/>
            <h5 class="mb-3">建立預約</h5>
            <form id="bookForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">姓名</label>
                <input class="form-control" id="name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">聯絡方式（電話/Email）</label>
                <input class="form-control" id="contact" required>
              </div>
              <div class="col-12">
                <label class="form-label">預約時間</label>
                <input class="form-control" id="datetime" placeholder="請從上方點選或輸入 ISO 時間 (YYYY-MM-DDTHH:00:00Z)" required>
              </div>
              <div class="col-12">
                <label class="form-label">備註（選填）</label>
                <textarea class="form-control" id="note" rows="2"></textarea>
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-primary" type="submit"><i class="fas fa-check me-1"></i>送出預約</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
    const slotsEl = document.getElementById('slots');
    const datetimeInput = document.getElementById('datetime');
    const alertArea = document.getElementById('alertArea');

    function showAlert(msg, type='info') {
      const div = document.createElement('div');
      div.className = `alert alert-${type} alert-dismissible fade show`;
      div.innerHTML = `${msg}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>`;
      alertArea.appendChild(div);
      setTimeout(()=>{ if (div.parentNode) div.remove(); }, 4000);
    }

    async function loadSlots() {
      slotsEl.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>載入可預約時段...</div>';
      try {
        const r = await fetch(`${API}/appointments/slots`);
        const d = await r.json();
        if (!r.ok || !d.success) throw new Error(d.error || '載入失敗');
        if (!d.slots || !d.slots.length) {
          slotsEl.innerHTML = '<div class="text-center text-muted">目前沒有可預約時段</div>';
          return;
        }
        let html = '';
        d.slots.forEach(iso => {
          const dt = new Date(iso);
          const label = dt.toLocaleString('zh-TW');
          html += `<div class=\"col-6 col-md-4 col-lg-3\"><div class=\"border rounded p-2 slot\" data-iso=\"${iso}\"><i class=\"far fa-clock me-1\"></i>${label}</div></div>`;
        });
        slotsEl.innerHTML = html;
      } catch (e) {
        slotsEl.innerHTML = '<div class="text-danger">載入失敗，請稍後再試</div>';
      }
    }

    slotsEl.addEventListener('click', (e)=>{
      const item = e.target.closest('.slot');
      if (!item) return;
      const iso = item.getAttribute('data-iso');
      datetimeInput.value = iso;
      document.querySelectorAll('.slot').forEach(el=> el.classList.remove('bg-primary','text-white'));
      item.classList.add('bg-primary','text-white');
    });

    document.getElementById('refreshBtn').addEventListener('click', loadSlots);

    document.getElementById('bookForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        name: document.getElementById('name').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        datetime: document.getElementById('datetime').value.trim(),
        note: document.getElementById('note').value.trim()
      };
      if (!payload.name || !payload.contact || !payload.datetime) {
        showAlert('請完整填寫必填欄位', 'warning');
        return;
      }
      try {
        const r = await fetch(`${API}/appointments/book`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const d = await r.json();
        if (r.ok && d.success) {
          showAlert('預約成功！我們將盡快與您聯繫確認。', 'success');
          loadSlots();
          e.target.reset();
        } else {
          showAlert(d.error || '預約失敗', 'danger');
        }
      } catch (err) {
        showAlert('網路錯誤，請稍後再試', 'danger');
      }
    });

    loadSlots();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

