<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä»½é©—è­‰èª¿è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/api-config.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .debug-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .test-button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="debug-card p-4">
                    <h2 class="mb-4">
                        <i class="fas fa-bug"></i> èº«ä»½é©—è­‰èª¿è©¦å·¥å…·
                    </h2>
                    
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>ğŸ” åŸºæœ¬è³‡è¨Š</h5>
                            <div id="basicInfo"></div>
                        </div>
                        <div class="col-md-6">
                            <h5>ğŸ¯ å¿«é€Ÿæ¸¬è©¦</h5>
                            <div class="d-flex flex-wrap">
                                <button class="btn btn-primary test-button" onclick="testApiConnection()">
                                    <i class="fas fa-wifi"></i> æ¸¬è©¦ API
                                </button>
                                <button class="btn btn-success test-button" onclick="testAuth()">
                                    <i class="fas fa-key"></i> æ¸¬è©¦èªè­‰
                                </button>
                                <button class="btn btn-warning test-button" onclick="testDashboard()">
                                    <i class="fas fa-tachometer-alt"></i> æ¸¬è©¦å„€è¡¨æ¿
                                </button>
                                <button class="btn btn-danger test-button" onclick="clearAll()">
                                    <i class="fas fa-trash"></i> æ¸…é™¤æ‰€æœ‰
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token è³‡è¨Š -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>ğŸ”‘ Token è³‡è¨Š</h5>
                            <div id="tokenInfo" class="alert alert-info">
                                æª¢æŸ¥ä¸­...
                            </div>
                        </div>
                    </div>
                    
                    <!-- API æ¸¬è©¦çµæœ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>ğŸŒ API é€£æ¥æ¸¬è©¦</h5>
                            <div id="apiTestResult" class="alert alert-secondary">
                                ç­‰å¾…æ¸¬è©¦...
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>ğŸ” èªè­‰æ¸¬è©¦</h5>
                            <div id="authTestResult" class="alert alert-secondary">
                                ç­‰å¾…æ¸¬è©¦...
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°æ—¥èªŒ -->
                    <div class="row">
                        <div class="col-12">
                            <h5>ğŸ“ è©³ç´°æ—¥èªŒ</h5>
                            <div id="logContainer" class="log-container">
                                <div>æ—¥èªŒå°‡åœ¨é€™è£¡é¡¯ç¤º...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°ç‹€æ…‹å¾½ç« 
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `alert alert-${status}`;
            element.innerHTML = message;
        }

        // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
        function showBasicInfo() {
            const basicInfo = document.getElementById('basicInfo');
            const currentUrl = window.location.href;
            const apiUrl = window.API_BASE_URL || 'æœªè¨­å®š';
            const token = localStorage.getItem('token');
            
            basicInfo.innerHTML = `
                <table class="table table-sm">
                    <tr><td><strong>ç•¶å‰ URL:</strong></td><td>${currentUrl}</td></tr>
                    <tr><td><strong>API URL:</strong></td><td>${apiUrl}</td></tr>
                    <tr><td><strong>Token å­˜åœ¨:</strong></td><td>${token ? 'âœ… æ˜¯' : 'âŒ å¦'}</td></tr>
                    <tr><td><strong>ç”¨æˆ¶ä»£ç†:</strong></td><td>${navigator.userAgent}</td></tr>
                </table>
            `;
        }

        // é¡¯ç¤º Token è³‡è¨Š
        function showTokenInfo() {
            const token = localStorage.getItem('token');
            const tokenInfo = document.getElementById('tokenInfo');
            
            if (token) {
                const tokenLength = token.length;
                const tokenStart = token.substring(0, 20);
                const tokenEnd = token.substring(token.length - 20);
                
                tokenInfo.innerHTML = `
                    <h6>âœ… Token å­˜åœ¨</h6>
                    <p><strong>é•·åº¦:</strong> ${tokenLength} å­—å…ƒ</p>
                    <p><strong>é–‹é ­:</strong> ${tokenStart}...</p>
                    <p><strong>çµå°¾:</strong> ...${tokenEnd}</p>
                `;
                tokenInfo.className = 'alert alert-success';
            } else {
                tokenInfo.innerHTML = '<h6>âŒ Token ä¸å­˜åœ¨</h6>';
                tokenInfo.className = 'alert alert-danger';
            }
        }

        // æ¸¬è©¦ API é€£æ¥
        async function testApiConnection() {
            log('ğŸ” é–‹å§‹æ¸¬è©¦ API é€£æ¥...');
            updateStatus('apiTestResult', 'info', 'æ¸¬è©¦ä¸­...');
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… API é€£æ¥æˆåŠŸ');
                    updateStatus('apiTestResult', 'success', `
                        <h6>âœ… API é€£æ¥æ­£å¸¸</h6>
                        <p>ç‹€æ…‹ç¢¼: ${response.status}</p>
                        <p>å›æ‡‰: ${JSON.stringify(data)}</p>
                    `);
                } else {
                    log(`âŒ API é€£æ¥å¤±æ•—: ${response.status}`);
                    updateStatus('apiTestResult', 'danger', `
                        <h6>âŒ API é€£æ¥å¤±æ•—</h6>
                        <p>ç‹€æ…‹ç¢¼: ${response.status}</p>
                        <p>éŒ¯èª¤: ${JSON.stringify(data)}</p>
                    `);
                }
            } catch (error) {
                log(`âŒ API é€£æ¥éŒ¯èª¤: ${error.message}`);
                updateStatus('apiTestResult', 'danger', `
                    <h6>âŒ API é€£æ¥éŒ¯èª¤</h6>
                    <p>éŒ¯èª¤: ${error.message}</p>
                `);
            }
        }

        // æ¸¬è©¦èªè­‰
        async function testAuth() {
            log('ğŸ” é–‹å§‹æ¸¬è©¦èªè­‰...');
            updateStatus('authTestResult', 'info', 'æ¸¬è©¦ä¸­...');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('âŒ æ²’æœ‰ Token å¯ä»¥æ¸¬è©¦');
                updateStatus('authTestResult', 'warning', '<h6>âš ï¸ æ²’æœ‰ Token</h6><p>è«‹å…ˆç™»å…¥</p>');
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… èªè­‰æˆåŠŸ');
                    updateStatus('authTestResult', 'success', `
                        <h6>âœ… èªè­‰æˆåŠŸ</h6>
                        <p>ç”¨æˆ¶: ${data.user?.username || 'æœªçŸ¥'}</p>
                        <p>è§’è‰²: ${data.user?.role || 'æœªçŸ¥'}</p>
                    `);
                } else {
                    log(`âŒ èªè­‰å¤±æ•—: ${response.status}`);
                    updateStatus('authTestResult', 'danger', `
                        <h6>âŒ èªè­‰å¤±æ•—</h6>
                        <p>ç‹€æ…‹ç¢¼: ${response.status}</p>
                        <p>éŒ¯èª¤: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    `);
                }
            } catch (error) {
                log(`âŒ èªè­‰éŒ¯èª¤: ${error.message}`);
                updateStatus('authTestResult', 'danger', `
                    <h6>âŒ èªè­‰éŒ¯èª¤</h6>
                    <p>éŒ¯èª¤: ${error.message}</p>
                `);
            }
        }

        // æ¸¬è©¦å„€è¡¨æ¿
        function testDashboard() {
            log('ğŸ” æ¸¬è©¦å„€è¡¨æ¿è·³è½‰...');
            
            // æ¨¡æ“¬å„€è¡¨æ¿çš„èªè­‰æª¢æŸ¥
            const token = localStorage.getItem('token');
            if (!token) {
                log('âŒ æ²’æœ‰ Tokenï¼Œæœƒè·³è½‰åˆ°ç™»å…¥é é¢');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            } else {
                log('âœ… æœ‰ Tokenï¼Œæ‡‰è©²å¯ä»¥è¨ªå•å„€è¡¨æ¿');
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 2000);
            }
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAll() {
            log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°å„²å­˜è³‡æ–™...');
            localStorage.clear();
            sessionStorage.clear();
            showTokenInfo();
            updateStatus('authTestResult', 'warning', '<h6>âš ï¸ å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™</h6>');
            log('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤');
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            log('ğŸš€ èª¿è©¦å·¥å…·å·²è¼‰å…¥');
            showBasicInfo();
            showTokenInfo();
            testApiConnection();
            testAuth();
        };
    </script>
</body>
</html> 