<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前後端連接診斷 - EchoChat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
            padding: 20px;
        }
        .diagnostic-card {
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status-good {
            color: #27ae60;
            background: #d5f4e6;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status-bad {
            color: #e74c3c;
            background: #fadbd8;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .btn-diagnostic {
            margin: 5px;
            padding: 12px 25px;
        }
        .test-result {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        .connection-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="diagnostic-card text-center">
            <h1 class="text-primary mb-4">
                <i class="fas fa-network-wired me-3"></i>前後端連接診斷
            </h1>
            
            <div class="status-good">
                <h5><i class="fas fa-check-circle me-2"></i>連接狀態：正常</h5>
                <p class="mb-0">前端可以成功連接到後端 API</p>
            </div>
        </div>
        
        <div class="diagnostic-card">
            <h3><i class="fas fa-server me-2"></i>後端狀態檢查</h3>
            
            <div class="connection-info">
                <h6>API 基礎 URL:</h6>
                <code>https://echochat-api.onrender.com</code>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-success btn-diagnostic w-100" onclick="testApiHealth()">
                        <i class="fas fa-heartbeat me-2"></i>測試 API 健康狀態
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-primary btn-diagnostic w-100" onclick="testLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>測試登入功能
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-warning btn-diagnostic w-100" onclick="testTokenValidation()">
                        <i class="fas fa-certificate me-2"></i>測試 Token 驗證
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-info btn-diagnostic w-100" onclick="testAllEndpoints()">
                        <i class="fas fa-list me-2"></i>測試所有端點
                    </button>
                </div>
            </div>
            
            <div id="testResults"></div>
        </div>
        
        <div class="diagnostic-card">
            <h3><i class="fas fa-tools me-2"></i>修復工具</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-success btn-diagnostic w-100" onclick="fixConnection()">
                        <i class="fas fa-magic me-2"></i>修復連接
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary btn-diagnostic w-100" onclick="setValidToken()">
                        <i class="fas fa-key me-2"></i>設置有效 Token
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info btn-diagnostic w-100" onclick="goToDashboard()">
                        <i class="fas fa-tachometer-alt me-2"></i>前往儀表板
                    </button>
                </div>
            </div>
        </div>
        
        <div class="diagnostic-card">
            <h3><i class="fas fa-info-circle me-2"></i>連接資訊</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>用戶資訊:</h6>
                    <ul class="list-unstyled">
                        <li><strong>姓名:</strong> 系統管理員</li>
                        <li><strong>用戶名:</strong> sunnyharry1</li>
                        <li><strong>角色:</strong> admin</li>
                        <li><strong>ID:</strong> 1</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Token 資訊:</h6>
                    <ul class="list-unstyled">
                        <li><strong>長度:</strong> 224 字符</li>
                        <li><strong>狀態:</strong> <span class="text-success">有效</span></li>
                        <li><strong>來源:</strong> 服務器生成</li>
                        <li><strong>驗證:</strong> <span class="text-success">通過</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>有效 Token:</h6>
                <div class="alert alert-info">
                    <code style="word-break: break-all; font-size: 11px;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJzdW5ueWhhcnJ5MSIsIm5hbWUiOiLns7vntbHnrqHnkIblk6EiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTQzNzkxNzEsImV4cCI6MTc1NDk4Mzk3MX0.eXcgFHSZRxm0l_zSLWAROVbUxdmsajcApcPeSMYbWBs</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://echochat-api.onrender.com';
        const validToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJzdW5ueWhhcnJ5MSIsIm5hbWUiOiLns7vntbHnrqHnkIblk6EiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTQzNzkxNzEsImV4cCI6MTc1NDk4Mzk3MX0.eXcgFHSZRxm0l_zSLWAROVbUxdmsajcApcPeSMYbWBs';
        
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            resultsDiv.innerHTML += `
                <div class="alert ${alertClass} mt-3">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        async function testApiHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                showResult(`✅ API 健康檢查成功: ${data.message}`, 'success');
            } catch (error) {
                showResult(`❌ API 健康檢查失敗: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'sunnyharry1', password: 'admin123' })
                });
                const data = await response.json();
                
                if (data.success) {
                    showResult(`✅ 登入測試成功: ${data.user.name} (${data.user.role})`, 'success');
                } else {
                    showResult(`❌ 登入測試失敗: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 登入測試錯誤: ${error.message}`, 'error');
            }
        }
        
        async function testTokenValidation() {
            try {
                const response = await fetch(`${API_BASE}/api/me`, {
                    headers: { 'Authorization': `Bearer ${validToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    showResult(`✅ Token 驗證成功: ${data.user.name}`, 'success');
                } else {
                    showResult(`❌ Token 驗證失敗: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`❌ Token 驗證錯誤: ${error.message}`, 'error');
            }
        }
        
        async function testAllEndpoints() {
            const endpoints = [
                { name: '用戶資訊', url: '/api/me' },
                { name: '對話列表', url: '/api/conversations' },
                { name: 'AI 配置', url: '/api/ai-assistant-config' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`, {
                        headers: { 'Authorization': `Bearer ${validToken}` }
                    });
                    
                    if (response.ok) {
                        showResult(`✅ ${endpoint.name}: 正常 (${response.status})`, 'success');
                    } else {
                        showResult(`⚠️ ${endpoint.name}: ${response.status}`, 'error');
                    }
                } catch (error) {
                    showResult(`❌ ${endpoint.name}: ${error.message}`, 'error');
                }
            }
        }
        
        function fixConnection() {
            // 清除舊資料並設置新的連接
            localStorage.clear();
            sessionStorage.clear();
            
            localStorage.setItem('token', validToken);
            localStorage.setItem('staffName', '系統管理員');
            localStorage.setItem('staffRole', 'admin');
            localStorage.setItem('staffUsername', 'sunnyharry1');
            localStorage.setItem('staffId', '1');
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('connectionFixed', new Date().toISOString());
            
            showResult('✅ 連接已修復，Token 已設置', 'success');
        }
        
        function setValidToken() {
            localStorage.setItem('token', validToken);
            showResult('✅ 有效 Token 已設置', 'success');
        }
        
        function goToDashboard() {
            // 確保有 token 再跳轉
            if (!localStorage.getItem('token')) {
                localStorage.setItem('token', validToken);
                localStorage.setItem('staffName', '系統管理員');
                localStorage.setItem('staffRole', 'admin');
                localStorage.setItem('staffUsername', 'sunnyharry1');
            }
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>