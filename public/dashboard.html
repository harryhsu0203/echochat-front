<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="dashboard.title">EchoChat - 儀表板 | AI 客服管理後台</title>
    <meta name="description" content="EchoChat AI 客服管理儀表板，管理您的 LINE 聊天機器人、智慧客服設定、知識庫、對話記錄和 AI 助理配置。">
    <meta name="keywords" content="EchoChat 儀表板, AI 客服管理, 客服系統後台, LINE Bot 管理, 智慧客服設定, 客服管理系統">
    <meta name="robots" content="noindex,nofollow">
    <link rel="canonical" href="https://echochat-web.onrender.com/dashboard.html">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <meta name="theme-color" content="#667eea">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="js/api-config.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }


        
        /* 知識庫標籤樣式 */
        .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            border-color: #007bff !important;
        }
        
        .nav-link:not(.active) {
            background: transparent !important;
            color: white !important;
            border-color: transparent !important;
        }
        
        /* 範例對話卡片樣式 */
        .example-conversation-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .example-conversation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .hover-card {
            transition: all 0.3s ease;
        }
        
        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 過濾器按鈕樣式 */
        .btn-filter {
            border: 1px solid #dee2e6;
            background: white;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .btn-filter:hover {
            background: #f8f9fa;
            border-color: #007bff;
            color: #007bff;
        }
        
        .btn-filter.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        /* 客服帳號管理樣式 */
        .connected-account-item {
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .connected-account-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .quick-reply-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-reply-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .quick-reply-card .card {
            transition: all 0.3s ease;
        }
        
        .quick-reply-card:hover .card {
            border-color: #007bff;
        }
        /* Admin 專用元素預設隱藏，避免非管理員初始閃爍 */
        .admin-only { display: none !important; }
        
        /* 聊天訊息樣式 */
        .conversation-item {
            transition: all 0.3s ease;
        }
        
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        
        .conversation-item.active {
            background-color: #e3f2fd;
            border-left: 3px solid #007bff;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            margin-bottom: 8px;
        }
        
        .message-bubble.received {
            background-color: #f1f0f0;
            color: #333;
        }
        
        .message-bubble.sent {
            background-color: #007bff;
            color: white;
        }
        
        .message-content {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .message {
            margin-bottom: 16px;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .message-bubble.received .message-time {
            color: #666;
        }
        
        .message-bubble.sent .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* 未讀指示器樣式 */
        .unread-indicator {
            transition: all 0.3s ease;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
        }
        
        .unread-indicator:hover {
            transform: scale(1.2);
        }
        
        /* 聊天訊息區域滾動樣式 */
        #chatMessages {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        #chatMessages::-webkit-scrollbar {
            width: 6px;
        }
        
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #chatMessages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 確保聊天區域不會超出視窗 */
        .chat-container {
            max-height: calc(100vh - 200px);
            overflow: hidden;
        }

        .conversation-layout {
            height: 70vh;
            max-height: 700px;
            min-height: 420px;
            overflow: hidden;
        }

        #conversationsPage #conversationList {
            max-height: calc(70vh - 80px);
            overflow-y: auto;
        }

        #conversationsPage #chatMessages {
            max-height: calc(70vh - 220px);
            overflow-y: auto;
        }

        .conversation-layout .card {
            height: 100%;
        }

        .conversation-layout .card-body {
            min-height: 0;
        }

        .conversation-list-body {
            height: 100%;
            min-height: 0;
            overflow-y: auto;
        }

        .chat-panel-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .chat-messages-panel {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
        }
        

        
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px !important;
            overflow-y: auto;
            overflow-x: visible;
            z-index: 1000;
            transition: width 0.3s ease !important;
            box-sizing: border-box;
        }
        
        .sidebar.collapsed {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
        }
        
        .sidebar.collapsed .nav-link {
            text-align: center;
            padding: 12px 8px;
            position: relative;
            justify-content: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            font-size: 0 !important;
            width: 100%;
        }
        
        .sidebar.collapsed .nav-link i {
            margin-right: 0 !important;
            font-size: 1.1rem !important;
            display: block !important;
            text-align: center;
        }
        
        .sidebar.collapsed .nav {
            align-items: center;
        }
        
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed #logoText,
        .sidebar.collapsed #logoSubtext,
        .sidebar.collapsed #aiConfigArrow {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            font-size: 0 !important;
        }
        
        .sidebar.collapsed #logoSection {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .sidebar.collapsed #logoSection .logo-link {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* 側欄固定為展開；移除切換按鈕樣式 */
        
        
        
        /* 確保按鈕在收縮狀態下正確顯示 */
        .sidebar.collapsed .sidebar-toggle-btn i {
            font-size: 12px;
        }
        
        .sidebar-toggle-btn:hover {
            transform: translateY(-50%) scale(1.06);
            box-shadow: 0 12px 28px rgba(102,126,234,0.45);
        }
        
        .sidebar-toggle-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        /* 確保按鈕在收縮狀態下也能正確懸停 */
        
        
        
        
        /* 強制確保按鈕在最上層 */
        
        
        /* 確保按鈕不被其他元素遮擋 */
        
        
        

        /* 側欄項目只亮起不位移 */
        .sidebar .nav-link { 
            transition: background-color 0.2s ease, color 0.2s ease; 
        }
        .sidebar .nav-link i { 
            transition: color 0.2s ease, opacity 0.2s ease; 
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link:focus,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.12);
            color: #ffffff;
        }
        .sidebar .nav-link:hover i,
        .sidebar .nav-link:focus i,
        .sidebar .nav-link.active i { color: #ffffff; }
        
        .sidebar.collapsed #toggleContainer {
            justify-content: center !important;
        }
        
        .sidebar.collapsed #sidebarToggle {
            width: 100%;
            justify-content: center;
        }
        
        .sidebar.collapsed .nav-link:hover::after {
            content: attr(data-title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1001;
            margin-left: 10px;
        }
        
        .sidebar.collapsed #aiConfigMenu {
            display: none !important;
            margin-left: 0 !important;
            opacity: 0;
            height: 0;
            overflow: hidden;
        }
        

        
        /* 強制隱藏側邊欄內的所有文字（除了圖示） */
        .sidebar.collapsed .nav-link *:not(i),
        .sidebar.collapsed #logoSection *:not(i) {
            font-size: 0 !important;
        }
        
        .sidebar.collapsed .nav-link {
            color: transparent !important;
        }
        
        .sidebar.collapsed .nav-link i {
            color: rgba(255,255,255,0.8) !important;
        }
        
        .sidebar.collapsed #aiConfigArrow,
        .sidebar.collapsed .nav-link span {
            display: none !important;
        }
        
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
            margin-left: 250px !important;
            width: calc(100% - 250px) !important;
            transition: margin-left 0.3s ease, width 0.3s ease !important;
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }

        .dashboard-header {
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h2 {
            margin-bottom: 0;
        }

        .header-actions {
            gap: 0.75rem;
        }

        .header-actions .btn {
            white-space: nowrap;
        }

        .mobile-nav-toggle {
            padding: 0.45rem 0.9rem;
        }

        body.sidebar-open {
            overflow: hidden;
        }

        .mobile-nav-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.95rem;
        }

        .sidebar-overlay {
            display: none;
        }
        
        .main-content.expanded {
            margin-left: 60px !important;
            width: calc(100% - 60px) !important;
        }
        
        /* 響應式設計 */
        @media (max-width: 991.98px) {
            body {
                overflow-x: hidden;
            }

            .sidebar {
                width: 260px !important;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1050;
                height: 100vh;
            }
            
            .sidebar.show,
            body.sidebar-open .sidebar {
                transform: translateX(0);
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(15, 15, 30, 0.55);
                z-index: 1040;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .mobile-nav-toggle {
                display: inline-flex;
            }
            
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 3.5rem 1.5rem 1.5rem !important;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
            }

            .dashboard-header > .d-flex {
                width: 100%;
                justify-content: space-between;
            }

            .dashboard-header h2 {
                font-size: 1.5rem;
            }

            .mobile-nav-toggle {
                display: inline-flex;
                width: 100%;
                justify-content: space-between;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .header-actions .btn {
                flex: 1 1 calc(50% - 0.75rem);
            }

            .stats-card,
            .quick-action-card,
            .chart-card,
            .recent-activity,
            .integration-card,
            .account-setting-card {
                padding: 20px;
            }

            #dashboardPage .row {
                --bs-gutter-x: 1rem;
                --bs-gutter-y: 1rem;
            }

            .sidebar {
                min-height: auto;
            }

            .d-flex.justify-content-between.align-items-center.mb-4 {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .stats-card,
            .quick-action-card,
            .chart-card,
            .recent-activity,
            .integration-card,
            .account-setting-card {
                margin-bottom: 20px;
            }

            #conversationsPage .row,
            #conversationsPage .card,
            #conversationsPage .card-body {
                height: auto !important;
                max-height: none !important;
            }

            #conversationsPage .conversation-list {
                max-height: 400px !important;
            }

            #conversationsPage .conversation-layout {
                height: auto !important;
                min-height: 0 !important;
            }

            #conversationsPage .conversation-list-body {
                max-height: 45vh !important;
            }

            #conversationsPage .chat-panel-body {
                height: auto !important;
            }

            #conversationsPage #chatMessages {
                max-height: 45vh !important;
            }
        }

        @media (max-width: 575.98px) {
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions .btn {
                flex: 1 1 auto;
                width: 100%;
            }

            .mobile-nav-toggle {
                font-size: 0.95rem;
            }

            .stats-card h3 {
                font-size: 1.5rem;
            }

            .quick-action-card h5 {
                font-size: 1.1rem;
            }

            .chart-card,
            .recent-activity {
                overflow-x: auto;
            }
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 0;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        /* 帳戶設定導航項目樣式 */
        .sidebar .nav-link[data-tab="users"] {
            margin-top: auto !important;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .quick-action-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            text-align: center;
            cursor: pointer;
        }
        
        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .package-card {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
        }

        .package-card:hover {
            border-color: #667eea;
            box-shadow: 0 12px 24px rgba(102,126,234,0.15);
        }

        .package-card.active {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
        }
        
        .quick-action-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .recent-activity {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            align-items: center;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        /* 使用案例庫樣式 */
        .btn-filter {
            border-radius: 25px !important;
            padding: 8px 20px !important;
            font-weight: 500 !important;
            border: 2px solid #e9ecef !important;
            background: white !important;
            color: #6c757d !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
        }
        
        .btn-filter:hover {
            border-color: #007bff !important;
            color: #007bff !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0,123,255,0.15) !important;
        }
        
        .btn-filter.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            border-color: #007bff !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3) !important;
        }
        
        .use-case-card {
            border-radius: 16px !important;
            transition: all 0.3s ease !important;
            background: white !important;
            border: 1px solid #f8f9fa !important;
        }
        
        .use-case-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
            border-color: #e9ecef !important;
        }
        
        .badge {
            border-radius: 20px !important;
            padding: 6px 12px !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
            border: none !important;
        }
        
        .badge-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
        }
        
        .badge-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
            color: white !important;
        }
        
        .badge-info {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%) !important;
            color: white !important;
        }
        
        .badge-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            color: white !important;
        }
        
        /* 整合頁面樣式 */
        .integration-card {
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
            background: white !important;
            border: 1px solid #f8f9fa !important;
            cursor: pointer !important;
        }
        
        .integration-card:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1) !important;
            border-color: #e9ecef !important;
        }
        
        .integration-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        .integration-card:hover .integration-icon {
            background: #e9ecef;
            transform: scale(1.1);
        }
        
        /* 帳戶設定頁面樣式 */
        .account-setting-card {
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
            background: white !important;
            border: 1px solid #f8f9fa !important;
            cursor: pointer !important;
        }
        
        .account-setting-card:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1) !important;
            border-color: #e9ecef !important;
        }
        
        .setting-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        .account-setting-card:hover .setting-icon {
            background: #e9ecef;
            transform: scale(1.1);
        }
        
        /* 對話頁面樣式 */
        .conversation-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        
        .conversation-item.active {
            background-color: #e3f2fd;
            border-left: 3px solid #007bff;
        }
        
        .conversation-item.unread {
            background-color: #fff3cd;
        }
        
        .conversation-item.unread:hover {
            background-color: #ffeaa7;
        }
        
        .platform-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        .message-bubble {
            max-width: 70%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        
        .message-bubble.sent {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message-bubble.received {
            background: #f8f9fa;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 16px;
            color: white;
        }
        
        .activity-content {
            flex-grow: 1;
        }
        
        .activity-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(108, 117, 125, 0.3);
            border-radius: 50%;
            border-top-color: #6c757d;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
        }
        
        /* 確保登出按鈕可見且可點擊 */
        #logoutButton {
            cursor: pointer !important;
            z-index: 1000 !important;
            position: relative !important;
            pointer-events: auto !important;
            background-color: transparent !important;
            border: 1px solid #dc3545 !important;
            color: #dc3545 !important;
        }
        
        #logoutButton:hover {
            background-color: #dc3545 !important;
            color: white !important;
            transform: none !important;
        }
        
        #logoutButton:active {
            background-color: #c82333 !important;
            border-color: #bd2130 !important;
        }
        
        /* Logo 樣式 */
        .logo-link {
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .logo-link:hover {
            transform: scale(1.05);
        }
        
        .logo-link:hover h4 {
            color: rgba(255,255,255,0.9) !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .logo-link h4 {
            transition: all 0.3s ease;
        }
        
        /* AI助理配置頁面樣式 */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .alert {
            border: none;
            border-radius: 15px;
        }
        
        .badge {
            border-radius: 10px;
        }
        
        #aiDescription {
            resize: vertical;
            min-height: 150px;
        }
        
        .chat-messages {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 知識庫頁面樣式 */
        .hover-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .hover-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
        }
        
        .nav-pills .nav-link {
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            border-color: #007bff !important;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
        }
        
        .nav-pills .nav-link {
            color: #6c757d !important;
            background-color: transparent !important;
            border: 1px solid transparent !important;
            transition: all 0.3s ease !important;
        }
        
        .nav-pills .nav-link:hover {
            color: #007bff !important;
            background-color: rgba(0, 123, 255, 0.1) !important;
            border-color: rgba(0, 123, 255, 0.3) !important;
        }
        
        .nav-pills .nav-link.active:hover {
            color: white !important;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            border-color: #007bff !important;
        }
        
        /* 強制覆蓋任何可能的白色背景 */
        .nav-pills .nav-link.active,
        .nav-pills .nav-link.active:focus,
        .nav-pills .nav-link.active:active,
        .nav-pills .nav-link.active:hover {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            border-color: #007bff !important;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
        }
        
        /* 確保非active狀態的樣式 */
        .nav-pills .nav-link:not(.active) {
            background-color: transparent !important;
            color: #6c757d !important;
            border-color: transparent !important;
        }
        
        /* 最強制性的樣式覆蓋 - 確保active按鈕永遠不會是白色 */
        .nav-pills .nav-link.active,
        .nav-pills .nav-link.active *,
        .nav-pills .nav-link.active i,
        .nav-pills .nav-link.active span {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            border-color: #007bff !important;
        }
        
        /* 使用更高優先級的選擇器 */
        body .nav-pills .nav-link.active,
        html body .nav-pills .nav-link.active,
        .container-fluid .nav-pills .nav-link.active,
        .row .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            border-color: #007bff !important;
            background-color: #007bff !important;
        }
        
        /* 防止透明背景 */
        .nav-pills .nav-link.active[style*="rgba(0, 0, 0, 0)"],
        .nav-pills .nav-link.active[style*="transparent"] {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            background-color: #007bff !important;
        }
        
        /* 覆蓋Bootstrap的nav-link樣式 */
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            background-color: #007bff !important;
            color: white !important;
            border-color: #007bff !important;
        }
        
        /* 確保所有可能的選擇器都被覆蓋 */
        .nav-pills .nav-link.active,
        .nav-pills .nav-link.active:hover,
        .nav-pills .nav-link.active:focus,
        .nav-pills .nav-link.active:active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            background-color: #007bff !important;
            color: white !important;
            border-color: #007bff !important;
            position: relative !important;
            z-index: 10 !important;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
        }
        
        /* 確保按鈕容器不會干擾按鈕樣式 */
        .nav-pills {
            background-color: #f8f9fa !important;
            border-radius: 50rem !important;
            padding: 0.25rem !important;
        }
        
        /* 強制按鈕樣式 */
        .nav-pills .nav-link {
            position: relative !important;
            z-index: 1 !important;
            transition: all 0.3s ease !important;
        }
        
        .nav-pills .nav-link.active {
            z-index: 10 !important;
        }
        
        /* 防止任何JavaScript動態修改樣式 */
        .nav-pills .nav-link.active[style*="background"] {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        }
        
        .nav-pills .nav-link.active[style*="color"] {
            color: white !important;
        }
        
        /* 防止內容被隱藏 */
        .force-show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            width: auto !important;
        }
        
        /* 確保知識庫內容區域可見 */
        #newKnowledgeContent.force-show,
        #existingKnowledgeContent.force-show,
        #configContent.force-show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            width: auto !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .table th {
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa !important;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }
        
        /* 知識庫分類卡片樣式 */
        .knowledge-category-card {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .knowledge-category-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.1) !important;
        }
        
        .progress {
            border-radius: 10px;
        }
        
        .progress-bar {
            border-radius: 10px;
        }
        
        /* 配額卡片樣式 */
        .card.border-warning {
            border-width: 2px !important;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        /* 搜尋框樣式 */
        .input-group-text {
            border-right: none;
        }
        
        .form-control.border-start-0 {
            border-left: none;
        }
        
        /* 隱藏元素樣式 */
        .hidden {
            display: none;
        }
        
        /* 強制顯示 */
        .force-show {
            display: block !important;
        }
        
        /* 社交平台圖示按鈕樣式 */
        .btn-social-icon {
            width: 70px;
            height: 55px;
            border-radius: 15px;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .btn-social-icon:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .btn-social-icon:hover:before {
            opacity: 1;
        }
        
        .btn-social-icon:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25) !important;
        }
        
        .btn-social-icon:active {
            transform: translateY(-1px);
        }
        
        .btn-social-icon i {
            z-index: 1;
            position: relative;
        }
        
        .form-control.border-start-0:focus {
            border-left: none;
            box-shadow: none;
        }
        
        /* 詳細視圖動畫 */
        #knowledgeDetailView {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* AI配置菜單的顯示/隱藏控制 */
        #aiConfigMenu {
            display: none !important;
            transition: all 0.3s ease;
            margin-left: 20px;
        }
        
        #aiConfigMenu.show {
            display: block !important;
        }
        
        /* 確保在側邊欄收縮時菜單始終隱藏 */
        .sidebar.collapsed #aiConfigMenu {
            display: none !important;
        }
    </style>
    <script src="js/i18n.js"></script>
    <script src="js/empty-auth.js"></script>
</head>
<body>


    <!-- 側邊欄切換按鈕 -->
    
    
    <div class="container-fluid p-0">
        <!-- 側邊欄 -->
        <div class="sidebar p-4 d-flex flex-column" style="height: 100vh;">
                
                <div class="text-center mb-4" id="logoSection">
                    <a href="/index.html" class="logo-link text-decoration-none">
                        <h4 class="text-white mb-1" id="logoText"><i class="fas fa-robot me-2"></i>EchoChat</h4>
                    </a>
                    <p class="text-white small" id="logoSubtext" data-i18n="dashboard.sidebar.title">儀表板</p>
                    <div class="text-white small mt-2" id="greetingLine" style="line-height:1.2;"></div>
                                    <div class="text-white-50 small" id="planLine"></div>
                                    <div class="mt-2">
                                        <a class="nav-link p-0" href="#" data-tab="plans" data-title="方案與儲值">
                                            <div class="d-flex align-items-center gap-2 p-2 rounded-3" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); cursor: pointer;">
                                                <i id="plansEntryIcon" class="fas fa-user-circle text-white"></i>
                                                <span class="text-white">檢視方案</span>
                                            </div>
                                        </a>
                                    </div>
                </div>
                        
                <nav class="nav flex-column flex-grow-1">
                    <a class="nav-link active" href="#" data-tab="dashboard" data-title="儀表板">
                        <i class="fas fa-tachometer-alt me-2"></i><span data-i18n="dashboard.sidebar.dashboard">儀表板</span>
                    </a>
                    <a class="nav-link" href="#" data-tab="conversations" data-title="對話">
                        <i class="fas fa-comments me-2"></i><span data-i18n="dashboard.sidebar.conversations">對話</span>
                    </a>
                    <a class="nav-link" href="#" id="aiConfigToggle" data-title="AI助理配置">
                        <i class="fas fa-robot me-2"></i><span data-i18n="dashboard.sidebar.ai_config">AI助理配置</span> <span id="aiConfigArrow" style="float:right;"><i class="fas fa-caret-right"></i></span>
                    </a>
                    <div id="aiConfigMenu">
                        <a class="nav-link" href="#" data-tab="aiassistant" data-title="AI助理資訊">
                            <i class="fas fa-cog me-2"></i><span data-i18n="dashboard.sidebar.ai_assistant">AI助理資訊</span>
                        </a>
                        <a class="nav-link" href="#" data-tab="knowledge" data-title="知識庫">
                            <i class="fas fa-book me-2"></i><span data-i18n="dashboard.sidebar.knowledge">知識庫</span>
                        </a>
                        <a class="nav-link" href="#" data-tab="channel" data-title="頻道">
                            <i class="fas fa-stream me-2"></i><span data-i18n="dashboard.sidebar.channel">頻道</span>
                        </a>
                        <a class="nav-link" href="#" data-tab="cases" data-title="使用案例庫">
                            <i class="fas fa-folder-open me-2"></i><span data-i18n="dashboard.sidebar.cases">使用案例庫</span>
                        </a>
                        <a class="nav-link" href="#" data-tab="integration" data-title="整合">
                            <i class="fas fa-plug me-2"></i><span data-i18n="dashboard.sidebar.integration">整合</span>
                        </a>
                    </div>

                    <a class="nav-link" href="#" data-tab="users" data-title="帳戶設定">
                        <i class="fas fa-user-cog me-2"></i><span data-i18n="dashboard.sidebar.account_settings">帳戶設定</span>
                    </a>
                    <a class="nav-link admin-only" href="account-management.html" data-title="帳號管理">
                        <i class="fas fa-users me-2"></i><span>帳號管理</span>
                    </a>
                </nav>
        </div>

        <div class="sidebar-overlay"></div>
        
        <!-- 主要內容區 -->
        <div class="main-content p-4">
                        <!-- 標題列 -->
                        <div class="d-flex justify-content-between align-items-center mb-4 dashboard-header">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <button type="button" class="btn btn-outline-secondary btn-sm mobile-nav-toggle" id="mobileNavToggle">
                                    <i class="fas fa-bars me-2"></i>
                                    <span>功能選單</span>
                                </button>
                            <h2 class="mb-0">
                                <span id="pageTitle" data-i18n="dashboard.page_title">儀表板</span>
                            </h2>
                            </div>
                            <div class="d-flex align-items-center header-actions flex-wrap">
                                <span class="me-3 d-flex align-items-center">
                                    <i class="fas fa-clock me-1"></i>
                                    <span id="currentTime"></span>
                                </span>

                                
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-1"></i><span data-i18n="dashboard.btn.refresh">重新整理</span>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" id="logoutButton">
                                    <i class="fas fa-sign-out-alt me-1"></i><span data-i18n="dashboard.btn.logout">登出</span>
                                </button>
                            </div>
                        </div>
                        

                        
                        <!-- 儀表板頁面 -->
                        <div id="dashboardPage">
                            <!-- 統計卡片 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="stats-card text-center">
                                        <div class="stats-icon bg-primary mx-auto mb-3">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h3 id="totalUsers">0</h3>
                                        <p class="text-muted mb-0" data-i18n="dashboard.stats.total_users">總用戶數</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card text-center">
                                        <div class="stats-icon bg-success mx-auto mb-3">
                                            <i class="fas fa-comments"></i>
                                        </div>
                                        <h3 id="totalMessages">0</h3>
                                        <p class="text-muted mb-0" data-i18n="dashboard.stats.total_messages">總訊息數</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card text-center">
                                        <div class="stats-icon bg-warning mx-auto mb-3">
                                            <i class="fas fa-brain"></i>
                                        </div>
                                        <h3 id="knowledgeItems">0</h3>
                                        <p class="text-muted mb-0" data-i18n="dashboard.stats.knowledge_items">知識庫項目</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 快速操作 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h4 class="mb-3">快速操作</h4>
                                </div>
                                <div class="col-md-4">
                                    <div class="quick-action-card" onclick="switchToKnowledge()">
                                        <div class="quick-action-icon">
                                            <i class="fas fa-cogs"></i>
                                        </div>
                                        <h5>知識庫管理</h5>
                                        <p class="text-muted">管理問答對和知識庫</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="quick-action-card" onclick="switchTab('conversations')">
                                        <div class="quick-action-icon">
                                            <i class="fas fa-comments"></i>
                                        </div>
                                        <h5>對話管理</h5>
                                        <p class="text-muted">管理客戶對話和回覆</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3">
                                                <i class="fas fa-coins text-warning fa-2x me-3"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">配額餘額</h6>
                                                    <small class="text-muted d-block" id="quotaDisplay">載入中...</small>
                                                    <small class="text-muted" id="planLabel">方案：--</small>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary" onclick="openTopUpModal()">
                                                    <i class="fas fa-wallet me-1"></i>儲值
                                                </button>
                                            </div>
                                            <h3 class="mb-1" id="tokenAvailable">載入中...</h3>
                                            <div class="text-muted small mb-2">儲值餘額：<span id="tokenBonus">0</span> tokens</div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-warning" role="progressbar" id="tokenUsageBar" style="width: 0%"></div>
                                            </div>
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>已用 <span id="tokenUsed">0</span></span>
                                                <span>月額 <span id="tokenAllowance">0</span></span>
                                            </div>
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>對話已用 <span id="conversationUsed">--</span></span>
                                                <span id="conversationLimitDisplay">--</span>
                                            </div>
                        <div class="d-flex justify-content-between small text-muted mb-3">
                                                <span>下次重置 <span id="nextBillingDate">--</span></span>
                                                <span>估每次約 <span id="tokensPerConversation">--</span> tokens</span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-warning flex-grow-1" onclick="openTopUpModal()">
                                                    <i class="fas fa-plus me-1"></i>快速儲值
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='pricing.html'">
                                                    方案升級
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="quick-action-card" onclick="switchToAIAssistant()">
                                        <div class="quick-action-icon">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <h5>AI 助理資訊</h5>
                                        <p class="text-muted">查看 AI 助理狀態和設定</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 圖表和活動 -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="chart-card">
                                        <h5 class="mb-3">用戶活躍度趨勢</h5>
                                        <canvas id="userActivityChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="recent-activity">
                                        <h5 class="mb-3">最近活動</h5>
                                        <div id="activityList">
                                            <!-- 活動項目將在這裡動態生成 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 其他頁面（隱藏） -->
                        <div id="usersPage" class="hidden">
                            <div class="container-fluid p-4">
                                <!-- 頁面標題 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                                                                    <div class="d-flex align-items-center justify-content-between">
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                        <i class="fas fa-user-cog fa-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3 class="mb-1 text-dark">設定</h3>
                                                        <p class="mb-0 text-muted">管理您的帳戶資訊、方案和安全性設定</p>
                                                    </div>
                                                </div>

                                            </div>
                                    </div>
                                </div>

                                <!-- 設定選項 -->
                                <div class="row g-4">
                                    <!-- 帳戶資訊 -->
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm account-setting-card">
                                            <div class="card-body p-4 text-center">
                                                <div class="setting-icon mb-3">
                                                    <i class="fas fa-user fa-2x text-primary"></i>
                                                </div>
                                                <h6 class="card-title fw-bold mb-2">帳戶資訊</h6>
                                                <p class="card-text text-muted small mb-3">查看和編輯您的個人資料</p>
                                                <button class="btn btn-outline-primary btn-sm" onclick="showAccountInfoModal()">
                                                    <i class="fas fa-edit me-1"></i>編輯資料
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 方案管理 -->
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm account-setting-card">
                                            <div class="card-body p-4 text-center">
                                                <div class="setting-icon mb-3">
                                                    <i class="fas fa-crown fa-2x text-warning"></i>
                                                </div>
                                                <h6 class="card-title fw-bold mb-2">方案管理</h6>
                                                <p class="card-text text-muted small mb-3">查看和升級您的訂閱方案</p>
                                                <button class="btn btn-outline-warning btn-sm" onclick="showPlanManagementModal()">
                                                    <i class="fas fa-arrow-up me-1"></i>管理方案
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 更改密碼 -->
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm account-setting-card">
                                            <div class="card-body p-4 text-center">
                                                <div class="setting-icon mb-3">
                                                    <i class="fas fa-lock fa-2x text-success"></i>
                                                </div>
                                                <h6 class="card-title fw-bold mb-2">更改密碼</h6>
                                                <p class="card-text text-muted small mb-3">更新您的帳戶密碼</p>
                                                <button class="btn btn-outline-success btn-sm" onclick="showChangePasswordModal()">
                                                    <i class="fas fa-key me-1"></i>更改密碼
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 安全性設定 -->
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm account-setting-card">
                                            <div class="card-body p-4 text-center">
                                                <div class="setting-icon mb-3">
                                                    <i class="fas fa-shield-alt fa-2x text-info"></i>
                                                </div>
                                                <h6 class="card-title fw-bold mb-2">安全性設定</h6>
                                                <p class="card-text text-muted small mb-3">管理登入和安全性選項</p>
                                                <button class="btn btn-outline-info btn-sm" onclick="showSecuritySettingsModal()">
                                                    <i class="fas fa-cog me-1"></i>安全設定
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 通知設定 -->
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm account-setting-card">
                                            <div class="card-body p-4 text-center">
                                                <div class="setting-icon mb-3">
                                                    <i class="fas fa-bell fa-2x text-secondary"></i>
                                                </div>
                                                <h6 class="card-title fw-bold mb-2">通知設定</h6>
                                                <p class="card-text text-muted small mb-3">管理電子郵件和應用程式通知</p>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="showNotificationSettingsModal()">
                                                    <i class="fas fa-sliders-h me-1"></i>通知設定
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 帳戶刪除 -->
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm account-setting-card">
                                            <div class="card-body p-4 text-center">
                                                <div class="setting-icon mb-3">
                                                    <i class="fas fa-trash-alt fa-2x text-danger"></i>
                                                </div>
                                                <h6 class="card-title fw-bold mb-2">刪除帳戶</h6>
                                                <p class="card-text text-muted small mb-3">永久刪除您的帳戶和所有數據</p>
                                                <button class="btn btn-outline-danger btn-sm" onclick="showDeleteAccountModal()">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>刪除帳戶
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="knowledgePage" class="hidden">
                            <div class="container-fluid p-4">
                                <!-- 頁面標題和導航 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                    <i class="fas fa-database fa-lg"></i>
                                                </div>
                                                <div>
                                                    <h3 class="mb-1 text-dark">知識庫</h3>
                                                    <p class="mb-0 text-muted">管理您的商家資料庫，提供更精準的AI回答</p>
                                                </div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary" onclick="exportKnowledge()">
                                                    <i class="fas fa-download me-1"></i>匯出
                                                </button>
                                                <button class="btn btn-primary" onclick="showAddKnowledgeModal()">
                                                    <i class="fas fa-plus me-1"></i>新增知識
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 導航標籤 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <ul class="nav nav-pills nav-fill rounded-pill p-1" style="max-width: 800px; background-color: #f8f9fa;">
                                            <li class="nav-item">
                                                <a class="nav-link active rounded-pill" id="newKnowledgeTab" href="#" onclick="switchKnowledgeTab('new')">
                                                    <i class="fas fa-plus me-2"></i>新增知識
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link rounded-pill" id="existingKnowledgeTab" href="#" onclick="switchKnowledgeTab('existing')">
                                                    <i class="fas fa-list me-2"></i>現有知識
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link rounded-pill" id="configTab" href="#" onclick="switchKnowledgeTab('config')">
                                                    <i class="fas fa-cog me-2"></i>配置
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- 新增知識內容 -->
                                <div id="newKnowledgeContent">
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="mb-3">從網路匯入</h5>
                                            <div class="row g-3">
                                                <!-- 匯入網址 -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-4">
                                                            <div class="mb-3">
                                                                <i class="fas fa-link fa-3x text-primary"></i>
                                                            </div>
                                                            <h6 class="card-title">匯入網址</h6>
                                                            <p class="card-text text-muted small">從網頁上的文字和連結問答</p>
                                                            <button class="btn btn-outline-primary btn-sm" onclick="showUrlImportModal()">
                                                                <i class="fas fa-link me-1"></i>開始匯入
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 匯入站點地圖 -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-4">
                                                            <div class="mb-3">
                                                                <i class="fas fa-sitemap fa-3x text-info"></i>
                                                            </div>
                                                            <h6 class="card-title">匯入站點地圖</h6>
                                                            <p class="card-text text-muted small">站點地圖 URL 通常是 .xml 文件</p>
                                                            <button class="btn btn-outline-info btn-sm" onclick="showSitemapImportModal()">
                                                                <i class="fas fa-sitemap me-1"></i>開始匯入
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="mb-3">上傳檔案</h5>
                                            <div class="row g-3">
                                                <!-- 上傳試算表 -->
                                                <div class="col-md-3">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-3">
                                                            <div class="mb-2">
                                                                <i class="fas fa-file-excel fa-2x text-success"></i>
                                                            </div>
                                                            <h6 class="card-title small">上傳試算表</h6>
                                                            <p class="card-text text-muted" style="font-size: 0.75rem;">支援 .csv、.xls、.xlsx、.xlsb</p>
                                                            <button class="btn btn-outline-success btn-sm" onclick="showFileUploadModal('spreadsheet')">
                                                                <i class="fas fa-upload me-1"></i>上傳
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 上傳文件 -->
                                                <div class="col-md-3">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-3">
                                                            <div class="mb-2">
                                                                <i class="fas fa-file-alt fa-2x text-warning"></i>
                                                            </div>
                                                            <h6 class="card-title small">上傳文件</h6>
                                                            <p class="card-text text-muted" style="font-size: 0.75rem;">支援 20 多種文件格式</p>
                                                            <button class="btn btn-outline-warning btn-sm" onclick="showFileUploadModal('document')">
                                                                <i class="fas fa-upload me-1"></i>上傳
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 從模版文件上傳 -->
                                                <div class="col-md-3">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-3">
                                                            <div class="mb-2">
                                                                <i class="fas fa-file-csv fa-2x text-primary"></i>
                                                            </div>
                                                            <h6 class="card-title small">從模版文件上傳</h6>
                                                            <p class="card-text text-muted" style="font-size: 0.75rem;">csv 和 json 格式</p>
                                                            <button class="btn btn-outline-primary btn-sm" onclick="showTemplateUploadModal()">
                                                                <i class="fas fa-file-csv me-1"></i>上傳
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 轉錄音訊/視訊 -->
                                                <div class="col-md-3">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-3">
                                                            <div class="mb-2">
                                                                <i class="fas fa-microphone fa-2x text-danger"></i>
                                                            </div>
                                                            <h6 class="card-title small">轉錄音訊/視訊</h6>
                                                            <p class="card-text text-muted" style="font-size: 0.75rem;">長度最多 15 分鐘</p>
                                                            <button class="btn btn-outline-danger btn-sm" onclick="showAudioUploadModal()">
                                                                <i class="fas fa-microphone me-1"></i>上傳
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-12">
                                            <h5 class="mb-3">手動輸入</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card border-0 shadow-sm hover-card">
                                                        <div class="card-body text-center p-4">
                                                            <div class="mb-3">
                                                                <i class="fas fa-edit fa-3x text-secondary"></i>
                                                            </div>
                                                            <h6 class="card-title">編寫新的知識庫文檔</h6>
                                                            <p class="card-text text-muted small">手動輸入新文檔</p>
                                                            <button class="btn btn-outline-secondary btn-sm" onclick="showManualInputModal()">
                                                                <i class="fas fa-edit me-1"></i>開始編寫
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 現有知識內容 -->
                                <div id="existingKnowledgeContent">
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div class="d-flex align-items-center gap-3">
                                                    <h5 class="mb-0">現有知識庫項目</h5>
                                                    <div class="form-check ms-2">
                                                        <input class="form-check-input" type="checkbox" id="knowledgeSelectAll" onclick="toggleSelectAllKnowledge(this.checked)">
                                                        <label class="form-check-label small" for="knowledgeSelectAll">全選</label>
                                                    </div>
                                                    <button class="btn btn-outline-danger btn-sm" id="knowledgeBulkDeleteBtn" onclick="deleteSelectedKnowledge()" disabled>
                                                        <i class="fas fa-trash-alt me-1"></i>刪除已選
                                                    </button>
                                                </div>
                                                <div class="input-group" style="max-width: 400px;">
                                                    <span class="input-group-text bg-light border-end-0">
                                                        <i class="fas fa-search text-muted"></i>
                                                    </span>
                                                    <input type="text" class="form-control border-start-0" placeholder="搜尋知識庫" id="knowledgeSearch">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 知識庫項目列表 -->
                                    <div id="knowledgeList" class="row g-3">
                                        <div class="col-12">
                                            <div class="text-center py-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">載入中...</span>
                                                </div>
                                                <p class="mt-3 text-muted">正在載入知識庫資料...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 知識庫分類統計 -->
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <h6 class="mb-3">分類統計</h6>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <div class="card border-0 shadow-sm">
                                                        <div class="card-body text-center p-3">
                                                            <div class="bg-primary bg-opacity-10 rounded-3 p-3 mb-2">
                                                                <i class="fas fa-folder fa-lg text-primary"></i>
                                                            </div>
                                                            <h6 class="mb-1">全部</h6>
                                                            <small class="text-muted">(<span id="totalCount">0</span> 項目)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="card border-0 shadow-sm">
                                                        <div class="card-body text-center p-3">
                                                            <div class="bg-success bg-opacity-10 rounded-3 p-3 mb-2">
                                                                <i class="fas fa-edit fa-lg text-success"></i>
                                                            </div>
                                                            <h6 class="mb-1">手動輸入</h6>
                                                            <small class="text-muted">(<span id="manualCount">0</span> 項目)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="card border-0 shadow-sm">
                                                        <div class="card-body text-center p-3">
                                                            <div class="bg-warning bg-opacity-10 rounded-3 p-3 mb-2">
                                                                <i class="fas fa-file-upload fa-lg text-warning"></i>
                                                            </div>
                                                            <h6 class="mb-1">上傳檔案</h6>
                                                            <small class="text-muted">(<span id="uploadCount">0</span> 項目)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="card border-0 shadow-sm">
                                                        <div class="card-body text-center p-3">
                                                            <div class="bg-info bg-opacity-10 rounded-3 p-3 mb-2">
                                                                <i class="fas fa-table fa-lg text-info"></i>
                                                            </div>
                                                            <h6 class="mb-1">表格</h6>
                                                            <small class="text-muted">(<span id="tableCount">0</span> 項目)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 配置內容 -->
                                <div id="configContent">
                                    <!-- 知識庫配額概覽 -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body p-4">
                                                    <h5 class="mb-3">知識庫配額概覽</h5>
                                                    <p class="text-muted mb-4">追蹤並優化您和團隊文件和詞元(Tokens)的使用情況</p>
                                                    
                                                    <!-- 文件用量使用情況 -->
                                                    <div class="mb-4">
                                                        <h6 class="mb-3">文件用量使用情況</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span class="fw-bold">13 / 5,000 文件</span>
                                                                </div>
                                                                <div class="progress mb-3" style="height: 8px;">
                                                                    <div class="progress-bar bg-info" style="width: 0.26%"></div>
                                                                </div>
                                                                <div class="d-flex justify-content-between small text-muted">
                                                                    <span><i class="fas fa-circle text-info me-1" style="font-size: 8px;"></i>13/5,000 此助理</span>
                                                                    <span><i class="fas fa-circle text-warning me-1" style="font-size: 8px;"></i>30/5,000 所有助理</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 詞元使用情況 -->
                                                    <div class="mb-4">
                                                        <h6 class="mb-3">詞元使用情況</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span class="fw-bold">911 / 5,000,000 詞元(Tokens)</span>
                                                                </div>
                                                                <div class="progress mb-3" style="height: 8px;">
                                                                    <div class="progress-bar bg-info" style="width: 0.02%"></div>
                                                                </div>
                                                                <div class="d-flex justify-content-between small text-muted">
                                                                    <span><i class="fas fa-circle text-info me-1" style="font-size: 8px;"></i>911/5,000,000 此助理</span>
                                                                    <span><i class="fas fa-circle text-warning me-1" style="font-size: 8px;"></i>3,213/5,000,000 所有助理</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 升級方案 -->
                                                    <div class="row g-3">
                                                        <!-- Free -->
                                                        <div class="col-md-4">
                                                            <div class="card h-100 border">
                                                                <div class="card-body text-center p-4">
                                                                    <div class="mb-3">
                                                                        <span class="badge bg-light text-dark px-3 py-2">Free</span>
                                                                    </div>
                                                                    <h5 class="mb-3">Free</h5>
                                                                    <div class="mb-3">
                                                                        <div class="fw-bold">20 文件</div>
                                                                        <div class="fw-bold">200,000 詞元(Tokens)</div>
                                                                    </div>
                                                                    <button class="btn btn-outline-secondary">選擇方案</button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Premium Monthly -->
                                                        <div class="col-md-4">
                                                            <div class="card h-100 border-warning">
                                                                <div class="card-body text-center p-4">
                                                                    <div class="mb-3">
                                                                        <span class="badge bg-warning text-dark px-3 py-2">Premium - Monthly</span>
                                                                    </div>
                                                                    <h5 class="mb-3">$29.99 / 月</h5>
                                                                    <div class="mb-3">
                                                                        <div class="fw-bold">5,000 文件</div>
                                                                        <div class="fw-bold">5,000,000 詞元(Tokens)</div>
                                                                    </div>
                                                                    <button class="btn btn-warning">當前方案</button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Premium Annual -->
                                                        <div class="col-md-4">
                                                            <div class="card h-100 border-warning">
                                                                <div class="card-body text-center p-4">
                                                                    <div class="mb-3">
                                                                        <span class="badge bg-warning text-dark px-3 py-2">Premium - Annual</span>
                                                                    </div>
                                                                    <h5 class="mb-3">$299 / 年</h5>
                                                                    <div class="mb-3">
                                                                        <div class="fw-bold">5,000 文件</div>
                                                                        <div class="fw-bold">5,000,000 詞元(Tokens)</div>
                                                                    </div>
                                                                    <button class="btn btn-outline-warning">選擇方案</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row g-4">
                                        <!-- 知識庫設定 -->
                                        <div class="col-md-8">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-header bg-gradient-primary text-white border-0">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-cogs me-2"></i>知識庫設定
                                                    </h6>
                                                </div>
                                                <div class="card-body p-4">
                                                    <form id="knowledgeConfigForm">
                                                        <div class="mb-4">
                                                            <label class="form-label fw-bold">
                                                                <i class="fas fa-sync-alt me-2 text-primary"></i>自動更新頻率
                                                            </label>
                                                            <select class="form-select border-2" id="updateFrequency" style="border-radius: 10px;">
                                                                <option value="daily">每日更新</option>
                                                                <option value="weekly" selected>每週更新</option>
                                                                <option value="monthly">每月更新</option>
                                                                <option value="manual">手動更新</option>
                                                            </select>
                                                            <div class="form-text">
                                                                <i class="fas fa-info-circle me-1"></i>
                                                                系統會定期檢查並更新知識庫內容
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-4">
                                                            <label class="form-label fw-bold">
                                                                <i class="fas fa-percentage me-2 text-success"></i>回答相似度閾值
                                                            </label>
                                                            <div class="d-flex align-items-center">
                                                                <input type="range" class="form-range me-3" id="similarityThreshold" min="50" max="100" value="80" oninput="updateThresholdValue(this.value)">
                                                                <span class="badge bg-primary fs-6" id="thresholdValue">80%</span>
                                                            </div>
                                                            <div class="form-text">
                                                                <i class="fas fa-lightbulb me-1"></i>
                                                                設定較高值會使回答更精確，較低值會增加回答範圍
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-4">
                                                            <label class="form-label fw-bold">
                                                                <i class="fas fa-robot me-2 text-info"></i>AI 助理選項
                                                            </label>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="enableAutoResponse" checked>
                                                                <label class="form-check-label" for="enableAutoResponse">
                                                                    啟用智能回答建議
                                                                </label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="enableLearning" checked>
                                                                <label class="form-check-label" for="enableLearning">
                                                                    從對話中學習新知識
                                                                </label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="enableFallback">
                                                                <label class="form-check-label" for="enableFallback">
                                                                    找不到答案時轉接真人客服
                                                                </label>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="d-flex justify-content-between">
                                                            <button type="button" class="btn btn-outline-secondary" id="resetConfigBtn">
                                                                <i class="fas fa-undo me-1"></i>重置為預設值
                                                            </button>
                                                            <button type="submit" class="btn btn-primary">
                                                                <i class="fas fa-save me-1"></i>儲存設定
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 統計資訊 -->
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-header bg-gradient-info text-white border-0">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-chart-pie me-2"></i>知識庫統計
                                                    </h6>
                                                </div>
                                                <div class="card-body p-4">
                                                    <div class="row text-center">
                                                        <div class="col-6 mb-3">
                                                            <div class="border-end">
                                                                <h4 class="text-primary mb-1" id="totalKnowledge">-</h4>
                                                                <small class="text-muted">總知識數</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 mb-3">
                                                            <h4 class="text-success mb-1" id="thisMonthAdded">-</h4>
                                                            <small class="text-muted">本月新增</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <h6 class="small fw-bold mb-2">分類分佈</h6>
                                                        <div id="categoryStats">
                                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                                <small>一般問題</small>
                                                                <span class="badge bg-secondary">-</span>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                                <small>服務相關</small>
                                                                <span class="badge bg-primary">-</span>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                                <small>產品資訊</small>
                                                                <span class="badge bg-success">-</span>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small>其他</small>
                                                                <span class="badge bg-warning">-</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="text-center">
                                                        <button class="btn btn-outline-info btn-sm" onclick="refreshStats()">
                                                            <i class="fas fa-sync-alt me-1"></i>更新統計
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 快速操作 -->
                                            <div class="card border-0 shadow-sm mt-3">
                                                <div class="card-header bg-gradient-success text-white border-0">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-bolt me-2"></i>快速操作
                                                    </h6>
                                                </div>
                                                <div class="card-body p-3">
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-primary btn-sm" onclick="exportKnowledge()">
                                                            <i class="fas fa-download me-1"></i>匯出知識庫
                                                        </button>
                                                        <button class="btn btn-outline-warning btn-sm" onclick="backupKnowledge()">
                                                            <i class="fas fa-shield-alt me-1"></i>備份知識庫
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm" onclick="clearKnowledge()">
                                                            <i class="fas fa-trash me-1"></i>清空知識庫
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="analyticsPage" class="hidden">
                            <div class="text-center py-5">
                                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                <h4>數據分析</h4>
                                <p class="text-muted">點擊下方按鈕前往數據分析頁面</p>
                                <a href="/admin.html" class="btn btn-primary">
                                    <i class="fas fa-arrow-right me-2"></i>前往數據分析
                                </a>
                            </div>
                        </div>
                        
                        <div id="settingsPage" class="hidden">
                            <div class="text-center py-5">
                                <i class="fas fa-cog fa-3x text-muted mb-3"></i>
                                <h4>系統設定</h4>
                                <p class="text-muted">點擊下方按鈕前往系統設定頁面</p>
                                <a href="/admin.html" class="btn btn-primary">
                                    <i class="fas fa-arrow-right me-2"></i>前往系統設定
                                </a>
                            </div>
                        </div>
                        
                        <div id="aiassistantPage" class="hidden">
                            <div class="container-fluid p-4">
                                <!-- 頁面標題 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                    <i class="fas fa-robot fa-lg"></i>
                                                </div>
                                                <div>
                                                    <h3 class="mb-1 text-dark">AI助理配置</h3>
                                                    <p class="mb-0 text-muted">設定您的智能助理，提供個性化的客戶服務體驗</p>
                                                </div>
                                            </div>
                                            <div class="badge bg-success fs-6 px-3 py-2">
                                                <i class="fas fa-check-circle me-1"></i>已啟用
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <!-- 左側配置區域 -->
                                    <div class="col-lg-7">
                                        <div class="card border-0 shadow-lg h-100">
                                            <div class="card-header bg-gradient-primary text-white border-0" style="border-radius: 15px 15px 0 0;">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-cog me-2"></i>
                                                    <h5 class="mb-0">基本設定</h5>
                                                </div>
                                            </div>
                                            <div class="card-body p-4">
                                                <form id="aiAssistantForm">
                                                    <!-- AI助理狀態指示 -->
                                                    <div class="alert alert-success border-0 mb-4" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                                                        <div class="d-flex align-items-center">
                                                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                                                <i class="fas fa-robot"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-1 text-success">AI助理已啟用</h6>
                                                                <small class="text-success-emphasis">您的智能助理正在為客戶提供服務</small>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- AI助理名稱 -->
                                                    <div class="form-floating mb-4">
                                                        <input type="text" class="form-control border-2" id="assistantName" placeholder="設計師 Rainy" value="設計師 Rainy" style="border-radius: 10px;">
                                                        <label for="assistantName"><i class="fas fa-user-tie me-2 text-primary"></i>AI助理名稱 *</label>
                                                        <div class="form-text">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            AI助理的顯示名稱，建議使用親切且專業的稱呼
                                                        </div>
                                                    </div>

                                                    <!-- 大型語言模型 -->
                                                    <div class="mb-4">
                                                        <label for="llmModel" class="form-label fw-bold">
                                                            <i class="fas fa-brain me-2 text-info"></i>大型語言模型（LLM）*
                                                        </label>
                                                        <div class="input-group">
                                                            <select class="form-select border-2" id="llmModel" style="border-radius: 10px 0 0 10px;" onchange="updateModelInfo()">
                                                                <option value="gpt-5.2" selected>GPT-5.2 (推薦)</option>
                                                                <option value="gpt-5.1">GPT-5.1</option>
                                                                <option value="gpt-5.0">GPT-5.0</option>
                                                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                                                <option value="gpt-4.1">GPT-4.1</option>
                                                                <option value="gpt-4.1-nano">GPT-4.1 Nano (極速)</option>
                                                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                                                <option value="gpt-4o">GPT-4o (高級版)</option>
                                                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                                <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16K</option>
                                                            </select>
                                                            <button class="btn btn-outline-secondary border-2" type="button" style="border-radius: 0 10px 10px 0;" onclick="showModelDetails()">
                                                                <i class="fas fa-info-circle"></i>
                                                            </button>
                                                        </div>
                                                        <div class="mt-2">
                                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="showModelComparison()">
                                                                <i class="fas fa-balance-scale me-2"></i>比較模型
                                                            </button>
                                                        </div>
                                                        <div id="modelInfo" class="form-text mt-2">
                                                            <i class="fas fa-star me-1 text-warning"></i>
                                                            <span id="modelDescription">GPT-4o Mini 提供快速且經濟實惠的對話體驗</span>
                                                        </div>
                                                        <div class="form-text">
                                                            <i class="fas fa-star me-1 text-warning"></i>
                                                            GPT-4o 系列模型提供更優質的對話體驗
                                                        </div>
                                                    </div>

                                                    <!-- 使用場景 -->
                                                    <div class="form-floating mb-4">
                                                        <select class="form-select border-2" id="useCase" style="border-radius: 10px;">
                                                            <option value="customer-service" selected>客戶服務 (Customer Service)</option>
                                                            <option value="sales-assistant">銷售助理 (Sales Assistant)</option>
                                                            <option value="technical-support">技術支援 (Technical Support)</option>
                                                            <option value="general-assistant">一般助理 (General Assistant)</option>
                                                        </select>
                                                        <label for="useCase"><i class="fas fa-briefcase me-2 text-warning"></i>使用場景 *</label>
                                                        <div class="form-text">
                                                            <i class="fas fa-lightbulb me-1"></i>
                                                            選擇最符合您業務需求的應用場景
                                                        </div>
                                                    </div>

                                                    <!-- 描述區域 -->
                                                    <div class="mb-4">
                                                        <label for="aiDescription" class="form-label fw-bold">
                                                            <i class="fas fa-edit me-2 text-success"></i>助理描述與指令
                                                        </label>
                                                        <textarea class="form-control border-2" id="aiDescription" rows="8" style="border-radius: 10px; font-family: 'Courier New', monospace;" placeholder="請輸入助理的詳細描述...">CONTEXT(情境):
你是美髮設計師 Rainy 的助理，協助客戶預約的和提供相關美髮資訊

OBJECTIVE(目標任務):
你的目標是客戶服務與美容美髮發行錄，創造一個良好的對話體驗，讓客戶感到舒適，願意分享他們的真實想法及需求。

STYLE(風格/個性):
你的個性是很健談並且很直率人保學會存在，樂於創造一個放鬆和友好的氣圍。

TONE(語調):
親性、溫柔、深情人心。</textarea>
                                                        <div class="form-text">
                                                            <i class="fas fa-code me-1"></i>
                                                            包含 CONTEXT(情境)、OBJECTIVE(目標)、STYLE(風格)、TONE(語調) 等設定
                                                        </div>
                                                    </div>

                                                    <!-- 操作按鈕 -->
                                                    <div class="d-flex justify-content-between">
                                                        <button type="button" class="btn btn-outline-secondary btn-lg px-4" style="border-radius: 25px;">
                                                            <i class="fas fa-undo me-2"></i>重置
                                                        </button>
                                                        <button type="submit" class="btn btn-primary btn-lg px-5" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border: none; border-radius: 25px;">
                                                            <i class="fas fa-save me-2"></i>儲存設定
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 右側聊天測試區域 -->
                                    <div class="col-lg-5">
                                        <div class="card border-0 shadow-lg h-100">
                                            <div class="card-header bg-gradient-success text-white border-0" style="border-radius: 15px 15px 0 0;">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-comments me-2"></i>
                                                        <h5 class="mb-0">AI 聊天測試</h5>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="form-check form-switch me-3">
                                                            <input class="form-check-input" type="checkbox" id="knowledgeOnlyToggle">
                                                            <label class="form-check-label" for="knowledgeOnlyToggle">僅用知識庫</label>
                                                        </div>
                                                        <button class="btn btn-sm btn-outline-light me-2" id="clearChatBtn" title="清除對話">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-light" id="refreshChatBtn" title="重新開始">
                                                            <i class="fas fa-redo"></i>
                                                        </button>
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="text-center mb-3">
                                                    <div class="badge bg-success-subtle text-success fs-6 px-3 py-2 mb-2">
                                                        <i class="fas fa-check-circle me-1"></i>測試模式
                                                    </div>
                                                    <h6 class="text-dark">即時測試您的 AI 助理配置</h6>
                                                </div>
                                                
                                                <!-- 實際聊天界面 -->
                                                <div class="position-relative border-0 shadow-sm rounded-4 p-3" style="height: calc(100vh - 200px); background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                                    <!-- 聊天頭部 -->
                                                    <div class="d-flex align-items-center mb-3 p-3 text-white rounded-3" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                                                        <div class="me-3">
                                                            <div class="bg-white bg-opacity-25 rounded-circle p-2" style="width: 40px; height: 40px;">
                                                                <i class="fas fa-robot text-white"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <strong id="previewAssistantName" class="fs-6">設計師 Rainy</strong>
                                                            <div class="small opacity-75">
                                                                <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                                                                測試模式
                                                                <span class="ms-2 badge bg-warning text-dark">
                                                                    <i class="fas fa-flask me-1"></i>測試中
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 聊天訊息容器 -->
                                                    <div id="chatMessagesContainer" class="chat-messages px-2" style="height: calc(100vh - 300px); overflow-y: auto; padding-bottom: 96px; scroll-padding-bottom: 96px;">
                                                        <!-- 歡迎訊息 -->
                                                        <div class="d-flex align-items-start mb-3" id="welcomeMessage">
                                                            <div class="me-2">
                                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                                    <i class="fas fa-robot text-white" style="font-size: 12px;"></i>
                                                                </div>
                                                            </div>
                                                            <div class="bg-white p-3 rounded-3 shadow-sm" style="max-width: 80%; border-radius: 15px 15px 15px 5px !important;">
                                                                <span id="previewMessage" class="text-dark">你好，有甚麼可以幫您的嗎？</span>
                                                                <div class="small text-muted mt-1">
                                                                    <i class="fas fa-clock me-1"></i>剛剛
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 輸入框 -->
                                                    <div class="position-absolute bottom-0 start-0 end-0 p-3">
                                                        <div class="input-group shadow-sm">
                                                            <input type="text" class="form-control border-0" id="chatInput" placeholder="輸入訊息..." style="border-radius: 25px 0 0 25px; background-color: white;">
                                                            <button class="btn btn-primary border-0" id="sendMessageBtnTest" style="border-radius: 0 25px 25px 0; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                                                                <i class="fas fa-paper-plane"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mt-3 text-center">
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        最後更新：<span id="lastUpdateTime">剛剛</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="channelPage" class="hidden">
                            <div class="container-fluid p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h3 class="mb-1">頻道</h3>
                                        <div class="text-muted small">將您的社群客服帳號串接到本系統，集中管理訊息</div>
                                    </div>
                                    <button class="btn btn-primary" onclick="showAddChannelModal()"><i class="fas fa-plus me-2"></i>新增頻道</button>
                                </div>

                                <div class="row g-3 mb-4">
                                  <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-center" role="alert">
                                      <i class="fas fa-lightbulb me-2"></i>
                                      <div>
                                        串接流程：
                                        <ol class="mb-0 ps-3">
                                          <li>到各平台申請並取得 Token/Secret。</li>
                                          <li>在此點「新增頻道」填入憑證。</li>
                                          <li>複製專屬 Webhook URL 貼回平台後台。</li>
                                        </ol>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <div id="channelList" class="row g-3">
                                    <!-- 將由 JS 載入 /api/channels 結果渲染 -->
                                </div>
                            </div>
                        </div>
            </div>
        </div>

        <!-- LINE Bot 管理模態框 -->
        <div class="modal fade" id="lineBotManagerModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                        <h5 class="modal-title"><i class="fab fa-line me-2"></i>LINE Bot 管理</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                        <!-- Bot 列表 -->
                        <div class="row mb-4" id="botListContainer">
                            <!-- Bot 卡片將在這裡動態生成 -->
                        </div>
                        
                        <!-- 創建新 Bot 按鈕 -->
                        <div class="text-center mb-4">
                            <button class="btn btn-primary" onclick="showCreateBotForm()">
                                <i class="fas fa-plus me-2"></i>創建新 LINE Bot
                            </button>
                        </div>
                        
                        <!-- 創建 Bot 表單 -->
                        <div id="createBotForm" style="display: none;">
                            <hr>
                            <h6><i class="fas fa-robot me-2"></i>創建新 LINE Bot</h6>
                            <form id="createBotFormElement">
                                <div class="row">
                                    <div class="col-md-6">
                  <div class="mb-3">
                                            <label for="botName" class="form-label">Bot 名稱 *</label>
                                            <input type="text" class="form-control" id="botName" 
                                                   placeholder="例如：客服 Bot" required>
                  </div>
                                    </div>
                                    <div class="col-md-6">
                  <div class="mb-3">
                                            <label for="channelId" class="form-label">Channel ID</label>
                                            <input type="text" class="form-control" id="channelId" 
                                                   placeholder="可選，用於識別">
                  </div>
                                    </div>
                                </div>
                                
                  <div class="mb-3">
                                    <label for="botDescription" class="form-label">Bot 描述</label>
                                    <textarea class="form-control" id="botDescription" rows="2" 
                                              placeholder="描述這個 Bot 的用途和功能"></textarea>
                  </div>
                                
                                <div class="mb-3">
                                    <label for="channelAccessToken" class="form-label">Channel Access Token *</label>
                                    <input type="text" class="form-control" id="channelAccessToken" 
                                           placeholder="請貼上您的 Channel Access Token" required>
                                    <small class="form-text text-muted">從 LINE Developers Console 取得</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="channelSecret" class="form-label">Channel Secret *</label>
                                    <input type="text" class="form-control" id="channelSecret" 
                                           placeholder="請貼上您的 Channel Secret" required>
                                    <small class="form-text text-muted">從 LINE Developers Console 取得</small>
                                </div>
                                
                                <div id="createBotAlert"></div>
                                
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary" onclick="hideCreateBotForm()">取消</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>創建 Bot
                                    </button>
                                </div>
                </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="topUpModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-wallet me-2 text-primary"></i>帳戶儲值</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small mb-3">選擇合適的加值方案，額度將立即加入儲值餘額，供客服使用。</p>
                        <div class="row g-3" id="topUpPackageList">
                            <div class="col-12 text-center text-muted py-4">載入中...</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="submitTopUp()">
                            <i class="fas fa-check me-1"></i>確認儲值
                        </button>
              </div>
            </div>
          </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="knowledge-fix.js"></script>
        <script>
            async function renderPlansContent() {
                const container = document.getElementById('plansContent');
                if (!container) return;
                const token = localStorage.getItem('token');
                const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                let tokenInfo = null;
                try {
                    const r = await fetch(`${baseUrl}/ai-assistant-config`, { headers: { 'Authorization': `Bearer ${token}` }});
                    const d = await r.json(); tokenInfo = d && d.token ? d.token : null;
                } catch {}
                const planKey = tokenInfo ? String(tokenInfo.plan||'free').toLowerCase() : 'free';
                const planName = planKey === 'enterprise' ? '企業版' : (planKey === 'premium' ? '尊榮版' : '免費版');
                container.innerHTML = `
                  <div class="row g-4">
                    <div class="col-12">
                      <div class="card border-0 shadow-sm">
                        <div class="card-body d-flex align-items-center justify-content-between">
                          <div>
                            <div class="text-muted small">目前方案</div>
                            <div class="fs-5"><span class="badge ${tokenInfo && tokenInfo.plan==='premium' ? 'bg-success' : tokenInfo && tokenInfo.plan==='enterprise' ? 'bg-danger' : 'bg-secondary'}">${planName}</span></div>
                          </div>
                          <div class="text-end">
                            <div class="text-muted small">本月已用 / 額度</div>
                            <div class="fs-5">${tokenInfo ? (tokenInfo.used_in_cycle||0).toLocaleString() : '-'} / ${tokenInfo ? (tokenInfo.allowance||0).toLocaleString() : '-'}</div>
                          </div>
                          <div class="text-end">
                            <div class="text-muted small">儲值餘額</div>
                            <div class="fs-5 text-warning">${tokenInfo ? (tokenInfo.bonus_balance||0).toLocaleString() : '-'}</div>
                          </div>
                          <div class="text-end">
                            <div class="text-muted small">下次重置</div>
                            <div class="fs-6">${tokenInfo && tokenInfo.next_billing_at ? new Date(tokenInfo.next_billing_at).toLocaleDateString() : '-'}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-6">
                      <div class="card border-0 shadow-sm h-100"><div class="card-body">
                        <h6 class="mb-3">快速儲值</h6>
                        <div class="d-grid gap-2">
                          <button class="btn btn-outline-warning" data-topup="10000|100">10,000 Tokens（NT$100）</button>
                          <button class="btn btn-outline-warning" data-topup="50000|450">50,000 Tokens（NT$450）</button>
                          <button class="btn btn-outline-warning" data-topup="100000|800">100,000 Tokens（NT$800）</button>
                        </div>
                      </div></div>
                    </div>
                    <div class="col-lg-6">
                      <div class="card border-0 shadow-sm h-100"><div class="card-body d-flex flex-column">
                        ${planKey==='free' ? `
                          <h6 class="mb-3">升級尊榮版</h6>
                          <p class="text-muted small mb-3">升級可獲更高每月額度與優先服務</p>
                          <div class="mt-auto">
                            <button class="btn btn-warning w-100" id="upgradePlanBtn"><i class="fas fa-arrow-up me-1"></i>升級尊榮版</button>
                          </div>
                        ` : `
                          <h6 class="mb-3">訂閱管理</h6>
                          <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary" id="changePaymentBtn"><i class="fas fa-credit-card me-1"></i>更改付款方式</button>
                            <button class="btn btn-outline-danger" id="cancelSubBtn"><i class="fas fa-ban me-1"></i>取消訂閱（到期後生效）</button>
                          </div>
                          <small class="text-muted mt-2">取消後，會於到期日結束會籍。</small>
                        `}
                      </div></div>
                    </div>
                  </div>`;

                container.querySelectorAll('[data-topup]').forEach(btn=>{
                  btn.addEventListener('click', async()=>{
                    const [t,a]=btn.getAttribute('data-topup').split('|');
                    await startTopup(parseInt(t,10), parseInt(a,10));
                  });
                });
                const up = container.querySelector('#upgradePlanBtn');
                up && up.addEventListener('click', async()=>{ await startUpgrade(); });
                const cancelBtn = container.querySelector('#cancelSubBtn');
                cancelBtn && cancelBtn.addEventListener('click', async(e)=>{ e.preventDefault(); await showRetentionDialog(); });
                const changeBtn = container.querySelector('#changePaymentBtn');
                changeBtn && changeBtn.addEventListener('click', async(e)=>{ e.preventDefault(); await changePaymentMethod(); });
            }

            async function startTopup(tokens, amount) {
                try {
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/upgrade`, { method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body: JSON.stringify({ type:'topup', tokens, amount })});
                    const data = await resp.json();
                    if (resp.ok && data.success && data.action && data.params) {
                        const form=document.createElement('form'); form.method='POST'; form.action=data.action;
                        Object.entries(data.params).forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; form.appendChild(i); });
                        document.body.appendChild(form); form.submit();
                    } else { showAlert(data.error || '建立訂單失敗','danger'); }
                } catch { showAlert('建立訂單失敗','danger'); }
            }

            async function startUpgrade() {
                try {
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/upgrade`, { method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body: JSON.stringify({ type:'plan' })});
                    const data = await resp.json();
                    if (resp.ok && data.success && data.action && data.params) {
                        const form=document.createElement('form'); form.method='POST'; form.action=data.action;
                        Object.entries(data.params).forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; form.appendChild(i); });
                        document.body.appendChild(form); form.submit();
                    } else { showAlert(data.error || '建立訂單失敗','danger'); }
                } catch { showAlert('建立訂單失敗','danger'); }
            }

            async function cancelSubscription(){
                try {
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/subscription/cancel`, { method:'POST', headers:{'Authorization':`Bearer ${token}`}});
                    const data = await resp.json();
                    if (resp.ok && data.success) { showAlert('已設定於週期結束後取消訂閱','success'); renderPlansContent(); }
                    else { showAlert(data.error || '取消訂閱失敗','danger'); }
                } catch { showAlert('取消訂閱失敗','danger'); }
            }

            async function showRetentionDialog(){
                const modalHtml = `
                  <div class="modal fade" id="retentionModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content overflow-hidden" style="border: none; border-radius: 18px;">
                        <div class="position-absolute w-100 h-100" style="background: radial-gradient(120% 120% at 0% 0%, rgba(255,223,186,0.25), rgba(255,255,255,0.9)); pointer-events:none;"></div>
                        <div class="modal-header border-0" style="background: linear-gradient(135deg,#ffe08a,#ffd166);">
                          <h5 class="modal-title d-flex align-items-center text-dark">
                            <i class="fas fa-face-sad-tear me-2"></i> 我們真的很捨不得您離開
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <div class="text-center mb-3">
                            <i class="fas fa-hand-holding-heart fa-2x text-warning mb-2"></i>
                            <div class="fw-bold">只要再給我們一次機會</div>
                            <div class="text-muted">下個月我們提供<strong class="text-danger">9 折</strong>的專屬心意（僅一次）</div>
                          </div>
                          <div class="p-3 rounded-3 mb-3" style="background: rgba(255, 214, 102, 0.15);">
                            <div class="small text-muted">保留訂閱將立即套用此優惠，方案內容不變且不影響使用</div>
                          </div>
                          <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary flex-fill" id="retentionAccept">
                              <i class="fas fa-badge-percent me-1"></i>保留並套用 9 折
                            </button>
                            <button type="button" class="btn btn-outline-danger flex-fill" id="retentionDecline">
                              <i class="fas fa-ban me-1"></i>仍要取消
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>`;
                const old = document.getElementById('retentionModal'); if (old) old.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const m = new bootstrap.Modal(document.getElementById('retentionModal')); m.show();
                document.getElementById('retentionAccept').onclick = async()=>{
                    try {
                        const token = localStorage.getItem('token');
                        const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                        const r = await fetch(`${baseUrl}/subscription/retention-offer`, { method:'POST', headers:{'Authorization':`Bearer ${token}`}});
                        const d = await r.json();
                        if (r.ok && d.success) { showAlert('已套用9折優惠（僅下期一次）','success'); m.hide(); }
                        else showAlert(d.error||'套用優惠失敗','danger');
                    } catch { showAlert('套用優惠失敗','danger'); }
                };
                document.getElementById('retentionDecline').onclick = async()=>{
                    m.hide();
                    // 二次確認並填寫原因
                    const promptHtml = `
                      <div class="modal fade" id="cancelReasonModal" tabindex="-1">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header"><h5 class="modal-title">取消訂閱</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                            <div class="modal-body">
                              <label class="form-label">取消原因（選填）</label>
                              <textarea class="form-control" id="cancelReason" rows="3" placeholder="告訴我們原因，以便改善服務"></textarea>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回</button>
                              <button type="button" class="btn btn-danger" id="confirmCancelNow">確認取消</button>
                            </div>
                          </div>
                        </div>
                      </div>`;
                    const exist = document.getElementById('cancelReasonModal'); if (exist) exist.remove();
                    document.body.insertAdjacentHTML('beforeend', promptHtml);
                    const cm = new bootstrap.Modal(document.getElementById('cancelReasonModal')); cm.show();
                    document.getElementById('confirmCancelNow').onclick = async()=>{
                        const reason = (document.getElementById('cancelReason').value||'').trim();
                        try {
                            const token = localStorage.getItem('token');
                            const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                            await fetch(`${baseUrl}/subscription/cancel-feedback`, { method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body: JSON.stringify({ reason })});
                        } catch {}
                        await cancelSubscription();
                        cm.hide();
                    };
                };
            }

            async function changePaymentMethod(){
                try {
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/subscription/payment-method`, { method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body: JSON.stringify({ method:'Credit' })});
                    const data = await resp.json();
                    if (resp.ok && data.success) showAlert('付款方式已更新','success');
                    else showAlert(data.error || '更新付款方式失敗','danger');
                } catch { showAlert('更新付款方式失敗','danger'); }
            }
            // 右側面板：方案與儲值（在 AI 助理頁右側卡片 body 顯示）
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'openPlansPanelBtn') openPlansPanel();
            });

            async function openPlansPanel() {
                const aiPage = document.getElementById('aiassistantPage');
                if (aiPage) aiPage.classList.remove('hidden');
                const container = document.querySelector('#aiassistantPage .col-lg-5 .card-body');
                if (!container) return;
                const token = localStorage.getItem('token');
                const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                let tokenInfo = null;
                try {
                    const r = await fetch(`${baseUrl}/ai-assistant-config`, { headers: { 'Authorization': `Bearer ${token}` }});
                    const d = await r.json(); tokenInfo = d && d.token ? d.token : null;
                } catch {}
                container.innerHTML = `
                  <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light d-flex align-items-center">
                      <i class="fas fa-crown text-warning me-2"></i>
                      <strong>方案與儲值</strong>
                    </div>
                    <div class="card-body">
                      <div class="p-3 rounded bg-warning bg-opacity-10 mb-3">
                        <div>方案：${tokenInfo ? tokenInfo.plan : '-'}</div>
                        <div>本月額度：${tokenInfo ? (tokenInfo.allowance||0).toLocaleString() : '-'}</div>
                        <div>已用：${tokenInfo ? (tokenInfo.used_in_cycle||0).toLocaleString() : '-'}</div>
                        <div>儲值餘額：${tokenInfo ? (tokenInfo.bonus_balance||0).toLocaleString() : '-'}</div>
                        <div>下次重置：${tokenInfo && tokenInfo.next_billing_at ? new Date(tokenInfo.next_billing_at).toLocaleString() : '-'}</div>
                      </div>
                      <div class="row g-2 mb-3">
                        <div class="col-12"><h6 class="mb-2">儲值 Tokens</h6></div>
                        <div class="col-12 d-grid gap-2">
                          <button class="btn btn-outline-warning" data-topup="10000|100">10,000 Tokens（NT$100）</button>
                          <button class="btn btn-outline-warning" data-topup="50000|450">50,000 Tokens（NT$450）</button>
                          <button class="btn btn-outline-warning" data-topup="100000|800">100,000 Tokens（NT$800）</button>
                        </div>
                      </div>
                      <h6 class="mb-2">升級方案</h6>
                      <button class="btn btn-warning" id="upgradePlanBtn"><i class="fas fa-arrow-up me-1"></i>升級尊榮版</button>
                    </div>
                  </div>`;

                container.querySelectorAll('[data-topup]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const [tokensStr, amountStr] = btn.getAttribute('data-topup').split('|');
                        await startTopup(parseInt(tokensStr,10), parseInt(amountStr,10));
                    });
                });
                const upBtn = container.querySelector('#upgradePlanBtn');
                upBtn && upBtn.addEventListener('click', async () => { await startUpgrade(); });
            }

            async function startTopup(tokens, amount) {
                try {
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/upgrade`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'topup', tokens, amount })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.success && data.action && data.params) {
                        const form = document.createElement('form'); form.method='POST'; form.action=data.action;
                        Object.entries(data.params).forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; form.appendChild(i); });
                        document.body.appendChild(form); form.submit();
                    } else { showAlert(data.error || '建立訂單失敗', 'danger'); }
                } catch { showAlert('建立訂單失敗', 'danger'); }
            }

            async function startUpgrade() {
                try {
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/upgrade`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'plan' })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.success && data.action && data.params) {
                        const form = document.createElement('form'); form.method='POST'; form.action=data.action;
                        Object.entries(data.params).forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; form.appendChild(i); });
                        document.body.appendChild(form); form.submit();
                    } else { showAlert(data.error || '建立訂單失敗', 'danger'); }
                } catch { showAlert('建立訂單失敗', 'danger'); }
            }
            // 取消彈窗儲值，改為右側面板（openPlansPanel）
            // 顯示提示訊息函數
            function showAlert(message, type = 'info') {
                const alertContainer = document.getElementById('alertContainer') || createAlertContainer();
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                alertContainer.appendChild(alertDiv);
                
                // 自動消失
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            // 創建提示訊息容器
            function createAlertContainer() {
                const container = document.createElement('div');
                container.id = 'alertContainer';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
                return container;
            }
            
            // 知識庫標籤切換功能
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM 載入完成，初始化標籤切換功能');
                
                // 為標籤添加點擊事件
                const tabs = [
                    { id: 'newKnowledgeTab', content: 'newKnowledgeContent', type: 'new' },
                    { id: 'existingKnowledgeTab', content: 'existingKnowledgeContent', type: 'existing' },
                    { id: 'configTab', content: 'configContent', type: 'config' }
                ];
                
                tabs.forEach(tab => {
                    const tabElement = document.getElementById(tab.id);
                    if (tabElement) {
                        console.log('找到標籤:', tab.id);
                        tabElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('點擊標籤:', tab.id);
                            switchKnowledgeTab(tab.type);
                        });

// 根據方案更換左側 Logo 圖示
(async () => {
  try {
    const icon = document.getElementById('planIcon');
    const entryIcon = document.getElementById('plansEntryIcon');
    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
    if (!token) return;
    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
    const res = await fetch(`${baseUrl}/me`, { headers: { 'Authorization': `Bearer ${token}` }});
    const data = await res.json();
    const plan = (data && data.user && data.user.plan) ? data.user.plan.toLowerCase() : 'free';
    if (icon) icon.className = 'fas me-2 ' + (plan === 'premium' ? 'fa-crown text-warning' : plan === 'enterprise' ? 'fa-building text-info' : 'fa-user-circle text-white');
    if (entryIcon) entryIcon.className = 'fas ' + (plan === 'premium' ? 'fa-crown text-warning' : plan === 'enterprise' ? 'fa-building text-info' : 'fa-user-circle text-white');
  } catch {}
})();
                    } else {
                        console.log('未找到標籤:', tab.id);
                    }
                });
                
                // 初始化顯示
                console.log('初始化顯示新增知識內容');
                switchKnowledgeTab('new');
            });
            
            // 切換知識庫標籤
            function switchKnowledgeTab(tab) {
                console.log('切換到標籤:', tab);
                
                // 定義標籤和內容的對應關係
                const tabConfig = {
                    'new': { tabId: 'newKnowledgeTab', contentId: 'newKnowledgeContent' },
                    'existing': { tabId: 'existingKnowledgeTab', contentId: 'existingKnowledgeContent' },
                    'config': { tabId: 'configTab', contentId: 'configContent' }
                };
                
                const config = tabConfig[tab];
                if (!config) {
                    console.error('未知的標籤類型:', tab);
                    return;
                }
                
                // 重置所有標籤樣式
                Object.values(tabConfig).forEach(({ tabId }) => {
                    const tabElement = document.getElementById(tabId);
                    if (tabElement) {
                        tabElement.style.background = 'transparent';
                        tabElement.style.color = 'white';
                        tabElement.style.borderColor = 'transparent';
                        tabElement.classList.remove('active');
                    }
                });
                
                // 隱藏所有內容
                Object.values(tabConfig).forEach(({ contentId }) => {
                    const contentElement = document.getElementById(contentId);
                    if (contentElement) {
                        contentElement.style.display = 'none';
                        contentElement.classList.remove('hidden');
                        contentElement.classList.remove('force-show');
                    }
                });
                
                // 激活選中的標籤
                const selectedTab = document.getElementById(config.tabId);
                if (selectedTab) {
                    selectedTab.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                    selectedTab.style.color = 'white';
                    selectedTab.style.borderColor = '#007bff';
                    selectedTab.classList.add('active');
                }
                
                // 顯示對應內容
                const selectedContent = document.getElementById(config.contentId);
                if (selectedContent) {
                    selectedContent.style.display = 'block';
                    console.log('顯示內容:', config.contentId);
                } else {
                    console.error('未找到內容元素:', config.contentId);
                }
                
                // 如果是現有知識標籤，載入資料
                if (tab === 'existing' && typeof loadKnowledgeData === 'function') {
                    console.log('載入知識庫資料');
                    setTimeout(loadKnowledgeData, 100);
                }
            }
            
            // 頁面載入時初始化知識庫標籤
            document.addEventListener('DOMContentLoaded', function() {
                // 確保預設顯示新增知識內容
                const newKnowledgeContent = document.getElementById('newKnowledgeContent');
                if (newKnowledgeContent) {
                    newKnowledgeContent.style.display = 'block';
                    newKnowledgeContent.classList.remove('hidden');
                }
                
                // 隱藏其他內容
                const existingKnowledgeContent = document.getElementById('existingKnowledgeContent');
                const configContent = document.getElementById('configContent');
                
                if (existingKnowledgeContent) {
                    existingKnowledgeContent.style.display = 'none';
                    existingKnowledgeContent.classList.remove('hidden');
                }
                
                if (configContent) {
                    configContent.style.display = 'none';
                    configContent.classList.remove('hidden');
                }
                
                // 初始化深色模式
                initDarkMode();
            });
        </script>

        <!-- 新增/編輯 知識庫 Modal（全局放置，供知識庫頁面使用） -->
        <div class="modal fade" id="knowledgeEditModal" tabindex="-1" aria-labelledby="knowledgeEditModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="knowledgeEditModalLabel">新增知識</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="knowledgeForm">
                            <input type="hidden" id="knowledgeId">
                            <div class="mb-3">
                                <label for="knowledgeQuestion" class="form-label">問題/標題</label>
                                <input type="text" class="form-control" id="knowledgeQuestion" placeholder="輸入問題或標題" required>
                            </div>
                            <div class="mb-3">
                                <label for="knowledgeAnswer" class="form-label">答案/內容</label>
                                <textarea class="form-control" id="knowledgeAnswer" rows="6" placeholder="輸入答案或內容" required></textarea>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="knowledgeCategory" class="form-label">分類</label>
                                    <select id="knowledgeCategory" class="form-select">
                                        <option value="一般">一般</option>
                                        <option value="手動">手動</option>
                                        <option value="上傳">上傳</option>
                                        <option value="網頁">網頁</option>
                                        <option value="faq">常見問題</option>
                                        <option value="policy">政策</option>
                                        <option value="guide">使用指南</option>
                                        <option value="payment">付款</option>
                                        <option value="order">訂單</option>
                                        <option value="shipping">運送</option>
                                        <option value="support">客服支援</option>
                                        <option value="warranty">保固</option>
                                        <option value="repair">維修</option>
                                        <option value="return">退換貨</option>
                                        <option value="booking">預約</option>
                                        <option value="cancel">取消</option>
                                        <option value="timing">時間安排</option>
                                        <option value="pricing">價格</option>
                                        <option value="features">產品特色</option>
                                        <option value="specs">規格</option>
                                        <option value="usage">使用方法</option>
                                        <option value="target">適用對象</option>
                                        <option value="join">加入會員</option>
                                        <option value="benefits">會員福利</option>
                                        <option value="points">點數</option>
                                        <option value="level">會員等級</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="knowledgeTags" class="form-label">標籤（以逗號分隔）</label>
                                    <input type="text" id="knowledgeTags" class="form-control" placeholder="例如：faq,policy">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="knowledgeSubmitBtn" onclick="submitKnowledgeModal()">儲存</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
                                    // 身份驗證檢查 - 修復版本
            function checkAuthentication() {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                console.log('🔍 檢查身份驗證, token:', token ? '存在' : '不存在');
                
                if (!token) {
                    console.log('❌ 沒有 token，延遲 1 秒後跳轉到登入頁');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 1000);
                    return false;
                }
                
                console.log('🔄 開始驗證 token...');
                
                // 使用完整的API URL進行驗證
                const apiUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                const verifyUrl = `${apiUrl}/me`;
                
                console.log('📍 驗證 URL:', verifyUrl);
                
                // 驗證 token 是否有效
                fetch(verifyUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                }).then(response => {
                    console.log('📡 API 回應狀態:', response.status);
                    
                    if (!response.ok) {
                        console.log('❌ Token 驗證失敗，狀態:', response.status);
                        
                        // 如果是 401 或 403，清除 token 並跳轉
                        if (response.status === 401 || response.status === 403) {
                            console.log('🗑️ 清除無效 token');
                            localStorage.removeItem('token');
                            localStorage.removeItem('authToken');
                            setTimeout(() => {
                                window.location.href = '/login.html';
                            }, 1500);
                        } else {
                            console.log('⚠️ 其他錯誤，但不跳轉，繼續使用');
                        }
                    } else {
                        console.log('✅ Token 驗證成功');
                        return response.json();
                    }
                }).then(data => {
                    if (data && data.user) {
                        console.log('👤 用戶資訊更新:', data.user.name);
                        
                        // 更新用戶資訊顯示
                        const userInfo = document.getElementById('userInfo');
                        if (userInfo) {
                            userInfo.textContent = `${data.user.name} (${data.user.role})`;
                        }
                        
                        // 更新 localStorage
                        localStorage.setItem('staffName', data.user.name);
                        localStorage.setItem('staffRole', data.user.role);
                        localStorage.setItem('staffUsername', data.user.username);
                        localStorage.setItem('staffId', data.user.id.toString());
                        
                        console.log('🎉 身份驗證完成，用戶可以正常使用');
                    }
                }).catch(error => {
                    console.error('❌ 驗證過程發生錯誤:', error);
                    
                    // 網路錯誤不應該清除 token，可能只是暫時的連接問題
                    console.log('⚠️ 網路錯誤，保留 token，允許離線使用');
                    
                    // 設置基本的用戶資訊（從 localStorage 恢復）
                    const staffName = localStorage.getItem('staffName') || '系統管理員';
                    const staffRole = localStorage.getItem('staffRole') || 'admin';
                    const userInfo = document.getElementById('userInfo');
                    if (userInfo) {
                        userInfo.textContent = `${staffName} (${staffRole}) - 離線模式`;
                    }
                });
                
                return true;
            }
            
            // 延遲執行身份驗證檢查，確保頁面完全載入
            setTimeout(() => {
                console.log('⏰ 開始執行身份驗證檢查...');
                checkAuthentication();
            }, 500);
        </script>
        <script>
            const DASHBOARD_API_BASE = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api'))
                ? window.API_BASE_URL
                : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
            let topUpPackagesCache = [];
            let selectedTopUpPackageId = null;

            // 切換頁面
            function switchTab(tab) {
                // 隱藏所有頁面
                document.getElementById('dashboardPage').classList.add('hidden');
                document.getElementById('usersPage').classList.add('hidden');
                document.getElementById('knowledgePage').classList.add('hidden');
                document.getElementById('analyticsPage').classList.add('hidden');
                document.getElementById('settingsPage').classList.add('hidden');
                document.getElementById('aiassistantPage').classList.add('hidden');
                // 新增子頁面
                if(document.getElementById('channelPage')) document.getElementById('channelPage').classList.add('hidden');
                if(document.getElementById('casesPage')) document.getElementById('casesPage').classList.add('hidden');
                if(document.getElementById('integrationPage')) document.getElementById('integrationPage').classList.add('hidden');
                if(document.getElementById('conversationsPage')) document.getElementById('conversationsPage').classList.add('hidden');
                if(document.getElementById('plansPage')) document.getElementById('plansPage').classList.add('hidden');
                
                // 移除所有導航連結的 active 狀態
                document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                // 顯示選中的頁面並設定對應的 active 狀態
                if (tab === 'dashboard') {
                    document.getElementById('dashboardPage').classList.remove('hidden');
                    document.querySelector('[data-tab="dashboard"]').classList.add('active');
                    updatePageTitle('儀表板');
                    loadDashboardData();
                } else if (tab === 'conversations') {
                    if(!document.getElementById('conversationsPage')) {
                        const div = document.createElement('div');
                        div.id = 'conversationsPage';
                        div.className = 'hidden';
                        div.innerHTML = `
                            <div class="container-fluid p-4">
                                <!-- 頁面標題 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                    <i class="fas fa-comments fa-lg"></i>
                                                </div>
                                                <div>
                                                    <h3 class="mb-1 text-dark">對話管理</h3>
                                                    <p class="mb-0 text-muted">查看和回覆來自各個平台的客戶訊息</p>
                                                </div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary" onclick="refreshConversations()">
                                                    <i class="fas fa-sync-alt me-1"></i>重新整理
                                                </button>
                                                <button class="btn btn-primary" onclick="showNewConversationModal()">
                                                    <i class="fas fa-plus me-1"></i>新增對話
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 平台過濾器 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-2">
                                            <button class="btn btn-filter active" data-platform="all" onclick="filterConversations('all')">
                                                <i class="fab fa-all me-1"></i>全部
                                            </button>
                                            <button class="btn btn-filter" data-platform="line" onclick="filterConversations('line')">
                                                <i class="fab fa-line me-1"></i>LINE
                                            </button>
                                            <button class="btn btn-filter" data-platform="instagram" onclick="filterConversations('instagram')">
                                                <i class="fab fa-instagram me-1"></i>Instagram
                                            </button>
                                            <button class="btn btn-filter" data-platform="facebook" onclick="filterConversations('facebook')">
                                                <i class="fab fa-facebook me-1"></i>Facebook
                                            </button>
                                            <button class="btn btn-filter" data-platform="whatsapp" onclick="filterConversations('whatsapp')">
                                                <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                            </button>
                                            <button class="btn btn-filter" data-platform="telegram" onclick="filterConversations('telegram')">
                                                <i class="fab fa-telegram me-1"></i>Telegram
                                            </button>
                                            <button class="btn btn-filter" data-platform="discord" onclick="filterConversations('discord')">
                                                <i class="fab fa-discord me-1"></i>Discord
                                            </button>
                                            <button class="btn btn-filter" data-platform="wechat" onclick="filterConversations('wechat')">
                                                <i class="fab fa-weixin me-1"></i>微信
                                            </button>
                                            <button class="btn btn-filter" data-platform="web" onclick="filterConversations('web')">
                                                <i class="fas fa-globe me-1"></i>網站
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 聊天介面 -->
                                <div class="row conversation-layout">
                                    <!-- 對話列表 -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-header bg-white border-0">
                                                <h6 class="mb-0">對話列表</h6>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="conversation-list conversation-list-body" id="conversationList">
                                                    <!-- 對話列表將由 JavaScript 動態載入 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 聊天區域 -->
                                    <div class="col-md-8">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <div class="platform-icon me-2" id="currentPlatformIcon">
                                                        <i class="fab fa-line text-success"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0" id="currentConversationName">選擇客戶對話</h6>
                                                        <small class="text-muted" id="currentConversationStatus">等待回覆</small>
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-center gap-3">
                                                    <div class="form-check form-switch mb-0">
                                                        <input class="form-check-input" type="checkbox" id="autoReplySwitch" onchange="toggleAutoReply()">
                                                        <label class="form-check-label" for="autoReplySwitch" id="autoReplyLabel">自動回覆</label>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-success" onclick="markAsRead()" title="標記為已讀">
                                                        <i class="fas fa-check-double"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" onclick="transferToStaff()" title="轉接給其他員工">
                                                        <i class="fas fa-user-plus"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="archiveConversation()" title="封存對話">
                                                        <i class="fas fa-archive"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#autoReplySettingsModal" title="對話設定">
                                                        <i class="fas fa-sliders-h"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body p-0 chat-panel-body">
                                                <!-- 聊天訊息區域 -->
                                                <div class="flex-grow-1 p-4 chat-messages-panel" id="chatMessages">
                                                    <div class="text-center text-muted py-5" id="noConversationMessage">
                                                        <i class="fas fa-comments fa-3x mb-3"></i>
                                                        <p>選擇一個對話開始聊天</p>
                                                    </div>
                                                </div>
                                                <!-- 輸入區域 -->
                                                <div class="border-top p-3" style="height: 100px;">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="messageInput" placeholder="回覆客戶訊息..." onkeypress="handleMessageKeyPress(event)">
                                                        <button class="btn btn-primary" id="sendMessageBtn" onclick="sendMessage()">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                    </div>
                                                    <small class="text-muted mt-2 d-block">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        <span id="replyHint">手動回覆模式：輸入訊息後按 Enter 或點擊發送按鈕</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 客服帳號管理區域 -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-white border-0">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-user-tie me-2 text-primary"></i>客服帳號管理
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- 快速回覆模板 -->
                                                    <div class="col-md-8">
                                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                                            <h6 class="mb-0">快速回覆模板</h6>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="showTemplateModal()">
                                                                <i class="fas fa-plus me-1"></i>新增模板
                                                            </button>
                                                        </div>
                                                        <div class="quick-replies" id="quickReplies">
                                                            <div class="row g-2">
                                                                <div class="col-md-6">
                                                                    <div class="quick-reply-card" onclick="useQuickReply('greeting')">
                                                                        <div class="card border h-100">
                                                                            <div class="card-body p-3">
                                                                                <h6 class="card-title small">歡迎問候</h6>
                                                                                <p class="card-text small text-muted">您好！歡迎光臨，有什麼可以為您服務的嗎？</p>
                                                                                <small class="text-primary">點擊使用</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="quick-reply-card" onclick="useQuickReply('pricing')">
                                                                        <div class="card border h-100">
                                                                            <div class="card-body p-3">
                                                                                <h6 class="card-title small">價格詢問</h6>
                                                                                <p class="card-text small text-muted">我們的服務價格是 $1,500-$3,500，視服務內容而定。</p>
                                                                                <small class="text-primary">點擊使用</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="quick-reply-card" onclick="useQuickReply('booking')">
                                                                        <div class="card border h-100">
                                                                            <div class="card-body p-3">
                                                                                <h6 class="card-title small">預約確認</h6>
                                                                                <p class="card-text small text-muted">好的！已為您預約，請準時到店，有任何問題請聯繫我們。</p>
                                                                                <small class="text-primary">點擊使用</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="quick-reply-card" onclick="useQuickReply('support')">
                                                                        <div class="card border h-100">
                                                                            <div class="card-body p-3">
                                                                                <h6 class="card-title small">技術支援</h6>
                                                                                <p class="card-text small text-muted">關於這個問題，建議您... 如需進一步協助，請聯繫我們的技術團隊。</p>
                                                                                <small class="text-primary">點擊使用</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 客服帳號列表 -->
                                                    <div class="col-md-4">
                                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                                            <h6 class="mb-0">已連接的帳號</h6>
                                                            <button class="btn btn-sm btn-primary" onclick="showAddAccountModal()">
                                                                <i class="fas fa-plus me-1"></i>新增帳號
                                                            </button>
                                                        </div>
                                                        <div class="connected-accounts" id="connectedAccounts">
                                                            <!-- 已連接的客服帳號將在這裡顯示 -->
                                                            <div class="text-center text-muted py-3">
                                                                <i class="fas fa-user-plus fa-2x mb-2"></i>
                                                                <p class="mb-0">尚未連接任何客服帳號</p>
                                                                <small>點擊「新增帳號」開始連接</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.querySelector('.main-content').appendChild(div);
                    }
                    document.getElementById('conversationsPage').classList.remove('hidden');
                    document.querySelector('[data-tab="conversations"]').classList.add('active');
                    updatePageTitle('對話管理');
                    
                    // 載入對話數據
                    loadConversations();
                    
                    // 初始化聊天功能
                    initChatFunctions();
                } else if (tab === 'aiassistant') {
                    document.getElementById('aiassistantPage').classList.remove('hidden');
                    document.querySelector('[data-tab="aiassistant"]').classList.add('active');
                    updatePageTitle('AI助理資訊');
                    // 初始化AI助理配置功能
                    setTimeout(() => {
                        initAIAssistantConfig();
                    }, 100);
                } else if (tab === 'users') {
                    document.getElementById('usersPage').classList.remove('hidden');
                    document.querySelector('[data-tab="users"]').classList.add('active');
                    updatePageTitle('帳戶設定');
                } else if (tab === 'knowledge') {
                    document.getElementById('knowledgePage').classList.remove('hidden');
                    document.querySelector('[data-tab="knowledge"]').classList.add('active');
                    updatePageTitle('知識庫管理');
                    // 初始化知識庫功能
                    setTimeout(() => {
                        initKnowledgeBase();
                    }, 100);

                } else if (tab === 'channel') {
                    if(!document.getElementById('channelPage')) {
                        const div = document.createElement('div');
                        div.id = 'channelPage';
                        div.className = 'hidden';
                        div.innerHTML = `
                        <div class="container py-4">
                            <h4 class="mb-3">頻道串接</h4>
                            <p class="text-muted">配置新管道，為客戶提供更多與您的AI語音助理互動的方式。</p>
                            <div class="row justify-content-center g-3 mb-4">
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #00c300 0%, #009900 100%); color: white;">
                                        <i class="fab fa-line fa-xl"></i>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #3b5998 0%, #2d4373 100%); color: white;">
                                        <i class="fab fa-facebook-f fa-xl"></i>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #e4405f 0%, #c13584 100%); color: white;">
                                        <i class="fab fa-instagram fa-xl"></i>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #25d366 0%, #1da851 100%); color: white;">
                                        <i class="fab fa-whatsapp fa-xl"></i>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #0084ff 0%, #0066cc 100%); color: white;">
                                        <i class="fab fa-facebook-messenger fa-xl"></i>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); color: white;">
                                        <i class="fas fa-globe fa-xl"></i>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-social-icon shadow-sm" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white;">
                                        <i class="fas fa-phone fa-xl"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="fas fa-phone me-2 text-success"></i>電話</h5>
                                            <p class="card-text">使用AI聊天助理來接聽或撥打免付費電話。</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="fas fa-globe me-2 text-info"></i>網頁AI助理</h5>
                                            <p class="card-text">透過URL聊天或嵌入網站。</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 shadow-sm" id="lineApiCard" style="cursor:pointer;">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="fab fa-line me-2 text-success"></i>LINE</h5>
                                            <p class="card-text">管理您的個人 LINE Channel Token</p>
                                            <div class="d-flex gap-2">
                                            <a href="/line-token-manager.html" class="btn btn-outline-success btn-sm mt-2">
                                                    <i class="fas fa-external-link-alt me-1"></i>獨立頁面
                                            </a>
                                                <button class="btn btn-outline-success btn-sm mt-2" onclick="showLineBotManager()">
                                                    <i class="fas fa-cog me-1"></i>模態框
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="fab fa-whatsapp me-2 text-success"></i>WhatsApp</h5>
                                            <p class="card-text">連接到您的WhatsApp帳戶來發送並接收訊息。</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="fab fa-facebook-messenger me-2 text-primary"></i>Messenger（嵌入式註冊）</h5>
                                            <p class="card-text">登入並連接Messenger。</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="fab fa-instagram me-2 text-danger"></i>Instagram</h5>
                                            <p class="card-text">Login and connect Instagram。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        document.querySelector('.main-content').appendChild(div);
                    }
                    document.getElementById('channelPage').classList.remove('hidden');
                    document.querySelector('[data-tab="channel"]').classList.add('active');
                    updatePageTitle('頻道');
                } else if (tab === 'plans') {
                    ['conversationsPage','aiassistantPage','usersPage','knowledgePage','channelPage','casesPage','integrationPage'].forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.add('hidden');});
                    document.querySelectorAll('.sidebar .nav-link').forEach(l=>l.classList.remove('active'));
                    if(!document.getElementById('plansPage')){
                        const div=document.createElement('div');
                        div.id='plansPage';
                        div.className='hidden';
                        div.innerHTML=`
                        <div class=\"container-fluid p-4\">
                          <div class=\"d-flex justify-content-between align-items-center mb-3\">
                            <h3 class=\"mb-0\">方案與儲值</h3>
                          </div>
                          <div id=\"plansContent\"></div>
                        </div>`;
                        document.querySelector('.main-content').appendChild(div);
                    }
                    document.getElementById('plansPage').classList.remove('hidden');
                    const nav = document.querySelector('[data-tab=\"plans\"]'); if (nav) nav.classList.add('active');
                    updatePageTitle('方案與儲值');
                    renderPlansContent();
                } else if (tab === 'cases') {
                    if(!document.getElementById('casesPage')) {
                        const div = document.createElement('div');
                        div.id = 'casesPage';
                        div.className = 'hidden';
                        div.innerHTML = `
                            <div class="container-fluid p-4">
                                <!-- 頁面標題和操作 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                            <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <h3 class="mb-1 text-dark">使用案例庫</h3>
                                                <p class="mb-0 text-muted">來尋找適合您品牌的使用案例！選擇一個使用案例並根據需要進行編輯。</p>
                                            </div>
                                            <div class="d-flex gap-2">
                                            <a class="btn btn-outline-secondary" href="/booking.html" target="_blank">
                                                <i class="fas fa-calendar-check me-2"></i>公開預約時間表
                                            </a>
                                            <button class="btn btn-primary" onclick="requestNewUseCase()">
                                                <i class="fas fa-plus me-2"></i>請求新的使用案例
                                            </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 過濾按鈕 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-2" role="group" aria-label="使用案例過濾">
                                            <button type="button" class="btn btn-filter active" data-filter="all" onclick="filterUseCases('all')">
                                                全部
                                            </button>
                                            <button type="button" class="btn btn-filter" data-filter="chat" onclick="filterUseCases('chat')">
                                                聊天
                                            </button>
                                            <button type="button" class="btn btn-filter" data-filter="user-examples" onclick="filterUseCases('user-examples')">
                                                使用者範例庫
                                            </button>
                                            <button type="button" class="btn btn-filter" data-filter="survey" onclick="filterUseCases('survey')">
                                                調查
                                            </button>
                                            <button type="button" class="btn btn-filter" data-filter="appointment" onclick="filterUseCases('appointment')">
                                                預約安排
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 使用案例卡片網格 -->
                                <div class="row g-4" id="useCaseGrid">
                                    <!-- 使用案例卡片將在這裡動態生成 -->
                                </div>
                            </div>
                        `;
                        document.querySelector('.main-content').appendChild(div);
                    }
                    document.getElementById('casesPage').classList.remove('hidden');
                    document.querySelector('[data-tab="cases"]').classList.add('active');
                    updatePageTitle('使用案例庫');
                    
                    // 載入使用案例數據
                    loadUseCases();
                } else if (tab === 'integration') {
                    if(!document.getElementById('integrationPage')) {
                        const div = document.createElement('div');
                        div.id = 'integrationPage';
                        div.className = 'hidden';
                        div.innerHTML = `
                            <div class="container-fluid p-4">
                                <!-- 頁面標題 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h3 class="mb-1 text-dark">為您的AI智能助理程式配置新的整合</h3>
                                    </div>
                                </div>

                                <!-- 整合分類 -->
                                <div class="row g-4">
                                    <!-- 整合 -->
                                    <div class="col-12">
                                        <h5 class="mb-3 text-dark fw-bold">整合</h5>
                                        <div class="row g-3" id="integrationsGrid">
                                            <!-- 整合卡片將在這裡動態生成 -->
                                        </div>
                                    </div>

                                    <!-- SeaX 整合 -->
                                    <div class="col-12 mt-4">
                                        <h5 class="mb-3 text-dark fw-bold">SeaX 整合</h5>
                                        <div class="row g-3" id="seaxIntegrationsGrid">
                                            <!-- SeaX 整合卡片將在這裡動態生成 -->
                                        </div>
                                    </div>

                                    <!-- 客製整合 -->
                                    <div class="col-12 mt-4">
                                        <h5 class="mb-3 text-dark fw-bold">客製整合</h5>
                                        <div class="row g-3" id="customIntegrationsGrid">
                                            <!-- 客製整合卡片將在這裡動態生成 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.querySelector('.main-content').appendChild(div);
                    }
                    document.getElementById('integrationPage').classList.remove('hidden');
                    document.querySelector('[data-tab="integration"]').classList.add('active');
                    updatePageTitle('整合');
                    
                    // 載入整合數據
                    loadIntegrations();
                }
            }
            
            // 更新頁面標題
            function updatePageTitle(title) {
                document.getElementById('pageTitle').textContent = title;
            }
            
            // 更新當前時間
            function updateTime() {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleString('zh-TW');
            }
            
            // 重新整理數據
            function refreshData() {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> 重新整理中...';
                btn.disabled = true;
                
                setTimeout(() => {
                    loadDashboardData();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
            }
            
            // 載入儀表板數據
            function loadDashboardData() {
                // 更新統計數據
                updateStats();
                
                // 載入圖表
                loadCharts();
                
                // 載入活動列表
                loadActivityList();
                
                // 載入用量配額
                loadTokenUsage();
            }
            
            const DEFAULT_ESTIMATED_TOKENS_PER_CONVERSATION = 400;

            function formatNumber(value, placeholder = '--') {
                if (value === null || value === undefined) return placeholder;
                const num = Number(value);
                if (Number.isNaN(num)) return placeholder;
                return num.toLocaleString();
            }

            function formatDateLabel(value) {
                if (!value) return '--';
                try {
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) return '--';
                    return date.toLocaleDateString('zh-TW');
                } catch (error) {
                    return '--';
                }
            }

            // 載入用量配額
            async function loadTokenUsage() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) return;
                    const resp = await fetch(`${DASHBOARD_API_BASE}/billing/overview`, {
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                    });
                    if (!resp.ok) throw new Error('無法載入配額資訊');
                    const data = await resp.json();
                    if (!data.success) throw new Error(data.error || '無法載入配額資訊');
                    const ov = data.overview || {};
                    const planLabelEl = document.getElementById('planLabel');
                    if (planLabelEl) {
                        planLabelEl.textContent = `方案：${ov.planDisplayName || ov.currentPlan || '--'}`;
                    }
                    const quota = document.getElementById('quotaDisplay');
                    if (quota) {
                        quota.textContent = ov.hasUnlimitedTokens
                            ? '此方案提供無上限 token 用量'
                            : `可用 ${formatNumber(ov.tokenAvailable || 0, '0')} / 月額 ${formatNumber(ov.tokenAllowance || ov.tokenAllowanceRaw || 0, '0')} tokens`;
                    }
                    const availEl = document.getElementById('tokenAvailable');
                    if (availEl) availEl.textContent = ov.hasUnlimitedTokens ? '∞' : formatNumber(ov.tokenAvailable || 0, '0');
                    const usedEl = document.getElementById('tokenUsed');
                    if (usedEl) usedEl.textContent = formatNumber(ov.tokenUsed || 0, '0');
                    const totalEl = document.getElementById('tokenAllowance');
                    if (totalEl) totalEl.textContent = ov.hasUnlimitedTokens ? '無上限' : formatNumber(ov.tokenAllowance || ov.tokenAllowanceRaw || 0, '0');
                    const bonusEl = document.getElementById('tokenBonus');
                    if (bonusEl) bonusEl.textContent = formatNumber(ov.tokenBonus || 0, '0');
                    const nextBillingEl = document.getElementById('nextBillingDate');
                    if (nextBillingEl) nextBillingEl.textContent = formatDateLabel(ov.nextBillingDate);
                    const conversationUsedEl = document.getElementById('conversationUsed');
                    if (conversationUsedEl) conversationUsedEl.textContent = `${formatNumber(ov.conversationUsed || 0, '0')} 次`;
                    const conversationLimitDisplay = document.getElementById('conversationLimitDisplay');
                    if (conversationLimitDisplay) {
                        conversationLimitDisplay.textContent = ov.hasUnlimitedConversations
                            ? '對話無上限'
                            : `剩餘 ${formatNumber(ov.conversationRemaining || 0, '0')} / 上限 ${formatNumber(ov.conversationLimit || 0, '0')} 次`;
                    }
                    const tokensPerConversation = document.getElementById('tokensPerConversation');
                    if (tokensPerConversation) {
                        tokensPerConversation.textContent = formatNumber(
                            ov.estimatedTokensPerConversation || DEFAULT_ESTIMATED_TOKENS_PER_CONVERSATION,
                            '0'
                        );
                    }
                    const bar = document.getElementById('tokenUsageBar');
                    if (bar) {
                        if (ov.hasUnlimitedTokens) {
                            bar.style.width = '0%';
                            bar.className = 'progress-bar bg-success';
                            bar.style.opacity = '0.3';
                        } else {
                            const percent = parseFloat(ov.usagePercent || 0) || 0;
                            bar.style.opacity = '1';
                            bar.style.width = percent + '%';
                            bar.className = 'progress-bar ' + (percent >= 90 ? 'bg-danger' : percent >= 70 ? 'bg-warning' : 'bg-success');
                        }
                    }
                } catch (e) {
                    console.error('載入用量失敗:', e);
                    const quota = document.getElementById('quotaDisplay');
                    if (quota) quota.textContent = '無法載入配額資訊';
                }
            }

            async function fetchTopUpPackages() {
                if (topUpPackagesCache.length > 0) return topUpPackagesCache;
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                if (!token) throw new Error('尚未登入');
                const resp = await fetch(`${DASHBOARD_API_BASE}/billing/topup-packages`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                if (!resp.ok) {
                    throw new Error('無法載入儲值方案');
                }
                const data = await resp.json();
                if (!data.success) {
                    throw new Error(data.error || '無法載入儲值方案');
                }
                topUpPackagesCache = data.packages || [];
                return topUpPackagesCache;
            }

            function renderTopUpPackages() {
                const container = document.getElementById('topUpPackageList');
                if (!container) return;
                if (!topUpPackagesCache.length) {
                    container.innerHTML = '<div class="col-12 text-center text-muted py-4">暫無可用的儲值方案</div>';
                    return;
                }
                container.innerHTML = topUpPackagesCache.map(pkg => {
                    const active = pkg.id === selectedTopUpPackageId;
                    const currencyLabel = pkg.currency === 'TWD' ? 'NT$' : pkg.currency;
                    return `
                        <div class="col-md-4">
                            <div class="package-card ${active ? 'active' : ''}" onclick="selectTopUpPackage('${pkg.id}')">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">${pkg.label}</span>
                                    <span class="text-primary fw-bold">${currencyLabel} ${pkg.price}</span>
                                </div>
                                <p class="mb-1 small text-muted">約 ${Number(pkg.conversations || 0).toLocaleString()} 次對話</p>
                                <p class="mb-0 text-muted">≈ ${Number(pkg.tokens || 0).toLocaleString()} tokens</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function selectTopUpPackage(packageId) {
                selectedTopUpPackageId = packageId;
                renderTopUpPackages();
            }

            async function openTopUpModal() {
                try {
                    await fetchTopUpPackages();
                    if (!selectedTopUpPackageId && topUpPackagesCache.length) {
                        selectedTopUpPackageId = topUpPackagesCache[0].id;
                    }
                    renderTopUpPackages();
                    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('topUpModal'));
                    modal.show();
                } catch (error) {
                    console.error('載入儲值方案失敗:', error);
                    showAlert(error.message || '無法載入儲值方案', 'danger');
                }
            }

            async function submitTopUp() {
                if (!selectedTopUpPackageId) {
                    showAlert('請先選擇儲值方案', 'warning');
                    return;
                }
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    const resp = await fetch(`${DASHBOARD_API_BASE}/billing/topup`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ packageId: selectedTopUpPackageId })
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.success) {
                        throw new Error(data.error || '儲值失敗');
                    }
                    showAlert('儲值成功，餘額已更新！', 'success');
                    const topUpModalEl = document.getElementById('topUpModal');
                    const modalInstance = bootstrap.Modal.getInstance(topUpModalEl);
                    if (modalInstance) modalInstance.hide();
                    loadTokenUsage();
                } catch (error) {
                    console.error('儲值失敗:', error);
                    showAlert(error.message || '儲值失敗，請稍後再試', 'danger');
                }
            }
            
            // 更新統計數據
            async function updateStats() {
                try {
                    console.log('🔄 載入真實統計數據...');
                    
                    const response = await fetch(`${window.API_BASE_URL || 'https://echochat-api.onrender.com/api'}/stats`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const stats = result.data;
                        
                        console.log('✅ 統計數據載入成功:', stats);
                        
                        // 更新統計卡片
                        document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
                        document.getElementById('totalMessages').textContent = stats.totalMessages.toLocaleString();
                        document.getElementById('knowledgeItems').textContent = stats.knowledgeItems.toLocaleString();
                        
                        // 添加最後更新時間
                        const lastUpdated = new Date(stats.lastUpdated).toLocaleString('zh-TW');
                        console.log('📅 最後更新時間:', lastUpdated);
                        
                    } else {
                        console.error('❌ 載入統計數據失敗:', response.status);
                        // 如果 API 失敗，使用預設數據
                        const defaultStats = {
                            totalUsers: 0,
                            totalMessages: 0,
                            knowledgeItems: 0
                        };
                        
                        document.getElementById('totalUsers').textContent = defaultStats.totalUsers.toLocaleString();
                        document.getElementById('totalMessages').textContent = defaultStats.totalMessages.toLocaleString();
                        document.getElementById('knowledgeItems').textContent = defaultStats.knowledgeItems.toLocaleString();
                    }
                } catch (error) {
                    console.error('❌ 載入統計數據錯誤:', error);
                    // 使用預設數據
                    const defaultStats = {
                        totalUsers: 0,
                        totalMessages: 0,
                        knowledgeItems: 0
                    };
                    
                    document.getElementById('totalUsers').textContent = defaultStats.totalUsers.toLocaleString();
                    document.getElementById('totalMessages').textContent = defaultStats.totalMessages.toLocaleString();
                    document.getElementById('knowledgeItems').textContent = defaultStats.knowledgeItems.toLocaleString();
                }
            }
            
            // 載入圖表
            async function loadCharts() {
                try {
                    const chartElement = document.getElementById('userActivityChart');
                    if (!chartElement) {
                        console.error('找不到 userActivityChart 元素');
                        return;
                    }
                    
                    const ctx = chartElement.getContext('2d');
                    
                    // 如果已經有圖表，先銷毀
                    if (window.userActivityChart && typeof window.userActivityChart.destroy === 'function') {
                        console.log('銷毀現有圖表');
                        window.userActivityChart.destroy();
                    }
                    
                    // 檢查 Chart.js 是否已載入
                    if (typeof Chart === 'undefined') {
                        console.error('Chart.js 尚未載入');
                        return;
                    }
                    
                    // 從後端獲取活躍度數據
                    console.log('🔄 載入用戶活躍度數據...');
                    
                    const response = await fetch(`${window.API_BASE_URL || 'https://echochat-api.onrender.com/api'}/stats/activity`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let chartData = {
                        labels: ['週一', '週二', '週三', '週四', '週五', '週六', '週日'],
                        datasets: [{
                            label: '活躍用戶',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    };
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            chartData = result.data;
                            console.log('✅ 活躍度數據載入成功:', chartData);
                        }
                    } else {
                        console.error('❌ 載入活躍度數據失敗:', response.status);
                    }
                    
                    window.userActivityChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    console.log('✅ 圖表載入成功');
                    
                } catch (error) {
                    console.error('❌ 載入圖表時發生錯誤:', error);
                    return;
                }
            }
            
            // 載入活動列表
            async function loadActivityList() {
                try {
                    console.log('🔄 載入最近活動...');
                    
                    const response = await fetch(`${window.API_BASE_URL || 'https://echochat-api.onrender.com/api'}/stats/recent-activity`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let activities = [];
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            activities = result.data;
                            console.log('✅ 活動數據載入成功:', activities);
                        }
                    } else {
                        console.error('❌ 載入活動數據失敗:', response.status);
                        // 使用預設活動數據
                        activities = [
                            { icon: 'fas fa-user-plus', color: 'bg-success', text: '新用戶註冊', time: '2分鐘前' },
                            { icon: 'fas fa-comment', color: 'bg-primary', text: '收到新訊息', time: '5分鐘前' },
                            { icon: 'fas fa-brain', color: 'bg-warning', text: '知識庫更新', time: '10分鐘前' }
                        ];
                    }
                    
                    const activityList = document.getElementById('activityList');
                    if (!activityList) return;
                    
                    activityList.innerHTML = '';
                    
                    if (activities.length === 0) {
                        activityList.innerHTML = '<div class="text-muted text-center">暫無最近活動</div>';
                        return;
                    }
                    
                    activities.forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'activity-item';
                        item.innerHTML = `
                            <div class="activity-icon ${activity.color}">
                                <i class="${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div>${activity.text}</div>
                                <div class="activity-time">${activity.time}</div>
                            </div>
                        `;
                        activityList.appendChild(item);
                    });
                    
                } catch (error) {
                    console.error('❌ 載入活動列表時發生錯誤:', error);
                    const activityList = document.getElementById('activityList');
                    if (activityList) {
                        activityList.innerHTML = '<div class="text-muted text-center">載入活動失敗</div>';
                    }
                }
            }
            
            // 快速操作函數
            function navigateTo(url) {
                window.location.href = url;
            }
            
            function addKnowledge() {
                window.location.href = '/admin.html';
            }
            
            function viewReports() {
                window.location.href = '/admin.html';
            }
            
            function systemSettings() {
                window.location.href = '/admin.html';
            }
            
            // 初始化
            document.addEventListener('DOMContentLoaded', function() {
                setInterval(updateTime, 1000);
                updateTime();
                loadDashboardData();
                
                // 添加登出按鈕事件監聽器 - 使用延遲確保DOM完全載入
                setTimeout(function() {
                    const logoutBtn = document.getElementById('logoutButton');
                    console.log('Looking for logout button...', logoutBtn);
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Logout button clicked!');
                            logout();
                        });
                        console.log('Logout button event listener added successfully');
                        
                        // 測試按鈕是否可見
                        const rect = logoutBtn.getBoundingClientRect();
                        console.log('Button position:', rect);
                        console.log('Button styles:', window.getComputedStyle(logoutBtn));
                    } else {
                        console.error('Logout button not found');
                        // 嘗試查找所有可能的按鈕
                        const allButtons = document.querySelectorAll('button');
                        console.log('All buttons found:', allButtons);
                    }
                }, 100);
            });



            // 確保DOM完全載入後再綁定事件
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM載入完成，開始綁定事件');
                
                // 側邊欄固定展開（移除收合功能）
                document.body.classList.remove('sidebar-collapsed');
                
                // 載入真實對話數據
                loadConversations();
                
                // 僅管理員顯示「帳號管理」與右下帳號管理區域
                try {
                    const role = (localStorage.getItem('staffRole') || localStorage.getItem('role') || '').toLowerCase();
                    const isAdmin = role === 'admin' || role === 'super_admin';
                    // 側欄連結
                    const accountMgmtLink = document.querySelector('a.nav-link[href="account-management.html"]');
                    if (accountMgmtLink) {
                        if (isAdmin) {
                            accountMgmtLink.classList.remove('admin-only');
                        } else {
                            accountMgmtLink.classList.add('admin-only');
                        }
                    }
                    // 右下客服帳號管理卡片（以標題識別）
                    const csMgmtCard = Array.from(document.querySelectorAll('h6')).find(h => h.textContent.trim().includes('客服帳號管理'));
                    if (csMgmtCard) {
                        const card = csMgmtCard.closest('.card');
                        if (card) {
                            if (isAdmin) card.classList.remove('admin-only');
                            else card.classList.add('admin-only');
                        }
                    }
                } catch (e) {
                    console.warn('角色檢查失敗，採預設顯示:', e);
                }

                // 綁定導航連結事件
                document.querySelectorAll('.nav-link[data-tab]').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        switchTab(this.getAttribute('data-tab'));
                    });
                });

                // 綁定AI配置切換事件
                const aiConfigToggle = document.getElementById('aiConfigToggle');
                console.log('找到AI配置切換按鈕:', aiConfigToggle);
                if (aiConfigToggle) {
                    aiConfigToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('AI配置切換按鈕被點擊');
                        const menu = document.getElementById('aiConfigMenu');
                        const arrow = document.getElementById('aiConfigArrow');
                        console.log('菜單元素:', menu);
                        console.log('箭頭元素:', arrow);
                        
                        // 切換菜單顯示狀態
                        if (menu.classList.contains('show')) {
                            menu.classList.remove('show');
                            arrow.classList.remove('rotated');
                            arrow.innerHTML = '<i class="fas fa-caret-right"></i>';
                            console.log('隱藏AI配置菜單');
                        } else {
                            menu.classList.add('show');
                            arrow.classList.add('rotated');
                            arrow.innerHTML = '<i class="fas fa-caret-down"></i>';
                            console.log('顯示AI配置菜單');
                        }
                    });
                    console.log('AI配置切換事件已綁定');
                }

                // 已移除側邊欄切換功能
            });



            // 事件代理，確保點擊 LINE 卡片可彈出 modal
            document.addEventListener('click', function(e) {
                // 處理登出按鈕點擊（事件代理方式）
                if (e.target && (e.target.id === 'logoutButton' || e.target.closest('#logoutButton'))) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Logout button clicked via event delegation!');
                    logout();
                    return;
                }
                
                // 點擊卡片本身或內部元素都可觸發
                if (e.target && (e.target.id === 'lineApiCard' || (e.target.closest && e.target.closest('#lineApiCard')))) {
                    // 顯示 LINE Bot 管理模態框
                    showLineBotManager();
                }
            });

            function logout() {
                console.log('Logout function called');
                if (confirm('確定要登出嗎？')) {
                    console.log('User confirmed logout');
                    localStorage.clear();
                    console.log('LocalStorage cleared');
                    console.log('✅ 跳轉到登入頁面');
                    window.location.href = 'login.html';
                } else {
                    console.log('User cancelled logout');
                }
            }
            
            // AI助理配置功能
            async function initAIAssistantConfig() {
                const form = document.getElementById('aiAssistantForm');
                const assistantNameInput = document.getElementById('assistantName');
                const llmModelSelect = document.getElementById('llmModel');
                const useCaseSelect = document.getElementById('useCase');
                const aiDescriptionTextarea = document.getElementById('aiDescription');
                const previewAssistantName = document.getElementById('previewAssistantName');
                const previewMessage = document.getElementById('previewMessage');
                
                // 載入模型資訊
                await loadModelInfo();
                
                // 頁面載入時一律載入已儲存的配置（每位使用者獨立）
                await loadAIAssistantConfig();
                
                // 即時預覽更新
                function updatePreview() {
                    const assistantName = assistantNameInput.value || '設計師 Rainy';
                    const useCase = useCaseSelect.value;
                    
                    if (previewAssistantName) {
                        previewAssistantName.textContent = assistantName;
                    }
                    
                    // 根據使用場景更新預覽訊息
                    const messages = {
                        'customer-service': '你好，有甚麼可以幫您的嗎？',
                        'sales-assistant': '歡迎！我可以協助您了解我們的產品和服務',
                        'technical-support': '您好，我是技術支援助理，很高興為您服務',
                        'general-assistant': '您好，我是您的專屬助理，請問有什麼需要協助的嗎？'
                    };
                    
                    if (previewMessage) {
                        previewMessage.textContent = messages[useCase] || messages['customer-service'];
                    }
                }
                
                // 綁定即時預覽事件
                if (assistantNameInput) {
                    assistantNameInput.addEventListener('input', updatePreview);
                }
                if (useCaseSelect) {
                    useCaseSelect.addEventListener('change', updatePreview);
                }
                
                // 表單提交處理
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        await saveAIAssistantConfig();
                    });
                }
                
                // 重置按鈕處理
                const resetBtn = document.getElementById('resetConfigBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', function() {
                        if (confirm('確定要重置所有設定嗎？這將清除您目前的配置。')) {
                            resetToDefault();
                        }
                    });
                }
                
                // 初始化預覽
                updatePreview();
                
                            // 更新最後更新時間
            updateLastUpdateTime();
            
            // 初始化聊天測試功能
            initChatTest();
        }
        
        // 聊天測試功能
        function initChatTest() {
            const chatInput = document.getElementById('chatInput_unused');
            const sendMessageBtn = document.getElementById('sendMessageBtn_unused');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const refreshChatBtn = document.getElementById('refreshChatBtn');
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            
            // 聊天歷史記錄
            let chatHistory = [];
            let conversationId = null;
            
            // 發送訊息
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // 添加用戶訊息到聊天界面
                addUserMessage(message);
                chatInput.value = '';
                
                // 顯示載入狀態
                showLoadingMessage();
                
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        showChatAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const response = await fetch('https://echochat-api.onrender.com/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            message: message,
                            conversationId: conversationId,
                            no_store: true,
                            source: 'dashboard_test'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // 移除載入訊息
                        removeLoadingMessage();
                        
                        // 添加 AI 回應
                        addAIMessage(data.reply, data.assistantName || 'AI 助理');
                        
                        // 更新對話 ID
                        if (data.conversationId) {
                            conversationId = data.conversationId;
                        }
                        
                        // 更新聊天歷史
                        chatHistory.push({
                            role: 'user',
                            content: message,
                            timestamp: new Date()
                        });
                        chatHistory.push({
                            role: 'assistant',
                            content: data.reply,
                            timestamp: new Date()
                        });
                        
                    } else if (response.status === 401 || response.status === 403) {
                        removeLoadingMessage();
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showChatAlert('認證令牌已過期，請重新登入', 'warning');
                        // 延遲跳轉到登入頁面
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        removeLoadingMessage();
                        showChatAlert('AI 回應失敗: ' + (data.error || '未知錯誤'), 'danger');
                    }
                } catch (error) {
                    console.error('聊天錯誤:', error);
                    removeLoadingMessage();
                    showChatAlert('網路錯誤，請稍後再試', 'danger');
                }
            }
            
            // 添加用戶訊息
            function addUserMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'd-flex align-items-start mb-3 justify-content-end';
                messageDiv.innerHTML = `
                    <div class="bg-primary text-white p-3 rounded-3 shadow-sm" style="max-width: 80%; border-radius: 15px 15px 5px 15px;">
                        <span>${escapeHtml(message)}</span>
                        <div class="small opacity-75 mt-1">
                            <i class="fas fa-check-double me-1"></i>已發送
                        </div>
                    </div>
                    <div class="ms-2">
                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                            <i class="fas fa-user text-white" style="font-size: 12px;"></i>
                        </div>
                    </div>
                `;
                chatMessagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 添加 AI 訊息
            function addAIMessage(message, assistantName) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'd-flex align-items-start mb-3';
                messageDiv.innerHTML = `
                    <div class="me-2">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                            <i class="fas fa-robot text-white" style="font-size: 12px;"></i>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-3 shadow-sm" style="max-width: 80%; border-radius: 15px 15px 15px 5px !important;">
                        <span class="text-dark">${escapeHtml(message)}</span>
                        <div class="small text-muted mt-1">
                            <i class="fas fa-clock me-1"></i>剛剛
                        </div>
                    </div>
                `;
                chatMessagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 顯示載入訊息
            function showLoadingMessage() {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingMessage';
                loadingDiv.className = 'd-flex align-items-start mb-3';
                loadingDiv.innerHTML = `
                    <div class="me-2">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                            <i class="fas fa-robot text-white" style="font-size: 12px;"></i>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-3 shadow-sm" style="max-width: 80%; border-radius: 15px 15px 15px 5px !important;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                            <span class="text-muted">AI 正在思考中...</span>
                        </div>
                    </div>
                `;
                chatMessagesContainer.appendChild(loadingDiv);
                scrollToBottom();
            }
            
            // 移除載入訊息
            function removeLoadingMessage() {
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
            }
            
            // 滾動到底部
            function scrollToBottom() {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
            
            // HTML 轉義
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 清除聊天記錄
            function clearChat() {
                if (confirm('確定要清除所有聊天記錄嗎？')) {
                    chatHistory = [];
                    conversationId = null;
                    chatMessagesContainer.innerHTML = `
                        <div class="d-flex align-items-start mb-3" id="welcomeMessage">
                            <div class="me-2">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    <i class="fas fa-robot text-white" style="font-size: 12px;"></i>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-3 shadow-sm" style="max-width: 80%; border-radius: 15px 15px 15px 5px !important;">
                                <span id="previewMessage" class="text-dark">你好，有甚麼可以幫您的嗎？</span>
                                <div class="small text-muted mt-1">
                                    <i class="fas fa-clock me-1"></i>剛剛
                                </div>
                            </div>
                        </div>
                    `;
                    showChatAlert('聊天記錄已清除', 'success');
                }
            }
            
            // 重新開始聊天
            function refreshChat() {
                clearChat();
                // 重新載入 AI 助理配置
                loadAIAssistantConfig();
            }
            
            // 顯示聊天提示訊息
            function showChatAlert(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-3`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                chatMessagesContainer.parentElement.insertBefore(alertDiv, chatMessagesContainer);
                
                // 自動消失
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            // 綁定事件
            // 移除舊的聊天測試綁定，避免與 knowledge-fix.js 重複
            
            // 由 knowledge-fix.js 處理 Enter 送出
            
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', clearChat);
            }
            
            if (refreshChatBtn) {
                refreshChatBtn.addEventListener('click', refreshChat);
            }
        }
        
        // 重置為預設值
            async function resetToDefault() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showConfigAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const response = await fetch('https://echochat-api.onrender.com/api/ai-assistant-config/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // 更新前端表單
                        document.getElementById('assistantName').value = data.config.assistant_name;
                        document.getElementById('llmModel').value = data.config.llm;
                        document.getElementById('useCase').value = data.config.use_case;
                        document.getElementById('aiDescription').value = data.config.description;
                        
                        // 更新預覽
                        const previewAssistantName = document.getElementById('previewAssistantName');
                        const previewMessage = document.getElementById('previewMessage');
                        
                        if (previewAssistantName) {
                            previewAssistantName.textContent = data.config.assistant_name;
                        }
                        if (previewMessage) {
                            previewMessage.textContent = '你好，有甚麼可以幫您的嗎？';
                        }
                        
                        updateLastUpdateTime();
                        
                        // 顯示重置成功訊息
                        showConfigAlert('設定已重置為預設值', 'success');
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showConfigAlert('認證令牌已過期，請重新登入', 'warning');
                        // 延遲跳轉到登入頁面
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        showConfigAlert('重置失敗: ' + (data.error || '未知錯誤'), 'danger');
                    }
                } catch (error) {
                    console.error('重置 AI 助理配置失敗:', error);
                    showConfigAlert('網路錯誤，請稍後再試', 'danger');
                }
            }
            
            // 更新最後更新時間
            function updateLastUpdateTime() {
                const timeElement = document.getElementById('lastUpdateTime');
                if (timeElement) {
                    const now = new Date();
                    const timeString = now.toLocaleString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    timeElement.textContent = timeString;
                }
            }
            
            // 顯示配置提示訊息
            function showConfigAlert(message, type = 'success') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                // 自動消失
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 4000);
            }
            
            // AI 模型資訊和選擇功能
            let modelInfo = {};

            // 從後端載入模型資訊
            async function loadModelInfo() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) return;
                    
                    const response = await fetch('https://echochat-api.onrender.com/api/ai-models', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            modelInfo = data.models;
                            // 初始化模型資訊顯示
                            updateModelInfo();

                            // 顯示 Token 狀態（若後端有附帶）
                            if (data.token) {
                                const t = data.token;
                                const el = document.getElementById('tokenStatusLine');
                                if (el) {
                                    el.innerHTML = `方案：<strong>${t.plan}</strong>｜本月額度：<strong>${(t.allowance||0).toLocaleString()}</strong>｜已用：<strong>${(t.used_in_cycle||0).toLocaleString()}</strong>｜儲值餘額：<strong>${(t.bonus_balance||0).toLocaleString()}</strong>｜下次重置：<strong>${t.next_billing_at ? new Date(t.next_billing_at).toLocaleString() : '-'}</strong>`;
                                }
                            }
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        // 不顯示錯誤訊息，因為這不是用戶主動操作
                    }
                } catch (error) {
                    console.error('載入模型資訊失敗:', error);
                    // 如果載入失敗，使用預設資訊
                    modelInfo = {
                        'gpt-5.2': {
                            name: 'GPT-5.2',
                            description: '最新旗艦模型，適合最高品質與高準確度場景',
                            features: ['最高準確度', '強推理能力', '多語言支援', '適合複雜任務'],
                            pricing: '頂級',
                            speed: '中等',
                            provider: 'OpenAI'
                        },
                        'gpt-5.1': {
                            name: 'GPT-5.1',
                            description: '高品質旗艦模型，適合關鍵任務與專業場景',
                            features: ['高準確度', '穩定回覆', '多語言支援', '適合專業任務'],
                            pricing: '高階',
                            speed: '中等',
                            provider: 'OpenAI'
                        },
                        'gpt-5.0': {
                            name: 'GPT-5.0',
                            description: '新一代高品質模型，兼顧品質與效率',
                            features: ['高品質回覆', '多語言支援', '通用能力強'],
                            pricing: '高階',
                            speed: '中等',
                            provider: 'OpenAI'
                        },
                        'gpt-4.1': {
                            name: 'GPT-4.1',
                            description: '最新旗艦模型，適合高品質與高準確度場景',
                            features: ['高準確度', '強推理能力', '多語言支援', '適合複雜任務'],
                            pricing: '高階',
                            speed: '中等',
                            provider: 'OpenAI'
                        },
                        'gpt-4o-mini': {
                            name: 'GPT-4o Mini',
                            description: '快速且經濟實惠的對話體驗，適合一般客服需求',
                            features: ['快速回應', '成本效益高', '支援多語言', '適合日常對話'],
                            pricing: '經濟實惠',
                            speed: '快速',
                            provider: 'OpenAI'
                        },
                        'gpt-4o': {
                            name: 'GPT-4o',
                            description: '高品質通用模型，適合需要更佳理解力的場景',
                            features: ['高品質回覆', '多語言支援', '通用能力強'],
                            pricing: '高階',
                            speed: '中等',
                            provider: 'OpenAI'
                        },
                        'gpt-4-turbo': {
                            name: 'GPT-4 Turbo',
                            description: '高級模型，適合較複雜的任務與內容生成',
                            features: ['強推理能力', '高準確度', '適合複雜任務'],
                            pricing: '高階',
                            speed: '中等',
                            provider: 'OpenAI'
                        },
                        'gpt-3.5-turbo': {
                            name: 'GPT-3.5 Turbo',
                            description: '經典入門模型，速度快且成本較低',
                            features: ['快速回應', '成本效益高', '穩定可靠'],
                            pricing: '經濟實惠',
                            speed: '快速',
                            provider: 'OpenAI'
                        }
                    };
                }
            }

            // 更新模型資訊顯示
            function updateModelInfo() {
                const selectedModel = document.getElementById('llmModel').value;
                const modelDescription = document.getElementById('modelDescription');
                const info = modelInfo[selectedModel];
                
                if (info && modelDescription) {
                    modelDescription.textContent = info.description;
                }
            }

            // 顯示模型詳細資訊
            function showModelDetails() {
                const selectedModel = document.getElementById('llmModel').value;
                const info = modelInfo[selectedModel];
                
                if (!info) return;
                
                const featuresHtml = info.features.map(feature => 
                    `<li><i class="fas fa-check text-success me-2"></i>${feature}</li>`
                ).join('');
                
                const modalHtml = `
                    <div class="modal fade" id="modelDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-brain me-2"></i>${info.name} 詳細資訊
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="text-primary mb-3">模型描述</h6>
                                            <p class="text-muted">${info.description}</p>
                                            
                                            <h6 class="text-primary mb-3">主要特色</h6>
                                            <ul class="list-unstyled">
                                                ${featuresHtml}
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="text-primary mb-3">效能指標</h6>
                                                    <div class="mb-3">
                                                        <strong>價格等級:</strong>
                                                        <span class="badge bg-${info.pricing === '經濟實惠' || info.pricing === '免費' ? 'success' : info.pricing === '中等' ? 'warning' : 'danger'} ms-2">
                                                            ${info.pricing}
                                                        </span>
                                                    </div>
                                                    <div class="mb-3">
                                                        <strong>回應速度:</strong>
                                                        <span class="badge bg-${info.speed === '極速' || info.speed === '快速' ? 'success' : 'warning'} ms-2">
                                                            ${info.speed}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                    <button type="button" class="btn btn-primary" onclick="selectCurrentModel()">
                                        <i class="fas fa-check me-2"></i>選擇此模型
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除舊的 modal
                const oldModal = document.getElementById('modelDetailsModal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // 添加新的 modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 顯示 modal
                const modal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
                modal.show();
            }

            // 選擇當前模型
            function selectCurrentModel() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modelDetailsModal'));
                if (modal) {
                    modal.hide();
                }
                showConfigAlert('模型已選擇！請點擊「儲存設定」來套用變更。', 'info');
            }

            // 顯示模型比較
            function showModelComparison() {
                const selectedModel = document.getElementById('llmModel').value;
                const allowedComparison = [
                    'gpt-5.2',
                    'gpt-5.1',
                    'gpt-5.0',
                    'gpt-4',
                    'gpt-4.1',
                    'gpt-4o',
                    'gpt-4-turbo',
                    'gpt-3.5-turbo'
                ];
                const models = allowedComparison.filter(model => modelInfo[model]);
                const currentModel = modelInfo[selectedModel];
                
                if (!currentModel) return;
                
                // 選擇要比較的模型（排除當前選擇的模型）
                const otherModels = models.filter(model => model !== selectedModel);
                const comparisonModels = [selectedModel, ...otherModels.slice(0, 2)]; // 最多比較3個模型
                
                let comparisonHtml = `
                    <div class="modal fade" id="modelComparisonModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-balance-scale me-2"></i>AI 模型比較
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                `;
                
                comparisonModels.forEach(modelKey => {
                    const model = modelInfo[modelKey];
                    if (!model) return;
                    
                    const featuresHtml = model.features.map(feature => 
                        `<li><i class="fas fa-check text-success me-2"></i>${feature}</li>`
                    ).join('');
                    
                    const languagesHtml = model.supported_languages ? 
                        model.supported_languages.slice(0, 3).join(', ') + (model.supported_languages.length > 3 ? '...' : '') : 
                        '多語言支援';
                    
                    comparisonHtml += `
                        <div class="col-md-4">
                            <div class="card h-100 ${modelKey === selectedModel ? 'border-primary' : ''}">
                                <div class="card-header ${modelKey === selectedModel ? 'bg-primary text-white' : 'bg-light'}">
                                    <h6 class="mb-0">
                                        <i class="fas fa-robot me-2"></i>${model.name}
                                        ${modelKey === selectedModel ? '<span class="badge bg-light text-primary ms-2">當前選擇</span>' : ''}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small">${model.description}</p>
                                    
                                    <div class="mb-3">
                                        <strong>供應商:</strong> ${model.provider || 'OpenAI'}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>價格等級:</strong>
                                        <span class="badge bg-${model.pricing === '經濟實惠' || model.pricing === '免費' ? 'success' : model.pricing === '中等' ? 'warning' : 'danger'} ms-2">
                                            ${model.pricing}
                                        </span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>回應速度:</strong>
                                        <span class="badge bg-${model.speed === '極速' || model.speed === '快速' ? 'success' : 'warning'} ms-2">
                                            ${model.speed}
                                        </span>
                                    </div>
                                    
                                    ${model.max_tokens ? `
                                    <div class="mb-3">
                                        <strong>最大 Token:</strong> ${model.max_tokens.toLocaleString()}
                                    </div>
                                    ` : ''}
                                    
                                    <div class="mb-3">
                                        <strong>支援語言:</strong> ${languagesHtml}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>主要特色:</strong>
                                        <ul class="list-unstyled mt-2">
                                            ${featuresHtml}
                                        </ul>
                                    </div>
                                    
                                    ${modelKey !== selectedModel ? `
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="selectModel('${modelKey}')">
                                        <i class="fas fa-check me-2"></i>選擇此模型
                                    </button>
                                    ` : `
                                    <button class="btn btn-primary btn-sm w-100" disabled>
                                        <i class="fas fa-check me-2"></i>已選擇
                                    </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                comparisonHtml += `
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除舊的 modal
                const oldModal = document.getElementById('modelComparisonModal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // 添加新的 modal
                document.body.insertAdjacentHTML('beforeend', comparisonHtml);
                
                // 顯示 modal
                const modal = new bootstrap.Modal(document.getElementById('modelComparisonModal'));
                modal.show();
            }

            // 選擇模型
            function selectModel(modelKey) {
                document.getElementById('llmModel').value = modelKey;
                updateModelInfo();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('modelComparisonModal'));
                if (modal) {
                    modal.hide();
                }
                
                showConfigAlert(`已選擇 ${modelInfo[modelKey].name}！請點擊「儲存設定」來套用變更。`, 'success');
            }

            // 載入AI助理配置
            async function loadAIAssistantConfig() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        console.log('❌ 沒有認證令牌，無法載入 AI 助理配置');
                        return;
                    }
                    
                    const response = await fetch('https://echochat-api.onrender.com/api/ai-assistant-config', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.config) {
                            const config = data.config;
                            document.getElementById('assistantName').value = config.assistant_name || '設計師 Rainy';
                            document.getElementById('llmModel').value = config.llm || 'gpt-4o-mini';
                            document.getElementById('useCase').value = config.use_case || 'customer-service';
                            document.getElementById('aiDescription').value = config.description || '';
                            
                            // 初始化模型資訊顯示
                            updateModelInfo();
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showConfigAlert('認證令牌已過期，請重新登入', 'warning');
                        // 延遲跳轉到登入頁面
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        console.error('載入 AI 助理配置失敗:', response.status, response.statusText);
                        showConfigAlert('載入配置失敗: ' + response.statusText, 'danger');
                    }
                } catch (error) {
                    console.error('載入AI助理配置失敗:', error);
                    showConfigAlert('網路錯誤，請稍後再試', 'danger');
                }
            }
            
            // 儲存AI助理配置
            async function saveAIAssistantConfig() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showConfigAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const config = {
                        assistant_name: document.getElementById('assistantName').value,
                        llm: document.getElementById('llmModel').value,
                        use_case: document.getElementById('useCase').value,
                        description: document.getElementById('aiDescription').value
                    };
                    
                    const response = await fetch('https://echochat-api.onrender.com/api/ai-assistant-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(config)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // 顯示成功訊息
                        showConfigAlert('AI助理配置已成功儲存！', 'success');
                        updateLastUpdateTime();
                        // 若回傳有 token 狀態也更新
                        if (data.token) {
                            const t = data.token;
                            const el = document.getElementById('tokenStatusLine');
                            if (el) {
                                el.innerHTML = `方案：<strong>${t.plan}</strong>｜本月額度：<strong>${(t.allowance||0).toLocaleString()}</strong>｜已用：<strong>${(t.used_in_cycle||0).toLocaleString()}</strong>｜儲值餘額：<strong>${(t.bonus_balance||0).toLocaleString()}</strong>｜下次重置：<strong>${t.next_billing_at ? new Date(t.next_billing_at).toLocaleString() : '-'}</strong>`;
                            }
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showConfigAlert('認證令牌已過期，請重新登入', 'warning');
                        // 延遲跳轉到登入頁面
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        showConfigAlert('儲存失敗: ' + (data.error || '未知錯誤'), 'danger');
                    }
                } catch (error) {
                    console.error('儲存AI助理配置失敗:', error);
                    showConfigAlert('網路錯誤，請稍後再試', 'danger');
                }
            }
            
            // ==================== 知識庫管理功能 ====================
            
            // 初始化知識庫
            function initKnowledgeBase() {
                console.log('初始化知識庫...');
                
                // 診斷白色遮罩問題
                diagnoseWhiteOverlay();
                
                // 強制移除所有可能的遮罩
                removeAllOverlays();
                
                // 初始化標籤事件監聽器
                initKnowledgeTabListeners();
                
                // 啟動內容保護監控
                startContentProtection();
                
                // 立即隱藏所有內容，然後顯示預設標籤
                console.log('立即隱藏所有內容...');
                const newContent = document.getElementById('newKnowledgeContent');
                newContent.classList.add('force-show');
                newContent.classList.remove('hidden');
                newContent.classList.remove('force-show');
            }
            
            // 診斷白色遮罩問題
            function diagnoseWhiteOverlay() {
                // 實現診斷白色遮罩的邏輯
                console.log('診斷白色遮罩');
            }
            
            // 強制移除所有可能的遮罩
            function removeAllOverlays() {
                // 實現移除所有遮罩的邏輯
                console.log('移除所有遮罩');
            }
            
            // 初始化標籤事件監聽器
            function initKnowledgeTabListeners() {
                // 實現標籤事件監聽器的初始化邏輯
                console.log('初始化標籤事件監聽器');
            }
            
            // 啟動內容保護監控
            function startContentProtection() {
                // 實現內容保護監控的邏輯
                console.log('啟動內容保護監控');
            }

            // ==================== 使用案例庫功能 ====================
            
            // 載入使用案例數據
            function loadUseCases() {
                console.log('載入使用案例數據...');
                
                // 使用案例模板（含一鍵初始化所需資料）
                const useCases = [
                    {
                        id: 1,
                        key: 'customer-service',
                        title: '客服聊天機器人',
                        description: '24/7自動回覆客戶問題，提供即時支援',
                        category: 'chat',
                        tags: ['客服', '自動回覆', '即時支援'],
                        assistantName: '客服小幫手',
                        assistantDescription: '提供即時客服回覆與常見問題解答。',
                        knowledge: [
                            { q: '營業時間是什麼？', a: '我們的營業時間為週一至週五 09:00-18:00。', category: 'faq' },
                            { q: '如何聯絡客服？', a: '您可以透過網站聯絡表單或來信 contact@echochat.com.tw 與我們聯繫。', category: 'faq' },
                            { q: '是否提供退款？', a: '若您於購買後 7 天內不滿意，我們提供無條件退款。', category: 'policy' }
                        ]
                    },
                    {
                        id: 2,
                        key: 'user-examples',
                        title: '使用者範例庫',
                        description: '蒐集常見使用者問答與最佳實務，快速套用到您的商家知識庫。',
                        category: 'user-examples',
                        tags: ['faq', '最佳實務', '快速套用'],
                        assistantName: '使用者範例庫',
                        assistantDescription: '提供常見問答模板，協助您快速建立高品質知識庫內容。',
                        knowledge: [
                            { q: '營業時間是什麼？', a: '我們的營業時間為週一至週五 09:00-18:00。', category: 'faq' },
                            { q: '如何聯絡客服？', a: '您可以透過網站聯絡表單或來信 contact@echochat.com.tw 與我們聯繫。', category: 'faq' },
                            { q: '退換貨政策為何？', a: '提供 7 天鑑賞期，詳細請參見網站政策頁。', category: 'policy' }
                        ]
                    },
                    {
                        id: 6,
                        key: 'shopping-process',
                        title: '購物流程助手',
                        description: '協助顧客完成購物流程，從瀏覽商品到結帳的完整指引。',
                        category: 'user-examples',
                        tags: ['購物', '流程', '結帳'],
                        assistantName: '購物流程助手',
                        assistantDescription: '提供完整的購物流程指引，協助顧客順利完成購買。',
                        knowledge: [
                            { q: '如何下單購買？', a: '請先選擇商品，加入購物車後點擊結帳，填寫收件資訊即可完成訂單。', category: 'guide' },
                            { q: '支援哪些付款方式？', a: '我們支援信用卡、ATM轉帳、超商代碼繳費等多種付款方式。', category: 'payment' },
                            { q: '如何查詢訂單狀態？', a: '您可登入會員中心查看訂單狀態，或使用訂單編號查詢。', category: 'order' },
                            { q: '運費如何計算？', a: '滿額免運，未滿額依地區收取運費，詳細請見運費說明。', category: 'shipping' }
                        ]
                    },
                    {
                        id: 7,
                        key: 'after-sales',
                        title: '售後服務專員',
                        description: '處理售後服務相關問題，包括維修、退換貨、保固等服務。',
                        category: 'user-examples',
                        tags: ['售後', '維修', '保固'],
                        assistantName: '售後服務專員',
                        assistantDescription: '提供專業的售後服務支援，解決顧客的產品使用問題。',
                        knowledge: [
                            { q: '產品有問題如何處理？', a: '請先聯繫客服說明問題，我們會安排技術人員協助解決。', category: 'support' },
                            { q: '保固期是多久？', a: '一般產品提供一年保固，詳細保固條款請見產品說明。', category: 'warranty' },
                            { q: '如何申請維修？', a: '請填寫維修申請表並寄回產品，我們會盡快為您處理。', category: 'repair' },
                            { q: '退換貨需要什麼條件？', a: '產品需在鑑賞期內且保持原狀，詳細條件請見退換貨政策。', category: 'return' }
                        ]
                    },
                    {
                        id: 8,
                        key: 'appointment-faq',
                        title: '預約服務助手',
                        description: '協助顧客了解預約流程、時間安排和服務內容。',
                        category: 'user-examples',
                        tags: ['預約', '時間', '服務'],
                        assistantName: '預約服務助手',
                        assistantDescription: '提供預約服務相關資訊，協助顧客順利安排服務時間。',
                        knowledge: [
                            { q: '如何預約服務？', a: '您可透過官網預約系統、電話或LINE官方帳號進行預約。', category: 'booking' },
                            { q: '可以取消或更改預約嗎？', a: '請於服務前24小時聯繫我們取消或更改預約時間。', category: 'cancel' },
                            { q: '預約需要提前多久？', a: '建議提前3-7天預約，熱門時段可能需要更早預約。', category: 'timing' },
                            { q: '預約費用如何計算？', a: '預約費用依服務項目而定，詳細價格請見服務價目表。', category: 'pricing' }
                        ]
                    },
                    {
                        id: 9,
                        key: 'product-info',
                        title: '產品資訊專員',
                        description: '提供詳細的產品資訊、規格說明和使用指南。',
                        category: 'user-examples',
                        tags: ['產品', '規格', '使用'],
                        assistantName: '產品資訊專員',
                        assistantDescription: '提供完整的產品資訊，協助顧客了解產品特色和使用方法。',
                        knowledge: [
                            { q: '產品有哪些特色？', a: '我們的產品具有高品質、耐用性佳、操作簡便等特色。', category: 'features' },
                            { q: '產品規格是什麼？', a: '詳細規格請參考產品頁面，或聯繫客服取得完整規格表。', category: 'specs' },
                            { q: '如何使用產品？', a: '產品附有詳細使用說明書，也可觀看官網教學影片。', category: 'usage' },
                            { q: '產品適合什麼人使用？', a: '產品適合各年齡層使用，特別適合追求品質的消費者。', category: 'target' }
                        ]
                    },
                    {
                        id: 10,
                        key: 'membership-benefits',
                        title: '會員福利專員',
                        description: '介紹會員制度、專屬優惠和累積點數等福利。',
                        category: 'user-examples',
                        tags: ['會員', '優惠', '點數'],
                        assistantName: '會員福利專員',
                        assistantDescription: '介紹會員專屬福利，協助顧客了解如何享受更多優惠。',
                        knowledge: [
                            { q: '如何成為會員？', a: '註冊帳號即可成為會員，享受專屬優惠和累積點數。', category: 'join' },
                            { q: '會員有什麼優惠？', a: '會員享有生日優惠、專屬折扣、免運費等多項福利。', category: 'benefits' },
                            { q: '點數如何累積？', a: '每消費1元累積1點，點數可兌換商品或折抵現金。', category: 'points' },
                            { q: '會員等級如何提升？', a: '依消費金額自動升級，等級越高享受更多專屬優惠。', category: 'level' }
                        ]
                    },
                    {
                        id: 3,
                        key: 'survey',
                        title: '客戶滿意度調查',
                        description: '自動發送調查問卷，收集客戶反饋',
                        category: 'survey',
                        tags: ['調查', '客戶反饋', '問卷'],
                        assistantName: '滿意度小幫手',
                        assistantDescription: '引導使用者完成簡短調查，以蒐集服務品質回饋。',
                        knowledge: [
                            { q: '調查題目：整體滿意度', a: '請以 1-5 分評分您對本服務的整體滿意度。', category: 'survey' },
                            { q: '調查題目：建議與回饋', a: '請描述我們可以改進的地方，您的意見非常重要。', category: 'survey' }
                        ]
                    },
                    {
                        id: 4,
                        key: 'appointment',
                        title: '預約系統',
                        description: '智能預約管理，自動安排時間',
                        category: 'appointment',
                        tags: ['預約', '時間管理', '自動安排'],
                        assistantName: '預約助理',
                        assistantDescription: '協助安排預約時段並提供提醒。',
                        knowledge: [
                            { q: '可預約時段', a: '本服務可接受下週一至週五 10:00-17:00 的預約。', category: 'schedule' },
                            { q: '如何取消預約？', a: '請於 24 小時前透過本系統提出取消申請。', category: 'policy' }
                        ]
                    },
                    {
                        id: 5,
                        key: 'sales-assistant',
                        title: '產品推薦系統',
                        description: '基於用戶行為的智能產品推薦',
                        category: 'chat',
                        tags: ['推薦', '智能分析', '個人化'],
                        assistantName: '銷售助理',
                        assistantDescription: '根據需求推薦最合適的產品。',
                        knowledge: [
                            { q: '熱門商品有哪些？', a: '目前最受歡迎的商品為 A、B、C 三款。', category: 'product' },
                            { q: '是否有折扣活動？', a: '新用戶首購享 9 折優惠，特殊節日另有活動。', category: 'promotion' }
                        ]
                    }
                ];
                
                renderUseCases(useCases);
            }
            
            // 渲染使用案例卡片
            function renderUseCases(useCases) {
                const grid = document.getElementById('useCaseGrid');
                if (!grid) return;
                
                grid.innerHTML = useCases.map(useCase => `
                    <div class="col-lg-4 col-md-6" data-category="${useCase.category}">
                        <div class="card use-case-card h-100">
                            <div class="card-body">
                                <div class="mb-3">
                                    <h5 class="card-title mb-0">${useCase.title}</h5>
                                </div>
                                <p class="card-text text-muted mb-3">${useCase.description}</p>

                                <div class="mb-3">
                                    ${useCase.tags.map(tag => `<span class="badge badge-secondary me-1">${tag}</span>`).join('')}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="startUseCase(${useCase.id})">
                                        <i class="fas fa-play me-1"></i>開始使用
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // 過濾使用案例
            function filterUseCases(category) {
                console.log('過濾使用案例:', category);
                
                // 更新按鈕狀態
                document.querySelectorAll('.btn-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-filter="${category}"]`).classList.add('active');
                
                // 過濾卡片
                const cards = document.querySelectorAll('#useCaseGrid .col-lg-4');
                cards.forEach(card => {
                    if (category === 'all' || card.dataset.category === category) {
                        card.style.display = 'block';
                        } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            // 選擇使用案例
            async function startUseCase(id) {
                try {
                    console.log('開始套用使用案例:', id);
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入再使用此功能', 'warning');
                        return;
                    }

                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';

                    // 取得完整模板
                    const templates = typeof loadUseCases === 'function' ? undefined : undefined; // 佔位避免壓縮器移除
                    const templateList = [
                        { id: 1, key: 'customer-service' },
                        { id: 2, key: 'user-examples' },
                        { id: 6, key: 'shopping-process' },
                        { id: 7, key: 'after-sales' },
                        { id: 8, key: 'appointment-faq' },
                        { id: 9, key: 'product-info' },
                        { id: 10, key: 'membership-benefits' },
                        { id: 3, key: 'survey' },
                        { id: 4, key: 'appointment' },
                        { id: 5, key: 'sales-assistant' }
                    ];

                    // 重新產生一次用例資料（與 loadUseCases 同步）
                    const useCase = (function makeTemplates(){
                        const list = [];
                        // 與前面陣列一致（精簡再造）
                        const tpl = {
                            1:{name:'客服小幫手',desc:'提供即時客服回覆與常見問題解答。',key:'customer-service',knowledge:[
                                {q:'營業時間是什麼？',a:'我們的營業時間為週一至週五 09:00-18:00。',category:'faq'},
                                {q:'如何聯絡客服？',a:'您可以透過網站聯絡表單或來信 contact@echochat.com.tw 與我們聯繫。',category:'faq'},
                                {q:'是否提供退款？',a:'若您於購買後 7 天內不滿意，我們提供無條件退款。',category:'policy'}]},
                            2:{name:'使用者範例庫',desc:'提供常見問答模板，協助您快速建立高品質知識庫內容。',key:'user-examples',knowledge:[
                                {q:'營業時間是什麼？',a:'我們的營業時間為週一至週五 09:00-18:00。',category:'faq'},
                                {q:'如何聯絡客服？',a:'您可以透過網站聯絡表單或來信 contact@echochat.com.tw 與我們聯繫。',category:'faq'}]},
                            6:{name:'購物流程助手',desc:'提供完整的購物流程指引，協助顧客順利完成購買。',key:'shopping-process',knowledge:[
                                {q:'如何下單購買？',a:'請先選擇商品，加入購物車後點擊結帳，填寫收件資訊即可完成訂單。',category:'guide'},
                                {q:'支援哪些付款方式？',a:'我們支援信用卡、ATM轉帳、超商代碼繳費等多種付款方式。',category:'payment'}]},
                            7:{name:'售後服務專員',desc:'提供專業的售後服務支援，解決顧客的產品使用問題。',key:'after-sales',knowledge:[
                                {q:'產品有問題如何處理？',a:'請先聯繫客服說明問題，我們會安排技術人員協助解決。',category:'support'},
                                {q:'保固期是多久？',a:'一般產品提供一年保固，詳細保固條款請見產品說明。',category:'warranty'}]},
                            8:{name:'預約服務助手',desc:'提供預約服務相關資訊，協助顧客順利安排服務時間。',key:'appointment-faq',knowledge:[
                                {q:'如何預約服務？',a:'您可透過官網預約系統、電話或LINE官方帳號進行預約。',category:'booking'},
                                {q:'可以取消或更改預約嗎？',a:'請於服務前24小時聯繫我們取消或更改預約時間。',category:'cancel'}]},
                            9:{name:'產品資訊專員',desc:'提供完整的產品資訊，協助顧客了解產品特色和使用方法。',key:'product-info',knowledge:[
                                {q:'產品有哪些特色？',a:'我們的產品具有高品質、耐用性佳、操作簡便等特色。',category:'features'},
                                {q:'產品規格是什麼？',a:'詳細規格請參考產品頁面，或聯繫客服取得完整規格表。',category:'specs'}]},
                            10:{name:'會員福利專員',desc:'介紹會員專屬福利，協助顧客了解如何享受更多優惠。',key:'membership-benefits',knowledge:[
                                {q:'如何成為會員？',a:'註冊帳號即可成為會員，享受專屬優惠和累積點數。',category:'join'},
                                {q:'會員有什麼優惠？',a:'會員享有生日優惠、專屬折扣、免運費等多項福利。',category:'benefits'}]},
                            3:{name:'滿意度小幫手',desc:'引導使用者完成簡短調查，以蒐集服務品質回饋。',key:'survey',knowledge:[
                                {q:'調查題目：整體滿意度',a:'請以 1-5 分評分您對本服務的整體滿意度。',category:'survey'},
                                {q:'調查題目：建議與回饋',a:'請描述我們可以改進的地方，您的意見非常重要。',category:'survey'}]},
                            4:{name:'預約助理',desc:'協助安排預約時段並提供提醒。',key:'appointment',knowledge:[
                                {q:'可預約時段',a:'本服務可接受下週一至週五 10:00-17:00 的預約。',category:'schedule'},
                                {q:'如何取消預約？',a:'請於 24 小時前透過本系統提出取消申請。',category:'policy'}]},
                            5:{name:'銷售助理',desc:'根據需求推薦最合適的產品。',key:'sales-assistant',knowledge:[
                                {q:'熱門商品有哪些？',a:'目前最受歡迎的商品為 A、B、C 三款。',category:'product'},
                                {q:'是否有折扣活動？',a:'新用戶首購享 9 折優惠，特殊節日另有活動。',category:'promotion'}]}
                        };
                        return tpl[id];
                    })();

                    if (!useCase) {
                        showAlert('找不到對應的使用案例', 'danger');
                        return;
                    }

                    // 先讀取已有的知識，避免重複導入
                    let existing = [];
                    try {
                        const r = await fetch(`${baseUrl}/knowledge`, { headers: { 'Authorization': `Bearer ${token}` } });
                        existing = r.ok ? await r.json() : [];
                    } catch {}

                    // 建立標記用 tags
                    const templateTag = `template:${useCase.key}`;

                    // 批次建立知識
                    let createdCount = 0;
                    for (const item of useCase.knowledge) {
                        const dup = existing.find(x => (x.tags||'').includes(templateTag) && x.question === item.q);
                        if (dup) continue;
                        try {
                            const resp = await fetch(`${baseUrl}/knowledge`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    question: item.q,
                                    answer: item.a,
                                    category: item.category || '一般',
                                    tags: templateTag
                                })
                            });
                            const data = await resp.json();
                            if (resp.ok && data && data.success) createdCount++;
                        } catch {}
                    }

                    // 更新 AI 助理配置（讀取後更新 use_case 與描述、名稱，保留原模型設定）
                    try {
                        const getCfg = await fetch(`${baseUrl}/ai-assistant-config`, { headers: { 'Authorization': `Bearer ${token}` } });
                        let cfg = { assistant_name: useCase.name, llm: 'gpt-4o-mini', use_case: useCase.key, description: useCase.desc };
                        if (getCfg.ok) {
                            const d = await getCfg.json();
                            if (d && d.success && d.config) cfg = { ...d.config };
                        }
                        cfg.assistant_name = useCase.name;
                        cfg.use_case = useCase.key;
                        cfg.description = useCase.desc;
                        await fetch(`${baseUrl}/ai-assistant-config`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(cfg)
                        });
                    } catch {}

                    showAlert(`使用案例已套用！新增知識 ${createdCount} 筆。`, 'success');
                    // 導航到知識庫或 AI 助理設定，方便使用者查看
                    switchTab('knowledge');
                } catch (e) {
                    console.error(e);
                    showAlert('套用使用案例失敗，請稍後再試', 'danger');
                }
            }

            // 舊名稱相容
            function selectUseCase(id) { startUseCase(id); }
            

            
            // 請求新的使用案例
            function requestNewUseCase() {
                console.log('請求新的使用案例');
                showAlert('新使用案例功能已可用', 'info');
            }
            

            
            // ==================== 整合功能 ====================
            
            // 載入整合數據
            function loadIntegrations() {
                console.log('載入整合數據...');
                
                // 載入一般整合
                loadGeneralIntegrations();
                
                // 載入SeaX整合
                loadSeaXIntegrations();
                
                // 載入客製整合
                loadCustomIntegrations();
            }
            
            // 載入一般整合
            function loadGeneralIntegrations() {
                const integrations = [
                    {
                        id: 1,
                        name: 'LINE',
                        description: 'LINE 聊天機器人整合',
                        icon: 'fab fa-line',
                        category: 'integration'
                    },
                    {
                        id: 2,
                        name: 'Facebook Messenger',
                        description: 'Facebook Messenger 整合',
                        icon: 'fab fa-facebook-messenger',
                        category: 'integration'
                    },
                    {
                        id: 3,
                        name: 'Telegram',
                        description: 'Telegram 機器人整合',
                        icon: 'fab fa-telegram',
                        category: 'integration'
                    },
                    {
                        id: 4,
                        name: 'WhatsApp',
                        description: 'WhatsApp Business API 整合',
                        icon: 'fab fa-whatsapp',
                        category: 'integration'
                    }
                ];
                
                renderIntegrations(integrations, 'integrationsGrid');
            }
            
            // 載入SeaX整合
            function loadSeaXIntegrations() {
                const seaxIntegrations = [
                    {
                        id: 101,
                        name: 'SeaX CRM',
                        description: '客戶關係管理系統整合',
                        icon: 'fas fa-users',
                        category: 'seax'
                    },
                    {
                        id: 102,
                        name: 'SeaX Analytics',
                        description: '數據分析平台整合',
                        icon: 'fas fa-chart-line',
                        category: 'seax'
                    },
                    {
                        id: 103,
                        name: 'SeaX Commerce',
                        description: '電商平台整合',
                        icon: 'fas fa-shopping-cart',
                        category: 'seax'
                    }
                ];
                
                renderIntegrations(seaxIntegrations, 'seaxIntegrationsGrid');
            }
            
            // 載入客製整合
            function loadCustomIntegrations() {
                const customIntegrations = [
                    {
                        id: 201,
                        name: 'API 整合',
                        description: '自定義 API 整合服務',
                        icon: 'fas fa-code',
                        category: 'custom'
                    },
                    {
                        id: 202,
                        name: '資料庫整合',
                        description: '外部資料庫連接整合',
                        icon: 'fas fa-database',
                        category: 'custom'
                    },
                    {
                        id: 203,
                        name: '第三方服務',
                        description: '第三方服務平台整合',
                        icon: 'fas fa-plug',
                        category: 'custom'
                    }
                ];
                
                renderIntegrations(customIntegrations, 'customIntegrationsGrid');
            }
            
            // 渲染整合卡片
            function renderIntegrations(integrations, gridId) {
                const grid = document.getElementById(gridId);
                if (!grid) {
                    console.log('找不到網格容器:', gridId);
                    return;
                }
                
                grid.innerHTML = integrations.map(integration => `
                    <div class="col-lg-3 col-md-6">
                        <div class="card integration-card h-100">
                            <div class="card-body text-center">
                                <div class="integration-icon mx-auto mb-3">
                                    <i class="${integration.icon} fa-2x text-primary"></i>
                        </div>
                                <h6 class="card-title">${integration.name}</h6>
                                <p class="card-text text-muted small">${integration.description}</p>
                                <button class="btn btn-primary btn-sm" onclick="setupIntegration(${integration.id}, '${integration.category}')">
                                    設定整合
                                </button>
                            </div>
                            </div>
                        </div>
                `).join('');
            }
            
            // 設定整合
            function setupIntegration(id, category) {
                console.log('設定整合:', id, '類別:', category);
                
                // 根據整合類型顯示對應的設定模態框
                switch(category) {
                    case 'integration':
                        showIntegrationModal(id);
                        break;
                    case 'seax':
                        showSeaXIntegrationModal(id);
                        break;
                    case 'custom':
                        showCustomIntegrationModal(id);
                        break;
                    default:
                        showIntegrationModal(id);
                }
            }
            
            // 顯示一般整合設定模態框
            function showIntegrationModal(integrationId) {
                const integrationNames = {
                    1: 'LINE',
                    2: 'Facebook Messenger', 
                    3: 'Telegram',
                    4: 'WhatsApp'
                };
                
                const integrationName = integrationNames[integrationId] || '未知平台';
                
                const modalHtml = `
                    <div class="modal fade" id="integrationModal" tabindex="-1" aria-labelledby="integrationModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="integrationModalLabel">設定 ${integrationName} 整合</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="integrationForm">
                                        <div class="mb-3">
                                            <label for="integrationName" class="form-label">整合名稱</label>
                                            <input type="text" class="form-control" id="integrationName" value="${integrationName}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label for="webhookUrl" class="form-label">Webhook URL</label>
                                            <input type="url" class="form-control" id="webhookUrl" placeholder="https://your-domain.com/webhook" required>
                                            <div class="form-text">請將此 URL 設定到您的 ${integrationName} 應用程式設定中</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="accessToken" class="form-label">存取權杖</label>
                                            <input type="password" class="form-control" id="accessToken" placeholder="輸入您的存取權杖" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="secretKey" class="form-label">密鑰</label>
                                            <input type="password" class="form-control" id="secretKey" placeholder="輸入您的密鑰">
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableIntegration" checked>
                                                <label class="form-check-label" for="enableIntegration">
                                                    啟用此整合
                                                </label>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="saveIntegration(${integrationId})">儲存設定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除現有的模態框
                const existingModal = document.getElementById('integrationModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 顯示模態框
                const modal = new bootstrap.Modal(document.getElementById('integrationModal'));
                modal.show();
            }
            
            // 顯示 SeaX 整合設定模態框
            function showSeaXIntegrationModal(integrationId) {
                const seaxNames = {
                    101: 'SeaX CRM',
                    102: 'SeaX Analytics',
                    103: 'SeaX Marketing'
                };
                
                const integrationName = seaxNames[integrationId] || '未知 SeaX 服務';
                
                const modalHtml = `
                    <div class="modal fade" id="seaxIntegrationModal" tabindex="-1" aria-labelledby="seaxIntegrationModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="seaxIntegrationModalLabel">設定 ${integrationName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="seaxIntegrationForm">
                                        <div class="mb-3">
                                            <label for="seaxApiKey" class="form-label">API 金鑰</label>
                                            <input type="password" class="form-control" id="seaxApiKey" placeholder="輸入您的 SeaX API 金鑰" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="seaxEndpoint" class="form-label">API 端點</label>
                                            <input type="url" class="form-control" id="seaxEndpoint" placeholder="https://api.seax.com/v1" required>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableSeaXIntegration" checked>
                                                <label class="form-check-label" for="enableSeaXIntegration">
                                                    啟用此整合
                                                </label>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="saveSeaXIntegration(${integrationId})">儲存設定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除現有的模態框
                const existingModal = document.getElementById('seaxIntegrationModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 顯示模態框
                const modal = new bootstrap.Modal(document.getElementById('seaxIntegrationModal'));
                modal.show();
            }
            
            // 顯示客製整合設定模態框
            function showCustomIntegrationModal(integrationId) {
                const customNames = {
                    201: '自訂 API',
                    202: 'Webhook 整合',
                    203: '第三方服務'
                };
                
                const integrationName = customNames[integrationId] || '未知客製整合';
                
                const modalHtml = `
                    <div class="modal fade" id="customIntegrationModal" tabindex="-1" aria-labelledby="customIntegrationModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="customIntegrationModalLabel">設定 ${integrationName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="customIntegrationForm">
                                        <div class="mb-3">
                                            <label for="customName" class="form-label">整合名稱</label>
                                            <input type="text" class="form-control" id="customName" placeholder="輸入整合名稱" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customUrl" class="form-label">API URL</label>
                                            <input type="url" class="form-control" id="customUrl" placeholder="https://api.example.com" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customMethod" class="form-label">HTTP 方法</label>
                                            <select class="form-select" id="customMethod">
                                                <option value="GET">GET</option>
                                                <option value="POST" selected>POST</option>
                                                <option value="PUT">PUT</option>
                                                <option value="DELETE">DELETE</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customHeaders" class="form-label">請求標頭 (JSON 格式)</label>
                                            <textarea class="form-control" id="customHeaders" rows="3" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableCustomIntegration" checked>
                                                <label class="form-check-label" for="enableCustomIntegration">
                                                    啟用此整合
                                                </label>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="saveCustomIntegration(${integrationId})">儲存設定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除現有的模態框
                const existingModal = document.getElementById('customIntegrationModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 顯示模態框
                const modal = new bootstrap.Modal(document.getElementById('customIntegrationModal'));
                modal.show();
            }
            
            // 儲存一般整合設定
            async function saveIntegration(integrationId) {
                try {
                    const webhookUrl = document.getElementById('webhookUrl').value;
                    const accessToken = document.getElementById('accessToken').value;
                    const secretKey = document.getElementById('secretKey').value;
                    const enabled = document.getElementById('enableIntegration').checked;
                    
                    if (!webhookUrl || !accessToken) {
                        showAlert('請填寫必要欄位', 'warning');
                        return;
                    }
                    
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const response = await fetch(`${window.API_BASE_URL || 'https://echochat-api.onrender.com/api'}/integrations`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            integrationId,
                            webhookUrl,
                            accessToken,
                            secretKey,
                            enabled
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        showAlert('整合設定已儲存', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('integrationModal'));
                        modal.hide();
                    } else {
                        showAlert(data.error || '儲存失敗', 'danger');
                    }
                } catch (error) {
                    console.error('儲存整合設定失敗:', error);
                    showAlert('儲存失敗，請稍後再試', 'danger');
                }
            }
            
            // 儲存 SeaX 整合設定
            async function saveSeaXIntegration(integrationId) {
                try {
                    const apiKey = document.getElementById('seaxApiKey').value;
                    const endpoint = document.getElementById('seaxEndpoint').value;
                    const enabled = document.getElementById('enableSeaXIntegration').checked;
                    
                    if (!apiKey || !endpoint) {
                        showAlert('請填寫必要欄位', 'warning');
                        return;
                    }
                    
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const response = await fetch(`${window.API_BASE_URL || 'https://echochat-api.onrender.com/api'}/integrations/seax`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            integrationId,
                            apiKey,
                            endpoint,
                            enabled
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        showAlert('SeaX 整合設定已儲存', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('seaxIntegrationModal'));
                        modal.hide();
                    } else {
                        showAlert(data.error || '儲存失敗', 'danger');
                    }
                } catch (error) {
                    console.error('儲存 SeaX 整合設定失敗:', error);
                    showAlert('儲存失敗，請稍後再試', 'danger');
                }
            }
            
            // 儲存客製整合設定
            async function saveCustomIntegration(integrationId) {
                try {
                    const name = document.getElementById('customName').value;
                    const url = document.getElementById('customUrl').value;
                    const method = document.getElementById('customMethod').value;
                    const headers = document.getElementById('customHeaders').value;
                    const enabled = document.getElementById('enableCustomIntegration').checked;
                    
                    if (!name || !url) {
                        showAlert('請填寫必要欄位', 'warning');
                        return;
                    }
                    
                    // 驗證 JSON 格式的標頭
                    let parsedHeaders = {};
                    if (headers.trim()) {
                        try {
                            parsedHeaders = JSON.parse(headers);
                        } catch (e) {
                            showAlert('請求標頭格式不正確，請使用有效的 JSON 格式', 'warning');
                            return;
                        }
                    }
                    
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const response = await fetch(`${window.API_BASE_URL || 'https://echochat-api.onrender.com/api'}/integrations/custom`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            integrationId,
                            name,
                            url,
                            method,
                            headers: parsedHeaders,
                            enabled
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        showAlert('客製整合設定已儲存', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('customIntegrationModal'));
                        modal.hide();
                    } else {
                        showAlert(data.error || '儲存失敗', 'danger');
                    }
                } catch (error) {
                    console.error('儲存客製整合設定失敗:', error);
                    showAlert('儲存失敗，請稍後再試', 'danger');
                }
            }
            
            // 已移除側邊欄切換功能與初始化邏輯
            
            // ==================== 對話管理功能 ====================
            
            // 載入對話數據
            async function loadConversations() {
                console.log('載入對話數據...');
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        console.log('未找到認證令牌，使用範例數據');
                        initExampleConversations();
                        return;
                    }

                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/conversations', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const list = Array.isArray(data) ? data : (data.conversations || []);
                        console.log('✅ 載入對話成功，數量:', list.length);
                        displayRealConversations(list);
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        initExampleConversations();
                    } else {
                        console.log('API 請求失敗');
                        displayRealConversations([]);
                    }
                } catch (error) {
                    console.error('載入對話數據失敗:', error);
                    console.log('使用範例數據作為備用');
                    initExampleConversations();
                }
            }
            
            // 顯示真實對話數據
            function displayRealConversations(conversations) {
                console.log('顯示真實對話數據:', conversations);
                console.log('對話數量:', conversations.length);
                const container = document.getElementById('conversationList');
                if (!container) {
                    console.log('找不到對話列表容器');
                    return;
                }

                container.innerHTML = '';

                if (conversations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-comments text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">尚無對話記錄</p>
                            <p class="text-muted small">開始與 AI 助理對話或串接 LINE 等平台來查看對話</p>
                        </div>
                    `;
                    return;
                }

                conversations.forEach(conversation => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item d-flex align-items-center p-3 border-bottom';
                    item.style.cursor = 'pointer';
                    item.style.transition = 'background-color 0.2s';
                    
                    // 判斷平台類型（基於對話內容或ID）
                    const platformInfo = detectPlatformFromConversation(conversation);
                    
                    const picUrl = conversation.customerPicture || null;
                    const picHtml = picUrl 
                        ? `<img src="${picUrl}" class="rounded-circle" width="48" height="48" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" /><div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;display:none;"><i class="fas fa-user text-white"></i></div>`
                        : `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;"><i class="fas fa-user text-white"></i></div>`;
                    
                    item.innerHTML = `
                        <div class="me-3">
                            ${picHtml}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1">${conversation.customerName || platformInfo.name}</h6>
                                <small class="text-muted">${formatTime(conversation.updatedAt || new Date().toISOString())}</small>
                            </div>
                            <p class="mb-1 text-muted small">${conversation.lastMessage || '無訊息'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted"><i class="${platformInfo.icon} ${platformInfo.color} me-1"></i>${conversation.messageCount || 0} 條訊息</small>
                                <span class="badge bg-${platformInfo.statusColor}">${platformInfo.status}</span>
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => loadRealConversation(conversation.id));
                    item.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f8f9fa';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    container.appendChild(item);
                });
            }

            // 從對話內容判斷平台類型
            function detectPlatformFromConversation(conversation) {
                // 預設為 LINE（因為目前主要支援 LINE）
                const defaultPlatform = {
                    name: 'LINE 對話',
                    icon: 'fab fa-line',
                    color: 'text-success',
                    status: '線上',
                    statusColor: 'success'
                };

                // 如果有訊息內容，可以進一步分析
                if (conversation.messages && conversation.messages.length > 0) {
                    const lastMessage = conversation.messages[conversation.messages.length - 1];
                    if (lastMessage.content) {
                        // 可以根據訊息內容或時間戳判斷平台
                        // 這裡先使用預設的 LINE 設定
                        return defaultPlatform;
                    }
                }

                return defaultPlatform;
            }

            // 格式化時間
            function formatTime(timestamp) {
                if (!timestamp) return '未知時間';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffMins < 1) return '剛剛';
                if (diffMins < 60) return `${diffMins} 分鐘前`;
                if (diffHours < 24) return `${diffHours} 小時前`;
                if (diffDays < 7) return `${diffDays} 天前`;
                
                return date.toLocaleDateString('zh-TW');
            }

            function getConversationLastTimestamp(conversation) {
                if (!conversation || !Array.isArray(conversation.messages) || !conversation.messages.length) {
                    return conversation?.updatedAt || conversation?.createdAt || '';
                }
                const last = conversation.messages[conversation.messages.length - 1];
                return last?.timestamp || conversation?.updatedAt || conversation?.createdAt || '';
            }

            function scrollChatToBottom() {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // 載入真實對話詳情
            async function loadRealConversation(conversationId) {
                console.log('載入真實對話:', conversationId);
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        console.log('未找到認證令牌，無法載入對話詳情');
                        return;
                    }
                    
                    // 保存當前對話 ID
                    let currentConversationIdInput = document.getElementById('currentConversationId');
                    if (!currentConversationIdInput) {
                        currentConversationIdInput = document.createElement('input');
                        currentConversationIdInput.type = 'hidden';
                        currentConversationIdInput.id = 'currentConversationId';
                        document.body.appendChild(currentConversationIdInput);
                    }
                    currentConversationIdInput.value = conversationId;
                    
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/conversations/' + conversationId, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            displayRealMessages(data.conversation);
                            // 開始即時更新
                            startConversationUpdates();
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        console.log('無法載入對話詳情，認證已過期');
                    }
                } catch (error) {
                    console.error('載入對話詳情失敗:', error);
                }
            }

            // 顯示真實訊息
            function displayRealMessages(conversation) {
                console.log('顯示真實訊息:', conversation);
                
                // 更新對話標題
                const platformInfo = detectPlatformFromConversation(conversation);
                document.getElementById('currentConversationName').textContent = platformInfo.name;
                document.getElementById('currentConversationStatus').textContent = platformInfo.status;
                document.getElementById('currentPlatformIcon').innerHTML = `<i class="${platformInfo.icon} ${platformInfo.color}"></i>`;
                
                // 顯示訊息
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                const lastTimestamp = getConversationLastTimestamp(conversation);
                if (lastTimestamp) {
                    chatMessages.dataset.lastMessageTs = lastTimestamp;
                } else {
                    delete chatMessages.dataset.lastMessageTs;
                }
                chatMessages.dataset.messageCount = String(
                    Array.isArray(conversation.messages) ? conversation.messages.length : 0
                );
                
                if (conversation.messages && conversation.messages.length > 0) {
                    conversation.messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        // 客戶傳來的(user)顯示在左邊，我方回覆(assistant)顯示在右邊
                        const isCustomer = message.role === 'user';
                        const aiBadge = message.isAutoReply
                            ? '<span class="badge bg-info text-dark ms-2">AI 回覆</span>'
                            : '';
                        messageDiv.className = `d-flex ${isCustomer ? 'justify-content-start' : 'justify-content-end'} mb-3`;
                        
                        const time = formatTime(message.timestamp);
                        
                        messageDiv.innerHTML = `
                            <div class="d-flex ${isCustomer ? '' : 'flex-row-reverse'} align-items-end">
                                <div class="${isCustomer ? 'me-2' : 'ms-2'}">
                                    <div class="bg-${isCustomer ? 'light' : 'primary'} rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <i class="fas fa-${isCustomer ? 'user' : 'robot'} text-${isCustomer ? 'muted' : 'white'}" style="font-size: 12px;"></i>
                                    </div>
                                </div>
                                <div class="bg-${isCustomer ? 'white' : 'primary'} text-${isCustomer ? 'dark' : 'white'} p-3 rounded-3 shadow-sm" style="max-width: 70%; border-radius: ${isCustomer ? '15px 15px 15px 5px' : '15px 15px 5px 15px'} !important;">
                                    <span>${message.content}</span>
                                    <div class="small text-${isCustomer ? 'muted' : 'white-50'} mt-1">
                                        <i class="fas fa-clock me-1"></i>${time}${aiBadge}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        chatMessages.appendChild(messageDiv);
                    });
                } else {
                    chatMessages.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-comments text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-3">此對話尚無訊息</p>
                        </div>
                    `;
                }
                
                // 更新自動回覆設定 UI
                const autoReplySwitch = document.getElementById('autoReplySwitch');
                const autoReplyLabel = document.getElementById('autoReplyLabel');
                const hintElement = document.getElementById('replyHint');
                const messageInput = document.getElementById('messageInput');
                
                if (autoReplySwitch) {
                    // 根據對話設定更新開關狀態
                    const autoReplyEnabled = conversation.autoReplyEnabled !== false; // 預設為開啟
                    autoReplySwitch.checked = autoReplyEnabled;
                    autoReplyLabel.textContent = autoReplyEnabled ? '自動回覆' : '轉人工';
                    const statusText = document.getElementById('autoReplyStatusText');
                    if (statusText) {
                        statusText.textContent = autoReplyEnabled ? '自動回覆中' : '已轉人工';
                        statusText.className = `badge ${autoReplyEnabled ? 'bg-success' : 'bg-secondary'}`;
                    }
                    
                    // 更新提示文字和輸入框狀態
                    hintElement.textContent = autoReplyEnabled ? 
                        '自動回覆模式：AI 會自動回覆客戶訊息' : 
                        '手動回覆模式：輸入訊息後按 Enter 或點擊發送按鈕';
                    messageInput.disabled = autoReplyEnabled;
                    messageInput.placeholder = autoReplyEnabled ? 
                        '自動回覆模式：無法手動輸入' : 
                        '回覆客戶訊息...';
                }
                
                // 啟用發送按鈕
                document.getElementById('sendMessageBtn').disabled = false;
                
                // 滾動到底部
                scrollChatToBottom();
            }

            // 發送人工回覆訊息
            async function sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) {
                    alert('請輸入回覆訊息');
                    return;
                }
                
                const currentConversationId = document.getElementById('currentConversationId');
                if (!currentConversationId || !currentConversationId.value) {
                    alert('請先選擇一個對話');
                    return;
                }
                
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        alert('認證已過期，請重新登入');
                        return;
                    }
                    
                    // 禁用發送按鈕
                    const sendBtn = document.getElementById('sendMessageBtn');
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/line/manual-reply', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            conversationId: currentConversationId.value,
                            message: message
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 清空輸入框
                            messageInput.value = '';
                            
                            // 重新載入對話以顯示新訊息
                            await loadRealConversation(currentConversationId.value);
                            
                            // 不顯示浮動提示，避免干擾
                        } else {
                            alert('發送失敗：' + (data.error || '未知錯誤'));
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        alert('發送失敗：' + (errorData.error || '網路錯誤'));
                    }
                } catch (error) {
                    console.error('發送訊息失敗:', error);
                    alert('發送失敗：' + error.message);
                } finally {
                    // 重新啟用發送按鈕
                    const sendBtn = document.getElementById('sendMessageBtn');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }
            
            // 處理 Enter 鍵發送
            function handleMessageKeyPress(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            }
            
            // 切換自動回覆設定
            async function toggleAutoReply() {
                const switchElement = document.getElementById('autoReplySwitch');
                const labelElement = document.getElementById('autoReplyLabel');
                const hintElement = document.getElementById('replyHint');
                const messageInput = document.getElementById('messageInput');
                const currentConversationId = document.getElementById('currentConversationId');
                
                if (!currentConversationId || !currentConversationId.value) {
                    alert('請先選擇一個對話');
                    switchElement.checked = !switchElement.checked; // 恢復原狀態
                    return;
                }
                
                const autoReplyEnabled = switchElement.checked;
                
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        alert('認證已過期，請重新登入');
                        switchElement.checked = !switchElement.checked; // 恢復原狀態
                        return;
                    }
                    
                    // 禁用開關
                    switchElement.disabled = true;
                    
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/conversation/toggle-auto-reply', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            conversationId: currentConversationId.value,
                            autoReplyEnabled: autoReplyEnabled
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 更新 UI
                            labelElement.textContent = autoReplyEnabled ? '自動回覆' : '轉人工';
                            const statusText = document.getElementById('autoReplyStatusText');
                            if (statusText) {
                                statusText.textContent = autoReplyEnabled ? '自動回覆中' : '已轉人工';
                                statusText.className = `badge ${autoReplyEnabled ? 'bg-success' : 'bg-secondary'}`;
                            }
                            hintElement.textContent = autoReplyEnabled ? 
                                '自動回覆模式：AI 會自動回覆客戶訊息' : 
                                '手動回覆模式：輸入訊息後按 Enter 或點擊發送按鈕';
                            messageInput.disabled = autoReplyEnabled;
                            messageInput.placeholder = autoReplyEnabled ? 
                                '自動回覆模式：無法手動輸入' : 
                                '回覆客戶訊息...';
                            
                            // 顯示成功訊息
                            showToast(data.message, 'success');
                        } else {
                            alert('切換失敗：' + (data.error || '未知錯誤'));
                            switchElement.checked = !switchElement.checked; // 恢復原狀態
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        alert('切換失敗：' + (errorData.error || '網路錯誤'));
                        switchElement.checked = !switchElement.checked; // 恢復原狀態
                    }
                } catch (error) {
                    console.error('切換自動回覆設定失敗:', error);
                    alert('切換失敗：' + error.message);
                    switchElement.checked = !switchElement.checked; // 恢復原狀態
                } finally {
                    // 重新啟用開關
                    switchElement.disabled = false;
                }
            }
            
            // 顯示 Toast 訊息
            function showToast(message, type = 'info') {
                // 創建 toast 元素
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                // 添加到頁面
                let toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toastContainer';
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }
                
                toastContainer.appendChild(toast);
                
                // 顯示 toast
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                // 自動移除
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }

            // 即時更新對話功能
            let conversationUpdateInterval = null;
            
            function startConversationUpdates() {
                // 每 5 秒檢查一次新訊息
                conversationUpdateInterval = setInterval(async () => {
                    const currentConversationId = document.getElementById('currentConversationId');
                    if (currentConversationId && currentConversationId.value) {
                        try {
                            const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                            if (!token) return;
                            
                            const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                            const response = await fetch(apiBase + '/conversations/' + currentConversationId.value, {
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.success && data.conversation) {
                                    // 檢查是否有新訊息
                                    const chatMessages = document.getElementById('chatMessages');
                                    const currentLastTs = chatMessages.dataset.lastMessageTs || '';
                                    const currentCount = parseInt(chatMessages.dataset.messageCount || '0', 10);
                                    const newLastTs = getConversationLastTimestamp(data.conversation);
                                    const newCount = Array.isArray(data.conversation.messages) ? data.conversation.messages.length : 0;
                                    
                                    if ((newLastTs && newLastTs !== currentLastTs) || newCount !== currentCount) {
                                        console.log('🔄 檢測到新訊息，更新對話');
                                        displayRealMessages(data.conversation);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('檢查新訊息失敗:', error);
                        }
                    }
                }, 5000); // 每 5 秒檢查一次
            }
            
            function stopConversationUpdates() {
                if (conversationUpdateInterval) {
                    clearInterval(conversationUpdateInterval);
                    conversationUpdateInterval = null;
                }
            }
            
            // 當切換到對話頁面時開始更新
            function onConversationPageEnter() {
                startConversationUpdates();
            }
            
            // 當離開對話頁面時停止更新
            function onConversationPageLeave() {
                stopConversationUpdates();
            }

            // ==================== LINE Bot 管理功能 ====================
            
            // 顯示 LINE Bot 管理模態框
            async function showLineBotManager() {
                const modal = new bootstrap.Modal(document.getElementById('lineBotManagerModal'));
                modal.show();
                await loadBots();
            }
            
            // 載入 Bot 列表
            async function loadBots() {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                if (!token) {
                    alert('請先登入');
                    return;
                }
                
                try {
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/line-bots', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            displayBots(data.bots);
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        alert('認證已過期，請重新登入');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('載入 Bot 列表失敗:', error);
                    showAlert('botListContainer', '載入 Bot 列表失敗', 'danger');
                }
            }
            
            // 顯示 Bot 列表
            function displayBots(bots) {
                const container = document.getElementById('botListContainer');
                
                if (bots.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="text-center py-4">
                                <i class="fas fa-robot text-muted" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-muted">還沒有任何 Bot</h5>
                                <p class="text-muted">點擊「創建新 LINE Bot」開始建立您的第一個 Bot</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = bots.map(bot => `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title mb-0">${bot.name}</h6>
                                    <span class="badge bg-${bot.status === 'active' ? 'success' : 'secondary'}">
                                        ${bot.status === 'active' ? '啟用中' : '已停用'}
                                    </span>
                                </div>
                                <p class="card-text text-muted small">${bot.description || '無描述'}</p>
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="fw-bold text-primary">${bot.message_count || 0}</div>
                                        <small class="text-muted">訊息</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold text-info">${bot.conversation_count || 0}</div>
                                        <small class="text-muted">對話</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold text-success">${formatDate(bot.created_at)}</div>
                                        <small class="text-muted">創建</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Webhook URL:</small>
                                    <div class="bg-light p-2 rounded small" style="font-family: monospace; word-break: break-all;">
                                        ${bot.webhook_url}
                                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${bot.webhook_url}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="btn-group w-100">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editBot('${bot.id}')">
                                        <i class="fas fa-edit"></i> 編輯
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewBotConversations('${bot.id}')">
                                        <i class="fas fa-comments"></i> 對話
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteBot('${bot.id}', '${bot.name}')">
                                        <i class="fas fa-trash"></i> 刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // 顯示創建 Bot 表單
            function showCreateBotForm() {
                document.getElementById('createBotForm').style.display = 'block';
                document.getElementById('createBotFormElement').reset();
                document.getElementById('createBotAlert').innerHTML = '';
            }
            
            // 隱藏創建 Bot 表單
            function hideCreateBotForm() {
                document.getElementById('createBotForm').style.display = 'none';
            }
            
            // 創建新 Bot
            document.getElementById('createBotFormElement').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                if (!token) {
                    alert('請先登入');
                    return;
                }
                
                const name = document.getElementById('botName').value.trim();
                const description = document.getElementById('botDescription').value.trim();
                const channelId = document.getElementById('channelId').value.trim();
                const channelAccessToken = document.getElementById('channelAccessToken').value.trim();
                const channelSecret = document.getElementById('channelSecret').value.trim();
                
                if (!name || !channelAccessToken || !channelSecret) {
                    showAlert('createBotAlert', '請填寫所有必要欄位', 'danger');
                    return;
                }
                
                try {
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/line-bots', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description,
                            channelId: channelId,
                            channelAccessToken: channelAccessToken,
                            channelSecret: channelSecret
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        showAlert('createBotAlert', 'Bot 創建成功！', 'success');
                        setTimeout(() => {
                            hideCreateBotForm();
                            loadBots();
                        }, 1500);
                    } else {
                        showAlert('createBotAlert', '創建失敗：' + (data.error || '未知錯誤'), 'danger');
                    }
                } catch (error) {
                    console.error('創建 Bot 失敗:', error);
                    showAlert('createBotAlert', '創建失敗：' + error.message, 'danger');
                }
            });
            
            // 編輯 Bot
            function editBot(botId) {
                alert('編輯功能將在後續版本中提供');
            }
            
            // 查看 Bot 對話
            function viewBotConversations(botId) {
                alert('對話查看功能將在後續版本中提供');
            }
            
            // 刪除 Bot
            async function deleteBot(botId, botName) {
                if (!confirm(`確定要刪除 Bot "${botName}" 嗎？\n\n這將同時刪除所有相關的對話記錄，此操作無法復原。`)) {
                    return;
                }
                
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                if (!token) {
                    alert('請先登入');
                    return;
                }
                
                try {
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api')) ? window.API_BASE_URL : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(apiBase + '/line-bots/' + botId, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        alert('Bot 刪除成功！');
                        loadBots();
                    } else {
                        alert('刪除失敗：' + (data.error || '未知錯誤'));
                    }
                } catch (error) {
                    console.error('刪除 Bot 失敗:', error);
                    alert('刪除失敗：' + error.message);
                }
            }
            
            // 複製到剪貼板
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-secondary');
                    }, 2000);
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗');
                });
            }
            
            // 格式化日期
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit'
                });
            }
            
            // 顯示提示訊息
            function showAlert(containerId, message, type) {
                const container = document.getElementById(containerId);
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                container.appendChild(alertDiv);
            }

            // 初始化範例對話功能
            function initExampleConversations() {
                console.log('初始化範例對話功能...');
                
                // 為範例對話卡片添加點擊效果
                const exampleCards = document.querySelectorAll('.example-conversation-card');
                exampleCards.forEach(card => {
                    card.style.cursor = 'pointer';
                    card.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    });
                    card.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = 'none';
                    });
                });
            }
            
            // 載入範例對話
            function loadExampleConversation(platform) {
                console.log('載入範例對話:', platform);
                
                const exampleData = {
                    line: {
                        name: 'LINE 美髮諮詢',
                        status: '線上',
                        icon: 'fab fa-line',
                        color: 'text-success',
                        messages: [
                            { sender: 'user', text: '你好，我想詢問染髮的價格', time: '14:30' },
                            { sender: 'assistant', text: '您好！歡迎詢問染髮服務。我們有不同價位的染髮套餐，請問您想要什麼顏色的染髮呢？', time: '14:31' },
                            { sender: 'user', text: '我想要染成棕色，大概要多少錢？', time: '14:32' },
                            { sender: 'assistant', text: '棕色染髮的價格是 $1,500-$2,500，視髮長而定。建議您先來店裡讓設計師評估，可以給您更精確的報價喔！', time: '14:33' }
                        ]
                    },
                    instagram: {
                        name: 'Instagram 造型預約',
                        status: '等待回覆',
                        icon: 'fab fa-instagram',
                        color: 'text-danger',
                        messages: [
                            { sender: 'user', text: '看了你們的髮型作品集，很喜歡！', time: '15:20' },
                            { sender: 'assistant', text: '謝謝您的喜歡！請問您想要預約什麼服務呢？', time: '15:21' },
                            { sender: 'user', text: '想要剪髮+造型，可以預約明天下午嗎？', time: '15:22' }
                        ]
                    },
                    facebook: {
                        name: 'Facebook 價格詢問',
                        status: '已回覆',
                        icon: 'fab fa-facebook',
                        color: 'text-primary',
                        messages: [
                            { sender: 'user', text: '剪髮+染髮套餐多少錢？', time: '16:15' },
                            { sender: 'assistant', text: '剪髮+染髮套餐價格是 $2,000-$3,500，包含洗髮、剪髮、染髮和造型。歡迎預約體驗！', time: '16:16' },
                            { sender: 'user', text: '好的，那我要預約下週二', time: '16:17' },
                            { sender: 'assistant', text: '好的！已為您預約下週二下午2點，請準時到店喔！', time: '16:18' }
                        ]
                    },
                    whatsapp: {
                        name: 'WhatsApp 緊急預約',
                        status: '緊急',
                        icon: 'fab fa-whatsapp',
                        color: 'text-success',
                        messages: [
                            { sender: 'user', text: '明天下午有空嗎？急需要剪髮', time: '17:45' },
                            { sender: 'assistant', text: '明天下午2點有空檔，可以為您安排！請問您大概幾點方便？', time: '17:46' },
                            { sender: 'user', text: '2點可以，謝謝！', time: '17:47' }
                        ]
                    },
                    telegram: {
                        name: 'Telegram 技術討論',
                        status: '技術支援',
                        icon: 'fab fa-telegram',
                        color: 'text-info',
                        messages: [
                            { sender: 'user', text: '請問燙髮後要怎麼保養？', time: '18:30' },
                            { sender: 'assistant', text: '燙髮後的保養很重要！建議使用專門的護髮產品，避免過度清洗，定期做護髮。', time: '18:31' },
                            { sender: 'user', text: '可以推薦一些護髮產品嗎？', time: '18:32' }
                        ]
                    },
                    discord: {
                        name: 'Discord 社群活動',
                        status: '活動',
                        icon: 'fab fa-discord',
                        color: 'text-primary',
                        messages: [
                            { sender: 'user', text: '聽說你們有美髮教學直播？', time: '19:00' },
                            { sender: 'assistant', text: '是的！每週五晚上8點有美髮教學直播，教大家簡單的造型技巧。', time: '19:01' },
                            { sender: 'user', text: '太棒了！我要參加', time: '19:02' }
                        ]
                    }
                };
                
                const data = exampleData[platform];
                if (!data) return;
                
                // 更新當前對話資訊
                document.getElementById('currentConversationName').textContent = data.name;
                document.getElementById('currentConversationStatus').textContent = data.status;
                document.getElementById('currentPlatformIcon').innerHTML = `<i class="${data.icon} ${data.color}"></i>`;
                
                // 顯示聊天訊息
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                data.messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                    messageDiv.className = `d-flex ${message.sender === 'user' ? 'justify-content-end' : 'justify-content-start'} mb-3`;
                        
                        messageDiv.innerHTML = `
                        <div class="d-flex ${message.sender === 'user' ? 'flex-row-reverse' : ''} align-items-end">
                                <div class="me-2">
                                <div class="bg-${message.sender === 'user' ? 'primary' : 'light'} rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    <i class="fas fa-${message.sender === 'user' ? 'user' : 'robot'} text-${message.sender === 'user' ? 'white' : 'muted'}" style="font-size: 12px;"></i>
                                    </div>
                                </div>
                            <div class="bg-${message.sender === 'user' ? 'primary' : 'white'} text-${message.sender === 'user' ? 'white' : 'dark'} p-3 rounded-3 shadow-sm" style="max-width: 70%; border-radius: ${message.sender === 'user' ? '15px 15px 5px 15px' : '15px 15px 15px 5px'} !important;">
                                <span>${message.text}</span>
                                <div class="small text-${message.sender === 'user' ? 'white-50' : 'muted'} mt-1">
                                    <i class="fas fa-clock me-1"></i>${message.time}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        chatMessages.appendChild(messageDiv);
                    });
                
                // 啟用輸入區域
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                
                // 滾動到底部
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // 過濾對話
            function filterConversations(platform) {
                console.log('過濾對話:', platform);
                
                // 更新過濾器按鈕狀態
                document.querySelectorAll('.btn-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-platform="${platform}"]`).classList.add('active');
                
                // 獲取所有對話項目
                const conversationItems = document.querySelectorAll('.conversation-item');
                
                conversationItems.forEach(item => {
                    const platformIcon = item.querySelector('.platform-icon i');
                    let shouldShow = false;
                    
                    if (platform === 'all') {
                        shouldShow = true;
                    } else if (platform === 'line' && platformIcon.classList.contains('fa-line')) {
                        shouldShow = true;
                    } else if (platform === 'instagram' && platformIcon.classList.contains('fa-instagram')) {
                        shouldShow = true;
                    } else if (platform === 'facebook' && platformIcon.classList.contains('fa-facebook')) {
                        shouldShow = true;
                    } else if (platform === 'whatsapp' && platformIcon.classList.contains('fa-whatsapp')) {
                        shouldShow = true;
                    } else if (platform === 'telegram' && platformIcon.classList.contains('fa-telegram')) {
                        shouldShow = true;
                    } else if (platform === 'discord' && platformIcon.classList.contains('fa-discord')) {
                        shouldShow = true;
                    } else if (platform === 'wechat' && platformIcon.classList.contains('fa-weixin')) {
                        shouldShow = true;
                    } else if (platform === 'web' && platformIcon.classList.contains('fa-globe')) {
                        shouldShow = true;
                    }
                    
                    // 顯示或隱藏對話項目
                    if (shouldShow) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // 更新對話列表標題
                const listHeader = document.querySelector('.card-header h6');
                const platformNames = {
                    'all': '對話列表',
                    'line': 'LINE 對話',
                    'instagram': 'Instagram 對話',
                    'facebook': 'Facebook 對話',
                    'whatsapp': 'WhatsApp 對話',
                    'telegram': 'Telegram 對話',
                    'discord': 'Discord 對話',
                    'wechat': '微信對話',
                    'web': '網站對話'
                };
                
                if (listHeader) {
                    listHeader.textContent = platformNames[platform] || '對話列表';
                }
            }
            
            // 標記為已讀
            function markAsRead() {
                console.log('標記為已讀');
                // TODO: 實現標記已讀功能
            }
            
            // 標記為已讀
            function markAsRead() {
                if (currentConversation) {
                    console.log('標記對話為已讀:', currentConversation);
                    // 更新對話狀態
                    const conversationItem = document.querySelector(`[onclick="selectConversation('${currentConversation}')"]`);
                    if (conversationItem) {
                        const badge = conversationItem.querySelector('.badge');
                        if (badge) {
                            badge.className = 'badge bg-success';
                            badge.textContent = '已回覆';
                        }
                    }
                    alert('對話已標記為已讀');
                }
            }
            
            // 轉接給其他員工
            function transferToStaff() {
                if (currentConversation) {
                    console.log('轉接對話:', currentConversation);
                    const staffMember = prompt('請輸入要轉接的員工姓名：');
                    if (staffMember) {
                        alert(`對話已轉接給 ${staffMember}`);
                    }
                }
            }
            
            // 封存對話
            function archiveConversation() {
                if (currentConversation) {
                    if (confirm('確定要封存此對話嗎？')) {
                        console.log('封存對話:', currentConversation);
                        alert('對話已封存');
                    }
                }
            }
            
            // ==================== 客服帳號管理功能 ====================
            
            // 顯示新增帳號模態框
            function showAddAccountModal() {
                const modal = `
                    <div class="modal fade" id="addAccountModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增客服帳號</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="card border h-100">
                                                <div class="card-body text-center p-4">
                                                    <i class="fab fa-line fa-3x text-success mb-3"></i>
                                                    <h6>LINE 帳號</h6>
                                                    <p class="text-muted small">連接 LINE 官方帳號</p>
                                                    <button class="btn btn-outline-success btn-sm" onclick="connectAccount('line')">
                                                        <i class="fab fa-line me-1"></i>連接 LINE
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border h-100">
                                                <div class="card-body text-center p-4">
                                                    <i class="fab fa-facebook fa-3x text-primary mb-3"></i>
                                                    <h6>Facebook 帳號</h6>
                                                    <p class="text-muted small">連接 Facebook 粉絲專頁</p>
                                                    <button class="btn btn-outline-primary btn-sm" onclick="connectAccount('facebook')">
                                                        <i class="fab fa-facebook me-1"></i>連接 Facebook
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border h-100">
                                                <div class="card-body text-center p-4">
                                                    <i class="fab fa-instagram fa-3x text-danger mb-3"></i>
                                                    <h6>Instagram 帳號</h6>
                                                    <p class="text-muted small">連接 Instagram 商業帳號</p>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="connectAccount('instagram')">
                                                        <i class="fab fa-instagram me-1"></i>連接 Instagram
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border h-100">
                                                <div class="card-body text-center p-4">
                                                    <i class="fab fa-whatsapp fa-3x text-success mb-3"></i>
                                                    <h6>WhatsApp 帳號</h6>
                                                    <p class="text-muted small">連接 WhatsApp Business</p>
                                                    <button class="btn btn-outline-success btn-sm" onclick="connectAccount('whatsapp')">
                                                        <i class="fab fa-whatsapp me-1"></i>連接 WhatsApp
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    `;
                
                // 移除舊的模態框
                const oldModal = document.getElementById('addAccountModal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // 顯示模態框
                const modalInstance = new bootstrap.Modal(document.getElementById('addAccountModal'));
                modalInstance.show();
            }
            
            // 連接帳號
            function connectAccount(platform) {
                console.log('連接帳號:', platform);
                
                // 模擬連接過程
                const loadingText = {
                    line: '正在連接 LINE 帳號...',
                    facebook: '正在連接 Facebook 帳號...',
                    instagram: '正在連接 Instagram 帳號...',
                    whatsapp: '正在連接 WhatsApp 帳號...'
                };
                
                // 顯示載入狀態
                const modal = document.getElementById('addAccountModal');
                modal.querySelector('.modal-body').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <h6>${loadingText[platform]}</h6>
                        <p class="text-muted">請在彈出的視窗中完成授權</p>
                            </div>
                `;
                
                // 模擬連接成功
                setTimeout(() => {
                    modal.querySelector('.modal-body').innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h6>連接成功！</h6>
                            <p class="text-muted">${platform} 帳號已成功連接</p>
                            <button class="btn btn-primary" onclick="closeAddAccountModal()">完成</button>
                        </div>
                    `;
                    
                    // 更新已連接帳號列表
                    updateConnectedAccounts(platform);
                }, 2000);
            }
            
            // 關閉新增帳號模態框
            function closeAddAccountModal() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('addAccountModal'));
                modal.hide();
            }
            
            // 更新已連接帳號列表
            function updateConnectedAccounts(platform) {
                const accountsContainer = document.getElementById('connectedAccounts');
                const platformInfo = {
                    line: { name: 'LINE 官方帳號', icon: 'fab fa-line', color: 'text-success' },
                    facebook: { name: 'Facebook 粉絲專頁', icon: 'fab fa-facebook', color: 'text-primary' },
                    instagram: { name: 'Instagram 商業帳號', icon: 'fab fa-instagram', color: 'text-danger' },
                    whatsapp: { name: 'WhatsApp Business', icon: 'fab fa-whatsapp', color: 'text-success' }
                };
                
                const info = platformInfo[platform];
                const accountHTML = `
                    <div class="connected-account-item mb-3 p-3 border rounded-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="${info.icon} ${info.color} fa-2x me-3"></i>
                                <div>
                                    <h6 class="mb-1">${info.name}</h6>
                                    <small class="text-muted">已連接</small>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editAccount('${platform}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="disconnectAccount('${platform}')">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            </div>
                            </div>
                        </div>
                    `;
                    
                // 如果是第一個帳號，清空預設內容
                if (accountsContainer.querySelector('.text-center')) {
                    accountsContainer.innerHTML = '';
                }
                
                accountsContainer.insertAdjacentHTML('beforeend', accountHTML);
            }
            
            // 編輯帳號
            function editAccount(platform) {
                console.log('編輯帳號:', platform);
                alert('編輯功能開發中...');
            }
            
            // 斷開連接
            function disconnectAccount(platform) {
                if (confirm('確定要斷開此帳號的連接嗎？')) {
                    console.log('斷開連接:', platform);
                    // 移除對應的帳號項目
                    const accountItems = document.querySelectorAll('.connected-account-item');
                    accountItems.forEach(item => {
                        if (item.textContent.includes(platform)) {
                            item.remove();
                        }
                    });
                    
                    // 如果沒有帳號了，顯示預設內容
                    const accountsContainer = document.getElementById('connectedAccounts');
                    if (accountsContainer.children.length === 0) {
                        accountsContainer.innerHTML = `
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-user-plus fa-2x mb-2"></i>
                                <p class="mb-0">尚未連接任何客服帳號</p>
                                <small>點擊「新增帳號」開始連接</small>
                            </div>
                        `;
                    }
                }
            }
            
            // 顯示模板模態框
            function showTemplateModal() {
                const modal = `
                    <div class="modal fade" id="templateModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增快速回覆模板</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="templateForm">
                                        <div class="mb-3">
                                            <label class="form-label">模板名稱</label>
                                            <input type="text" class="form-control" id="templateName" placeholder="例如：歡迎問候">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">回覆內容</label>
                                            <textarea class="form-control" id="templateContent" rows="4" placeholder="輸入回覆內容..."></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">儲存模板</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除舊的模態框
                const oldModal = document.getElementById('templateModal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // 顯示模態框
                const modalInstance = new bootstrap.Modal(document.getElementById('templateModal'));
                modalInstance.show();
            }
            
            // 儲存模板
            function saveTemplate() {
                const name = document.getElementById('templateName').value;
                const content = document.getElementById('templateContent').value;
                
                if (!name || !content) {
                    alert('請填寫完整的模板資訊');
                    return;
                }
                
                console.log('儲存模板:', { name, content });
                
                // 關閉模態框
                const modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
                modal.hide();
                
                alert('模板儲存成功！');
            }
            
            // 帳戶資訊模態框
            function showAccountInfoModal() {
                const modal = `
                <div class="modal fade" id="accountInfoModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-user me-2"></i>帳戶資訊</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="accountInfoForm" class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">帳號</label>
                                        <input type="text" class="form-control" id="accountUsername" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">角色</label>
                                        <input type="text" class="form-control" id="accountRole" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">顯示名稱</label>
                                        <input type="text" class="form-control" id="accountName" placeholder="請輸入顯示名稱">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="accountEmail" placeholder="請輸入 Email">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveAccountInfo()">儲存</button>
                            </div>
                        </div>
                    </div>
                </div>`;

                const existingModal = document.getElementById('accountInfoModal');
                if (existingModal) {
                    existingModal.remove();
                }

                document.body.insertAdjacentHTML('beforeend', modal);

                const modalInstance = new bootstrap.Modal(document.getElementById('accountInfoModal'));
                modalInstance.show();

                loadAccountInfo();
            }

            // 更改密碼模態框
            function showChangePasswordModal() {
                const modal = `
                <div class="modal fade" id="changePasswordModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-key me-2"></i>更改密碼</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="changePasswordForm" class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">目前密碼</label>
                                        <input type="password" class="form-control" id="currentPassword" autocomplete="current-password">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">新密碼</label>
                                        <input type="password" class="form-control" id="newPassword" autocomplete="new-password">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">確認新密碼</label>
                                        <input type="password" class="form-control" id="confirmNewPassword" autocomplete="new-password">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Email 驗證碼</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="changePasswordCode" placeholder="輸入驗證碼">
                                            <button class="btn btn-outline-primary" type="button" onclick="requestChangePasswordCode()">寄送驗證碼</button>
                                        </div>
                                        <small class="text-muted">驗證碼有效 10 分鐘</small>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveNewPassword()">更新密碼</button>
                            </div>
                        </div>
                    </div>
                </div>`;

                const existingModal = document.getElementById('changePasswordModal');
                if (existingModal) {
                    existingModal.remove();
                }

                document.body.insertAdjacentHTML('beforeend', modal);

                const modalInstance = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                modalInstance.show();
            }

            // 安全性設定模態框
            function showSecuritySettingsModal() {
                const modal = `
                <div class="modal fade" id="securitySettingsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-shield-alt me-2"></i>安全性設定</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <h6>登入安全</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                                        <label class="form-check-label" for="twoFactorAuth">
                                            啟用兩步驟驗證
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="loginNotifications">
                                        <label class="form-check-label" for="loginNotifications">
                                            登入通知
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6>會話管理</h6>
                                    <div class="mb-3">
                                        <label class="form-label">自動登出時間</label>
                                        <div class="form-control-plaintext">固定 15 分鐘</div>
                                        <small class="text-muted">系統固定 15 分鐘未操作即自動登出。</small>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">儲存設定</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                // 移除現有的模態框
                const existingModal = document.getElementById('securitySettingsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // 顯示模態框
                const modalInstance = new bootstrap.Modal(document.getElementById('securitySettingsModal'));
                modalInstance.show();
            }
            
            // 通知設定模態框
            function showNotificationSettingsModal() {
                const modal = `
                <div class="modal fade" id="notificationSettingsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-bell me-2"></i>通知設定</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <h6>電子郵件通知</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                        <label class="form-check-label" for="emailNotifications">
                                            接收電子郵件通知
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="weeklyReports">
                                        <label class="form-check-label" for="weeklyReports">
                                            每週報告
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="systemAlerts">
                                        <label class="form-check-label" for="systemAlerts">
                                            系統警報
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6>應用程式通知</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="appNotifications" checked>
                                        <label class="form-check-label" for="appNotifications">
                                            應用程式內通知
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="newMessageAlerts">
                                        <label class="form-check-label" for="newMessageAlerts">
                                            新訊息提醒
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="errorAlerts">
                                        <label class="form-check-label" for="errorAlerts">
                                            錯誤警報
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6>通知頻率</h6>
                                    <div class="mb-3">
                                        <label class="form-label">即時通知</label>
                                        <select class="form-select" id="notificationFrequency">
                                            <option value="immediate">即時</option>
                                            <option value="hourly">每小時</option>
                                            <option value="daily">每日</option>
                                            <option value="weekly">每週</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">儲存設定</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                // 移除現有的模態框
                const existingModal = document.getElementById('notificationSettingsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // 顯示模態框
                const modalInstance = new bootstrap.Modal(document.getElementById('notificationSettingsModal'));
                modalInstance.show();
            }
            
            // 刪除帳戶模態框
            function showDeleteAccountModal() {
                const modal = `
                <div class="modal fade" id="deleteAccountModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>刪除帳戶</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-danger">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>警告</h6>
                                    <p class="mb-0">此操作將永久刪除您的帳戶和所有相關數據，此操作無法撤銷。</p>
                                </div>
                                <form id="deleteAccountForm">
                                    <div class="mb-3">
                                        <label class="form-label">請輸入您的密碼以確認</label>
                                        <input type="password" class="form-control" id="deleteConfirmPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                                            <label class="form-check-label" for="confirmDelete">
                                                我了解此操作將永久刪除我的帳戶和所有數據
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">永久刪除帳戶</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                // 移除現有的模態框
                const existingModal = document.getElementById('deleteAccountModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新的模態框
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // 顯示模態框
                const modalInstance = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
                modalInstance.show();
            }
            
            // ==================== 設定功能處理函數 ====================
            // 方案管理：顯示與升級
            function showPlanManagementModal() {
                const modalHtml = `
                <div class="modal fade" id="planManagementModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-crown me-2 text-warning"></i>方案管理</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">目前方案</label>
                                    <input type="text" id="currentPlanField" class="form-control" disabled value="讀取中...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Token 狀態</label>
                                    <div class="list-group small">
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>本月額度</span>
                                            <span id="tokenAllowanceTxt" class="fw-bold">-</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>已用</span>
                                            <span id="tokenUsedTxt" class="fw-bold">-</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>儲值餘額</span>
                                            <span id="tokenBonusTxt" class="fw-bold">-</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>下次重置</span>
                                            <span id="tokenNextResetTxt" class="fw-bold">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">顯示選項</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="optShowSidebarTokens">
                                        <label class="form-check-label" for="optShowSidebarTokens">在側邊欄顯示 Token 總覽</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="optLowBalanceReminder">
                                        <label class="form-check-label" for="optLowBalanceReminder">餘額過低時提醒</label>
                                    </div>
                                </div>
                                <div class="mb-2">升級為尊榮版可解鎖更高額度與功能</div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                <button type="button" class="btn btn-warning" id="upgradeBtn"><i class="fas fa-arrow-up me-1"></i>升級尊榮版</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                const existing = document.getElementById('planManagementModal');
                if (existing) existing.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = new bootstrap.Modal(document.getElementById('planManagementModal'));
                modal.show();

                // 載入目前方案與 Token 狀態
                (async () => {
                    try {
                        const token = localStorage.getItem('token');
                        const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                        const [meRes, cfgRes] = await Promise.all([
                            fetch(`${baseUrl}/me`, { headers: { 'Authorization': `Bearer ${token}` }}),
                            fetch(`${baseUrl}/ai-assistant-config`, { headers: { 'Authorization': `Bearer ${token}` }})
                        ]);
                        const data = await meRes.json();
                        const plan = (data && data.user && data.user.plan) ? data.user.plan : 'free';
                        document.getElementById('currentPlanField').value = plan === 'enterprise' ? '企業版' : (plan === 'premium' ? '尊榮版' : '免費版');

                        const cfg = await cfgRes.json();
                        const t = cfg && cfg.token ? cfg.token : null;
                        if (t) {
                            const allowance = (t.allowance || 0).toLocaleString();
                            const used = (t.used_in_cycle || 0).toLocaleString();
                            const bonus = (t.bonus_balance || 0).toLocaleString();
                            const next = t.next_billing_at ? new Date(t.next_billing_at).toLocaleString() : '-';
                            document.getElementById('tokenAllowanceTxt').textContent = allowance;
                            document.getElementById('tokenUsedTxt').textContent = used;
                            document.getElementById('tokenBonusTxt').textContent = bonus;
                            document.getElementById('tokenNextResetTxt').textContent = next;
                        }

                        // 偏好設置
                        const showSidebar = localStorage.getItem('optShowSidebarTokens') === '1';
                        const lowReminder = localStorage.getItem('optLowBalanceReminder') === '1';
                        const chkSidebar = document.getElementById('optShowSidebarTokens');
                        const chkLow = document.getElementById('optLowBalanceReminder');
                        if (chkSidebar) chkSidebar.checked = showSidebar;
                        if (chkLow) chkLow.checked = lowReminder;
                    } catch (e) {
                        document.getElementById('currentPlanField').value = '讀取失敗';
                    }
                })();

                // 綁定升級按鈕（導向綠界付款）
                document.getElementById('upgradeBtn').addEventListener('click', async () => {
                    try {
                        const token = localStorage.getItem('token');
                        const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                        const resp = await fetch(`${baseUrl}/upgrade`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const result = await resp.json();
                        if (resp.ok && result.success && result.action && result.params) {
                            // 產生自動送出的表單，導向綠界收銀台
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = result.action;
                            Object.entries(result.params).forEach(([k, v]) => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = k;
                                input.value = v;
                                form.appendChild(input);
                            });
                            document.body.appendChild(form);
                            form.submit();
                        } else {
                            showAlert(result.error || '建立訂單失敗', 'danger');
                        }
                    } catch (err) {
                        showAlert('建立訂單失敗，請稍後再試', 'danger');
                    }
                });

                // 存儲顯示偏好
                document.getElementById('planManagementModal').addEventListener('change', (e) => {
                    if (e.target && e.target.id === 'optShowSidebarTokens') {
                        localStorage.setItem('optShowSidebarTokens', e.target.checked ? '1' : '0');
                        renderSidebarTokenLine();
                    }
                    if (e.target && e.target.id === 'optLowBalanceReminder') {
                        localStorage.setItem('optLowBalanceReminder', e.target.checked ? '1' : '0');
                    }
                });
            }

            // 在側邊欄顯示 Token 總覽（依偏好）
            async function renderSidebarTokenLine() {
                try {
                    const planLine = document.getElementById('planLine');
                    if (!planLine) return;
                    const show = localStorage.getItem('optShowSidebarTokens') === '1';
                    if (!show) return; // 僅在開啟時顯示
                    const token = localStorage.getItem('token');
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const res = await fetch(`${baseUrl}/ai-assistant-config`, { headers: { 'Authorization': `Bearer ${token}` }});
                    const data = await res.json();
                    const t = data && data.token ? data.token : null;
                    if (!t) return;
                    const allowance = t.allowance || 0;
                    const used = t.used_in_cycle || 0;
                    if (!planLine.dataset.baseText) planLine.dataset.baseText = planLine.textContent;
                    planLine.textContent = `${planLine.dataset.baseText} ｜ Tokens：${used.toLocaleString()} / ${allowance.toLocaleString()}`;
                } catch (e) {
                    // 靜默
                }
            }
            // 將函式暴露為全域，確保 inline onclick 可呼叫
            window.showPlanManagementModal = showPlanManagementModal;
            window.showAccountInfoModal = showAccountInfoModal;
            window.showChangePasswordModal = showChangePasswordModal;
            window.showSecuritySettingsModal = showSecuritySettingsModal;
            window.showNotificationSettingsModal = showNotificationSettingsModal;
            window.showDeleteAccountModal = showDeleteAccountModal;
            
            // 載入帳戶資訊
            async function loadAccountInfo() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        console.log('未找到認證令牌，無法載入帳戶資訊');
                        return;
                    }
                    
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api'))
                        ? window.API_BASE_URL
                        : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(`${apiBase}/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const user = data.user || data.profile || {};
                        const usernameEl = document.getElementById('accountUsername');
                        const roleEl = document.getElementById('accountRole');
                        const nameEl = document.getElementById('accountName');
                        const emailEl = document.getElementById('accountEmail');
                        if (usernameEl) usernameEl.value = user.username || '';
                        if (roleEl) roleEl.value = user.role || '';
                        if (nameEl) nameEl.value = user.name || '';
                        if (emailEl) emailEl.value = user.email || '';

                        // 側欄問候與方案顯示
                        const greet = document.getElementById('greetingLine');
                        const planLine = document.getElementById('planLine');
                        if (greet) {
                            greet.textContent = `${user.name || user.username} 您好！`;
                        }
                        if (planLine) {
                            const plan = (user.plan || 'free');
                            const planName = plan === 'enterprise' ? '企業版' : (plan === 'premium' ? '尊榮版' : '免費版');
                            if (plan === 'free') {
                                planLine.textContent = `方案：${planName}`;
                            } else {
                                const exp = user.plan_expires_at ? new Date(user.plan_expires_at) : null;
                                const expText = exp ? `，到期：${exp.toLocaleDateString('zh-TW')}` : '';
                                planLine.textContent = `方案：${planName}${expText}`;
                            }
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showAlert('認證令牌已過期，請重新登入', 'warning');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('載入帳戶資訊失敗:', error);
                    showAlert('載入帳戶資訊失敗', 'danger');
                }
            }
            
            // 儲存帳戶資訊
            async function saveAccountInfo() {
                const name = document.getElementById('accountName').value;
                const email = document.getElementById('accountEmail').value;
                
                if (!name) {
                    showAlert('請輸入顯示名稱', 'warning');
                    return;
                }
                
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api'))
                        ? window.API_BASE_URL
                        : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(`${apiBase}/profile`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, email })
                    });
                    
                    if (response.ok) {
                        showAlert('帳戶資訊已更新', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('accountInfoModal')).hide();
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showAlert('認證令牌已過期，請重新登入', 'warning');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        const error = await response.json();
                        showAlert(error.error || '更新失敗', 'danger');
                    }
                } catch (error) {
                    console.error('更新帳戶資訊失敗:', error);
                    showAlert('更新帳戶資訊失敗', 'danger');
                }
            }
            
            // 儲存新密碼
            async function saveNewPassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    showAlert('請填寫所有欄位', 'warning');
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showAlert('新密碼與確認密碼不符', 'warning');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showAlert('新密碼長度至少需要6個字元', 'warning');
                    return;
                }
                
                const code = document.getElementById('changePasswordCode')?.value.trim() || '';

                if (!code) {
                    showAlert('請輸入驗證碼', 'warning');
                    return;
                }
                
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api'))
                        ? window.API_BASE_URL
                        : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(`${apiBase}/change-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ oldPassword: currentPassword, newPassword, code })
                    });
                    
                    if (response.ok) {
                        showAlert('密碼已成功修改', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                        document.getElementById('changePasswordForm').reset();
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showAlert('認證令牌已過期，請重新登入', 'warning');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        const error = await response.json();
                        showAlert(error.error || '修改密碼失敗', 'danger');
                    }
                } catch (error) {
                    console.error('修改密碼失敗:', error);
                    showAlert('修改密碼失敗', 'danger');
                }
            }

            async function requestChangePasswordCode() {
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }

                    const apiBase = (window.API_BASE_URL && window.API_BASE_URL.endsWith('/api'))
                        ? window.API_BASE_URL
                        : (window.API_BASE_URL || 'https://echochat-api.onrender.com/api');
                    const response = await fetch(`${apiBase}/change-password/request-code`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showAlert('驗證碼已寄送到您的電子郵件', 'success');
                    } else {
                        showAlert(result.error || '發送驗證碼失敗', 'danger');
                    }
                } catch (error) {
                    console.error('發送驗證碼失敗:', error);
                    showAlert('發送驗證碼失敗', 'danger');
                }
            }
            
            // 儲存安全性設定
            function saveSecuritySettings() {
                const twoFactorAuth = document.getElementById('twoFactorAuth').checked;
                const loginNotifications = document.getElementById('loginNotifications').checked;
                // 這裡可以添加保存安全性設定的邏輯
                showAlert('安全性設定已儲存', 'success');
                bootstrap.Modal.getInstance(document.getElementById('securitySettingsModal')).hide();
            }
            
            // 儲存通知設定
            function saveNotificationSettings() {
                const emailNotifications = document.getElementById('emailNotifications').checked;
                const weeklyReports = document.getElementById('weeklyReports').checked;
                const systemAlerts = document.getElementById('systemAlerts').checked;
                const appNotifications = document.getElementById('appNotifications').checked;
                const newMessageAlerts = document.getElementById('newMessageAlerts').checked;
                const errorAlerts = document.getElementById('errorAlerts').checked;
                const notificationFrequency = document.getElementById('notificationFrequency').value;
                
                // 這裡可以添加保存通知設定的邏輯
                showAlert('通知設定已儲存', 'success');
                bootstrap.Modal.getInstance(document.getElementById('notificationSettingsModal')).hide();
            }
            
            // 確認刪除帳戶
            async function confirmDeleteAccount() {
                const password = document.getElementById('deleteConfirmPassword').value;
                const confirmDelete = document.getElementById('confirmDelete').checked;
                
                if (!password) {
                    showAlert('請輸入密碼', 'warning');
                    return;
                }
                
                if (!confirmDelete) {
                    showAlert('請確認您了解刪除帳戶的後果', 'warning');
                    return;
                }
                
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        showAlert('請先登入', 'warning');
                        return;
                    }
                    
                    const response = await fetch('/api/delete-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ password })
                    });
                    
                    if (response.ok) {
                        showAlert('帳戶已刪除，即將登出', 'success');
                        setTimeout(() => {
                            localStorage.removeItem('token');
                            localStorage.removeItem('authToken');
                            console.log('⚠️ 跳轉到登入頁面已禁用');
                        }, 2000);
                    } else if (response.status === 401 || response.status === 403) {
                        console.log('❌ 認證令牌無效，清除本地儲存的令牌');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        showAlert('認證令牌已過期，請重新登入', 'warning');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                    } else {
                        const error = await response.json();
                        showAlert(error.error || '刪除帳戶失敗', 'danger');
                    }
                } catch (error) {
                    console.error('刪除帳戶失敗:', error);
                    showAlert('刪除帳戶失敗', 'danger');
                }
            }
            
            // 重新整理對話列表
            function refreshConversations() {
                console.log('重新整理對話列表');
                // 這裡可以添加重新載入對話資料的邏輯
                showAlert('對話列表已重新整理', 'success');
            }
            
            // ===== 知識庫：載入/渲染/新增/編輯/刪除 =====
            let knowledgeItemsCache = [];
            
            // 分類英文轉中文對應表
            function getCategoryDisplayName(category) {
                const categoryMap = {
                    'general': '一般',
                    'manual': '手動',
                    'upload': '上傳',
                    'webpage': '網頁',
                    'faq': '常見問題',
                    'policy': '政策',
                    'guide': '使用指南',
                    'payment': '付款',
                    'order': '訂單',
                    'shipping': '運送',
                    'support': '客服支援',
                    'warranty': '保固',
                    'repair': '維修',
                    'return': '退換貨',
                    'booking': '預約',
                    'cancel': '取消',
                    'timing': '時間安排',
                    'pricing': '價格',
                    'features': '產品特色',
                    'specs': '規格',
                    'usage': '使用方法',
                    'target': '適用對象',
                    'join': '加入會員',
                    'benefits': '會員福利',
                    'points': '點數',
                    'level': '會員等級',
                    'survey': '調查'
                };
                return categoryMap[category] || category;
            }
            
            // 標籤英文轉中文對應表
            function getTagsDisplayName(tags) {
                if (!tags) return '';
                const tagMap = {
                    'template:customer-service': '客服模板',
                    'template:user-examples': '使用者範例',
                    'template:shopping-process': '購物流程',
                    'template:after-sales': '售後服務',
                    'template:appointment-faq': '預約服務',
                    'template:product-info': '產品資訊',
                    'template:membership-benefits': '會員福利',
                    'template:survey': '滿意度調查',
                    'template:appointment': '預約助理',
                    'template:sales-assistant': '銷售助理'
                };
                return tagMap[tags] || tags;
            }

            async function loadKnowledgeData() {
                const list = document.getElementById('knowledgeList');
                if (!list) return;
                list.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                            <p class="mt-3 text-muted">正在載入知識庫資料...</p>
                        </div>
                    </div>`;
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) {
                        list.innerHTML = '<div class="col-12 text-center text-muted py-5">請先登入</div>';
                        return;
                    }
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/knowledge`, { headers: { 'Authorization': `Bearer ${token}` }});
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data && data.error || '載入失敗');
                    knowledgeItemsCache = Array.isArray(data) ? data : [];
                    renderKnowledgeList(knowledgeItemsCache);
                } catch (e) {
                    list.innerHTML = `<div class="col-12 text-center text-danger py-5">載入失敗：${(e && e.message) || e || ''}</div>`;
                }
            }

            function renderKnowledgeList(items) {
                const list = document.getElementById('knowledgeList');
                if (!list) return;
                if (!items || !items.length) {
                    list.innerHTML = '<div class="col-12 text-center text-muted py-5">目前沒有資料，點右上「新增知識」建立第一筆</div>';
                    return;
                }
                const escapeHtml = (s) => String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
                const truncate = (s, n=140) => (s && s.length>n) ? s.slice(0,n) + '...' : (s||'');
                list.innerHTML = items.map(it => `
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm position-relative h-100">
                            <div class="position-absolute" style="top:12px; left:12px; z-index:2;">
                                <input class="form-check-input knowledge-select" type="checkbox" ${selectedKnowledgeIds.has(it.id) ? 'checked' : ''} onchange="onKnowledgeSelectChange(${it.id}, this.checked)">
                            </div>
                            <div class="dropdown position-absolute" style="top:10px; right:10px;">
                                <button class="btn btn-light btn-sm" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="showEditKnowledgeModal(${it.id}); return false;">編輯</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteKnowledge(${it.id}); return false;">刪除</a></li>
                                </ul>
                            </div>
                            <div class="card-body" style="padding-left: 44px;">
                                <h6 class="card-title mb-2">${escapeHtml(it.question)}</h6>
                                <p class="text-muted small mb-3">${escapeHtml(truncate(it.answer))}</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-light text-dark">${escapeHtml(getCategoryDisplayName(it.category) || '一般')}</span>
                                    ${it.tags ? `<span class="badge bg-secondary">${escapeHtml(getTagsDisplayName(it.tags))}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                // 更新全選狀態與按鈕
                updateKnowledgeBulkControls();
            }

            function showAddKnowledgeModal() {
                const title = document.getElementById('knowledgeEditModalLabel');
                const idEl = document.getElementById('knowledgeId');
                const q = document.getElementById('knowledgeQuestion');
                const a = document.getElementById('knowledgeAnswer');
                const c = document.getElementById('knowledgeCategory');
                const t = document.getElementById('knowledgeTags');
                if (title) title.textContent = '新增知識';
                if (idEl) idEl.value = '';
                if (q) q.value = '';
                if (a) a.value = '';
                if (c) c.value = 'manual';
                if (t) t.value = '';
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('knowledgeEditModal'));
                modal.show();
            }

            function showManualInputModal() { showAddKnowledgeModal(); }

            // 批次選取/刪除
            const selectedKnowledgeIds = new Set();

            function onKnowledgeSelectChange(id, checked) {
                if (checked) selectedKnowledgeIds.add(id); else selectedKnowledgeIds.delete(id);
                updateKnowledgeBulkControls();
            }

            function updateKnowledgeBulkControls() {
                const btn = document.getElementById('knowledgeBulkDeleteBtn');
                if (btn) btn.disabled = selectedKnowledgeIds.size === 0;
                const selectAll = document.getElementById('knowledgeSelectAll');
                const checkboxes = document.querySelectorAll('#knowledgeList input.knowledge-select');
                if (selectAll && checkboxes.length) {
                    const checkedCount = Array.from(checkboxes).filter(c => c.checked).length;
                    selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
                    selectAll.checked = checkedCount > 0 && checkedCount === checkboxes.length;
                }
            }

            function toggleSelectAllKnowledge(checked) {
                const checkboxes = document.querySelectorAll('#knowledgeList input.knowledge-select');
                checkboxes.forEach(c => { c.checked = checked; const id = parseInt(c.getAttribute('onchange').match(/\((\d+),/)[1]); if (checked) selectedKnowledgeIds.add(id); else selectedKnowledgeIds.clear(); });
                if (!checked) selectedKnowledgeIds.clear();
                updateKnowledgeBulkControls();
            }

            async function deleteSelectedKnowledge() {
                if (selectedKnowledgeIds.size === 0) return;
                if (!confirm(`確定刪除已選 ${selectedKnowledgeIds.size} 筆項目？`)) return;
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) { showAlert('請先登入', 'warning'); return; }
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const ids = Array.from(selectedKnowledgeIds).map(x=>parseInt(x));
                    // 使用後端批次刪除 API
                    const resp = await fetch(`${baseUrl}/knowledge/bulk-delete`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids })
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data && data.error || '批次刪除失敗');
                    showAlert(`已刪除 ${data.deleted || 0} 筆`, 'success');
                    selectedKnowledgeIds.clear();
                    loadKnowledgeData();
                } catch (e) {
                    showAlert('批次刪除失敗', 'danger');
                }
            }

            function showEditKnowledgeModal(id) {
                const item = (knowledgeItemsCache || []).find(x => x.id === id);
                if (!item) { showAlert('找不到此項目', 'warning'); return; }
                const title = document.getElementById('knowledgeEditModalLabel');
                const idEl = document.getElementById('knowledgeId');
                const q = document.getElementById('knowledgeQuestion');
                const a = document.getElementById('knowledgeAnswer');
                const c = document.getElementById('knowledgeCategory');
                const t = document.getElementById('knowledgeTags');
                if (title) title.textContent = '編輯知識';
                if (idEl) idEl.value = String(item.id);
                if (q) q.value = item.question || '';
                if (a) a.value = item.answer || '';
                                    if (c) c.value = item.category || '手動';
                if (t) t.value = item.tags || '';
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('knowledgeEditModal'));
                modal.show();
            }

            async function submitKnowledgeModal() {
                try {
                    const id = document.getElementById('knowledgeId')?.value || '';
                    const question = document.getElementById('knowledgeQuestion')?.value?.trim();
                    const answer = document.getElementById('knowledgeAnswer')?.value?.trim();
                    const category = document.getElementById('knowledgeCategory')?.value || '手動';
                    const tags = document.getElementById('knowledgeTags')?.value || '';
                    if (!question || !answer) { showAlert('請填寫完整問題與答案', 'warning'); return; }
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) { showAlert('請先登入', 'warning'); return; }
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const isUpdate = Boolean(id);
                    const url = isUpdate ? `${baseUrl}/knowledge/${id}` : `${baseUrl}/knowledge`;
                    const method = isUpdate ? 'PUT' : 'POST';
                    const resp = await fetch(url, {
                        method,
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question, answer, category, tags })
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data && data.error || '儲存失敗');
                    showAlert(isUpdate ? '已更新' : '已新增', 'success');
                    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('knowledgeEditModal'));
                    modal.hide();
                    loadKnowledgeData();
                } catch (e) {
                    showAlert(`儲存失敗：${(e && e.message) || e || ''}`,'danger');
                }
            }

            async function deleteKnowledge(id) {
                if (!confirm('確定要刪除此知識庫項目嗎？')) return;
                try {
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (!token) { showAlert('請先登入', 'warning'); return; }
                    const baseUrl = window.API_BASE_URL || 'https://echochat-api.onrender.com/api';
                    const resp = await fetch(`${baseUrl}/knowledge/${id}`, { method:'DELETE', headers:{ 'Authorization': `Bearer ${token}` }});
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data && data.error || '刪除失敗');
                    showAlert('已刪除', 'success');
                    loadKnowledgeData();
                } catch (e) {
                    showAlert(`刪除失敗：${(e && e.message) || e || ''}`, 'danger');
                }
            }

            // ===== 其他（既有） =====
            // 顯示新增對話模態框
            function showNewConversationModal() {
                console.log('顯示新增對話模態框');
                // 這裡可以添加顯示新增對話模態框的邏輯
                showAlert('新增對話功能開發中', 'info');
            }
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const body = document.body;
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                const toggleBtn = document.getElementById('mobileNavToggle');
                const navLinks = document.querySelectorAll('.sidebar .nav-link');

                if (!sidebar || !toggleBtn) return;

                function openSidebar() {
                    body.classList.add('sidebar-open');
                    overlay && overlay.classList.add('show');
                }

                function closeSidebar() {
                    body.classList.remove('sidebar-open');
                    overlay && overlay.classList.remove('show');
                }

                toggleBtn.addEventListener('click', function() {
                    if (body.classList.contains('sidebar-open')) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                });

                overlay && overlay.addEventListener('click', closeSidebar);

                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth <= 991) {
                            closeSidebar();
                        }
                    });
                });

                window.addEventListener('resize', () => {
                    if (window.innerWidth >= 992) {
                        closeSidebar();
                    }
                });
            });
        </script>
        <!-- 對話設定彈窗（放在 body 底部，避免被容器裁切） -->
        <div class="modal fade" id="autoReplySettingsModal" tabindex="-1" aria-labelledby="autoReplySettingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="autoReplySettingsModalLabel">
                            <i class="fas fa-sliders-h me-2"></i>對話設定
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">自動回覆</h6>
                                <p class="text-muted small mb-0">控制此對話是否自動回覆客戶訊息。</p>
                            </div>
                            <span id="autoReplyStatusText" class="badge bg-success">自動回覆中</span>
                        </div>
                        <hr class="my-3">
                        <div class="small text-muted">
                            <i class="fas fa-info-circle me-1"></i>開啟自動回覆時將停用手動輸入。
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>